<!DOCTYPE html>
<html lang="zh">
<head>
    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#fff3f8">
    <!-- iOS ä¸“ç”¨é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/logo.png">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°å¿†æ ¸å¿ƒ | Memory Core</title>
    <style>
        /* --- å…¨å±€åŸºç¡€ --- */
        * { box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢å†…è¾¹è·æ’‘ç ´å®¹å™¨ */ }

        body {
            font-family: "Segoe UI", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #fff3f8 0%, #ffe9e1 100%);
            margin: 0; padding: 15px; color: #444; min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 80px;}

        /* å¤´éƒ¨ */
        .header {
            display: flex; align-items: center; margin-bottom: 20px;
            background: rgba(255,255,255,0.6); backdrop-filter: blur(10px);
            padding: 12px 20px; border-radius: 16px; border: 1px solid #ffe5e8;
        }
        .back-btn { font-size: 24px; margin-right: 15px; cursor: pointer; color: #ffb6b9; }
        h1 { margin: 0; font-size: 16px; color: #333; flex: 1; text-align: center; margin-right: 24px;}

        /* æ¨¡å—é€šç”¨ */
        .section-title { font-size: 13px; color: #aaa; margin: 25px 0 10px 5px; font-weight: bold; text-transform: uppercase; }

        details {
            background: #fff; border-radius: 12px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #fff0f2;
            overflow: hidden;
        }
        summary {
            padding: 15px; cursor: pointer; font-weight: 600; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.5); font-size: 14px;
        }
        summary::-webkit-details-marker { display: none; }

        /* æ“ä½œæ  */
        .action-bar {
            padding: 10px 15px; background: #fffcfc; border-bottom: 1px solid #eee;
            display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap;
        }
        .btn {
            padding: 6px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; font-weight: bold; flex-shrink: 0;
        }
        .btn-edit { background: #e3f2fd; color: #1565c0; }
        .btn-save { background: #e8f5e9; color: #2e7d32; display: none; }
        .btn-cancel { background: #ffebee; color: #c62828; display: none; }

        /* å†…å®¹åŒº */
        .content-box { padding: 0; background: #fafafa; }
        .empty-state { padding: 20px; text-align: center; color: #bbb; font-style: italic; font-size: 13px; }

        /* ------------------- å±•ç¤ºæ¨¡å¼ (View Mode) ------------------- */
        .view-mode .mem-item { padding: 12px 16px; border-bottom: 1px solid #eee; }
        .view-mode .mem-header { font-size: 12px; color: #ffb6b9; font-weight: bold; margin-bottom: 6px; word-break: break-all;}
        .view-mode .mem-text { font-size: 14px; white-space: pre-wrap; color: #555; line-height: 1.6; word-break: break-word;}
        .view-mode .time-capsule { display: flex; gap: 10px; padding: 6px 0; font-size: 14px; align-items: flex-start;}
        .view-mode .time-tag { background: #e3f2fd; color: #1565c0; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-family: monospace; white-space: nowrap; margin-top: 2px;}

        /* ------------------- ç¼–è¾‘æ¨¡å¼ (Edit Mode) ------------------- */
        .edit-mode { padding: 15px; display: none; background: #fff; }

        /* åˆ‡æ¢æ˜¾ç¤º */
        .editing .view-mode { display: none; }
        .editing .edit-mode { display: block; }
        .editing .btn-edit { display: none; }
        .editing .btn-save, .editing .btn-cancel { display: inline-block; }

        /* --- è¾“å…¥æ§ä»¶ç»„ (Desktop é»˜è®¤) --- */
        .input-group {
            display: flex; gap: 8px; margin-bottom: 12px;
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
            border-bottom: 1px dashed #f0f0f0; /* åˆ†éš”çº¿ */
            padding-bottom: 12px;
        }
        .input-group:last-child { border-bottom: none; }

        /* æ‰€æœ‰çš„è¾“å…¥æ¡† */
        input[type="text"], textarea {
            border: 1px solid #ddd; border-radius: 6px; padding: 10px;
            font-family: inherit; font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: #ffb6b9; outline: none; }

        /* 1. Key è¾“å…¥æ¡† (æ—¶é—´/æ—¥æœŸ/é”®å) */
        .input-key { width: 140px; flex-shrink: 0; background: #fff; font-weight: bold; color: #555; }

        /* 2. Value è¾“å…¥æ¡† (å†…å®¹) - è§£å†³â€œæ¡†å¤ªå°â€é—®é¢˜ */
        .input-val { flex: 1; min-width: 0; } /* min-width:0 é˜²æ­¢flexæº¢å‡º */
        textarea.input-val { min-height: 100px; resize: vertical; line-height: 1.5; }

        /* 3. Full è¾“å…¥æ¡† (å¤§æ®µæè¿°) */
        .input-full { width: 100%; min-height: 80px; margin-top: 6px; resize: vertical; }

        /* åˆ é™¤æŒ‰é’® */
        .btn-del {
            background: #ffebee; color: #c62828; width: 36px; height: 36px;
            border-radius: 6px; border: none; cursor: pointer; flex-shrink: 0;
            font-size: 18px; display: flex; align-items: center; justify-content: center;
        }

        /* æ·»åŠ æŒ‰é’® */
        .btn-add {
            width: 100%; padding: 12px; background: #f8f9fa; border: 2px dashed #ddd;
            color: #888; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: bold;
            transition: all 0.2s;
        }
        .btn-add:hover { border-color: #ffb6b9; color: #ffb6b9; background: #fff; }

        /* å…³ç³»ç¼–è¾‘å¡ç‰‡ */
        .rel-edit-card {
            border: 1px solid #eee; padding: 12px; border-radius: 8px;
            margin-bottom: 12px; background: #fafafa;
        }

        /* Markdown æ–‡æœ¬åŸŸ */
        .md-editor { width: 100%; min-height: 300px; padding: 12px; line-height: 1.6; font-family: monospace; }

        /* ================= ğŸ“± æ‰‹æœºç«¯é€‚é… (å…³é”®ï¼) ================= */
        @media (max-width: 600px) {
            body { padding: 10px; }

            /* 1. å¼ºåˆ¶çºµå‘æ’åˆ—ï¼šè§£å†³â€œé£å‡ºå»â€å’Œâ€œæ˜¾ç¤ºä¸å…¨â€ */
            .input-group {
                flex-direction: column; /* ä¸Šä¸‹æ’ */
                background: #fdfdfd;
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 10px;
                gap: 10px; /* æ§ä»¶é—´è·åŠ å¤§ */
            }

            /* 2. æ‰€æœ‰è¾“å…¥æ¡†å®½åº¦ 100% */
            .input-key, .input-val, .input-full {
                width: 100% !important; /* å¼ºåˆ¶å¡«æ»¡ */
                flex: none;
                max-width: 100%;
            }

            /* çŸ­æœŸè®°å¿†çš„æ—¶é—´æ¡†å¯ä»¥ç¨å¾®çŸ®ä¸€ç‚¹ */
            .input-key { background-color: #fff8f8; }

            /* 3. åˆ é™¤æŒ‰é’®å˜æˆåº•éƒ¨çš„å®½æ¡ï¼Œæ–¹ä¾¿æ‰‹æŒ‡ç‚¹ */
            .btn-del {
                width: 100%;
                height: 32px;
                margin-top: 5px;
                background-color: #fff0f0;
                border: 1px solid #ffcdd2;
            }
            .btn-del::after { content: ' åˆ é™¤ / Delete'; font-size: 12px; margin-left: 5px; }

            /* å…³ç³»å¡ç‰‡é‡Œçš„å¸ƒå±€è°ƒæ•´ */
            .rel-edit-card .input-group {
                border: none; padding: 0; background: transparent;
            }

            /* æ“ä½œæ æŒ‰é’® */
            .action-bar .btn { flex: 1; text-align: center; } /* æŒ‰é’®å‡åˆ†å®½åº¦ */
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="back-btn" onclick="window.location.href='/chat/' + charId">â†</div>
        <h1>è¨˜æ†¶ã®ä¿ç®¡åº« (Memory Archive)</h1>
    </div>

    <!-- ã€æ–°å¢ã€‘è§’è‰²æ¡£æ¡ˆç¼–è¾‘æ¨¡å— -->
    <div class="section-title">ğŸ­ è§’è‰²æ¡£æ¡ˆ (Character Profile)</div>

    <!-- ã€ä¿®æ­£ç‰ˆã€‘è§’è‰²æ¡£æ¡ˆæ¨¡å— -->
    <div class="module" id="module-meta">
        <!-- ã€ä¿®æ”¹ç‚¹ã€‘å»æ‰äº† open å±æ€§ï¼Œé»˜è®¤æ”¶èµ· -->
        <details>
            <summary>åŸºæœ¬ä¿¡æ¯ (Metadata)</summary>

            <!-- 1. æŸ¥çœ‹æ¨¡å¼ (View Mode) -->
            <div class="view-mode" id="meta-view-mode" style="padding: 20px; text-align: center;">
                <div style="position: relative; display: inline-block;">
                    <img id="view-avatar" src="" style="width:100px; height:100px; border-radius:15px; object-fit:cover; border: 3px solid #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                </div>
                <div id="view-remark" style="font-size:18px; font-weight:bold; margin-top:10px; color:#333;">(åŠ è½½ä¸­...)</div>
                <div style="font-size:12px; color:#ccc; margin-top:5px;">ID: <span id="view-id"></span></div>

                <div style="margin-top: 15px;">
                    <!-- ç‚¹å‡»è¿›å…¥ç¼–è¾‘æ¨¡å¼ -->
                    <button class="btn btn-edit" onclick="toggleMetaEdit(true)">ç¼–è¾‘èµ„æ–™ / Edit Profile</button>
                </div>
            </div>

            <!-- 2. ç¼–è¾‘æ¨¡å¼ (Edit Mode) - é»˜è®¤éšè— -->
            <div class="edit-mode" id="meta-edit-mode" style="padding: 20px; text-align: center; display: none; background: #fffcfc;">

                <!-- å¤´åƒä¸Šä¼  -->
                <div style="margin-bottom: 20px; position: relative; display: inline-block;">
                    <div style="font-size:12px; color:#ffb6b9; margin-bottom:8px; font-weight:bold;">ç‚¹å‡»æ›´æ¢å¤´åƒ / Tap to Upload</div>
                    <img id="edit-avatar-preview" src=""
                         onclick="document.getElementById('avatar-upload-input').click()"
                         style="width:100px; height:100px; border-radius:15px; object-fit:cover;
                      border: 3px solid #ffb6b9; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer;">
                    <input type="file" id="avatar-upload-input" accept="image/*" style="display: none;" onchange="uploadAvatar(this)">
                </div>

                <!-- å¤‡æ³¨åè¾“å…¥ -->
                <div style="margin-bottom:15px; text-align: left; max-width: 300px; margin: 0 auto;">
                    <div style="font-size:12px; font-weight:bold; color:#888; margin-bottom:4px;">å¤‡æ³¨å / Remark Name</div>
                    <input type="text" id="edit-remark-input" class="input-full" style="margin:0; text-align:center; font-size:16px; font-weight:bold;">
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <div class="action-bar" style="justify-content: center; background: transparent; border: none; padding-top: 10px;">
                    <!-- ã€å…³é”®ä¿®æ”¹ã€‘åŠ ä¸Š display: inline-block; å¼ºåˆ¶æ˜¾ç¤ºæŒ‰é’® -->
                    <button class="btn btn-cancel" onclick="toggleMetaEdit(false)" style="margin-right: 10px; display: inline-block;">å–æ¶ˆ / Cancel</button>
                    <button class="btn btn-save" onclick="saveMetaAndExit()" style="display: inline-block;">ä¿å­˜ / Save</button>
                </div> å¡«å†™çš„å†…å®¹ä¸ºï¼š
                1. è§’è‰² ID
                2. è§’è‰²å§“å
            </div>

        </details>
    </div>

    <!-- ================= åŠ¨æ€è®°å¿†åŒºåŸŸ ================= -->
    <div class="section-title">ğŸ§  åŠ¨æ€è®°å¿† (Dynamic Memory)</div>

    <!-- 1. çŸ­æœŸè®°å¿† (JSON, ä»…å±•ç¤ºæœ€è¿‘1å¤©, åˆ—è¡¨ç¼–è¾‘) -->
    <div id="module-short" class="module" data-type="short"></div>

    <!-- 2. ä¸­æœŸè®°å¿† (JSON, ä»…å±•ç¤ºæœ€è¿‘7å¤©, KVç¼–è¾‘) -->
    <div id="module-medium" class="module" data-type="medium"></div>

    <!-- 3. é•¿æœŸè®°å¿† (JSON, å…¨éƒ¨, KVç¼–è¾‘) -->
    <div id="module-long" class="module" data-type="long"></div>

    <!-- 4. æ—¥ç¨‹ (JSON, å…¨éƒ¨, KVç¼–è¾‘) -->
    <div id="module-schedule" class="module" data-type="schedule"></div>

    <!-- ================= æ ¸å¿ƒè®¾å®šåŒºåŸŸ ================= -->
    <div class="section-title">ğŸ§¬ æ ¸å¿ƒè®¾å®š (Core Prompts)</div>

    <!-- 5. å…³ç³» (JSON, å¤æ‚å¯¹è±¡ç¼–è¾‘) -->
    <div id="module-relation" class="module" data-type="relation"></div>

    <!-- 6. Markdown æ–‡æœ¬ç±» -->
    <div id="module-base" class="module" data-type="base"></div>
</div>

<!-- æ¨¡æ¿ï¼šæ¨¡å—å¤–å£³ -->
<template id="tpl-module">
    <details>
        <summary><span class="mod-title"></span></summary>
        <div class="action-bar">
            <button class="btn btn-edit" onclick="toggleEdit(this)">ç¼–è¾‘ / Edit</button>
            <button class="btn btn-cancel" onclick="cancelEdit(this)">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveData(this)">ä¿å­˜ / Save</button>
        </div>
        <div class="content-box">
            <!-- å±•ç¤ºæ¨¡å¼ -->
            <div class="view-mode"></div>
            <!-- ç¼–è¾‘æ¨¡å¼ -->
            <div class="edit-mode"></div>
        </div>
    </details>
</template>

<!-- ã€æ–°å¢ã€‘AIç”Ÿæˆ - è¾“å…¥å¼¹çª— -->
<div id="genInputModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:20px; border-radius:12px; width:80%; max-width:300px;">
        <h3 style="margin-top:0; color:#444;">AI è‡ªåŠ¨æ’°å†™äººè®¾</h3>
        <div style="margin-bottom:10px;">
            <label style="font-size:12px; color:#888;">è§’è‰²å (ä¾‹å¦‚: ç³¸å¸« å‡›)</label>
            <input type="text" id="gen-char-name" class="input-full" style="margin-top:4px;">
        </div>
        <div style="margin-bottom:20px;">
            <label style="font-size:12px; color:#888;">ä½œå“/IPå (ä¾‹å¦‚: Blue Lock)</label>
            <input type="text" id="gen-source-ip" class="input-full" style="margin-top:4px;">
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <!-- ã€å…³é”®ä¿®æ”¹ã€‘åŠ ä¸Š style="display: inline-block;" -->
            <button class="btn btn-cancel" onclick="document.getElementById('genInputModal').style.display='none'" style="display: inline-block;">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="submitGeneration()" style="display: inline-block;">å¼€å§‹ç”Ÿæˆ</button>
        </div>
    </div>
</div>

<!-- ã€æ–°å¢ã€‘AIç”Ÿæˆ - é¢„è§ˆç¡®è®¤å¼¹çª— -->
<div id="genPreviewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2100; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:20px; border-radius:12px; width:90%; max-width:600px; height:80vh; display:flex; flex-direction:column;">
        <h3 style="margin-top:0; color:#444;">ç¡®è®¤ç”Ÿæˆå†…å®¹</h3>
        <p style="font-size:12px; color:#888; margin-bottom:10px;">è¯·æ£€æŸ¥å¹¶ç¼–è¾‘ç”Ÿæˆçš„äººè®¾ï¼Œç‚¹å‡»â€œåº”ç”¨â€å°†è¦†ç›–å½“å‰ç¼–è¾‘æ¡†ã€‚</p>
        <textarea id="gen-preview-text" style="flex:1; width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; resize:none; font-family:monospace; line-height:1.5; box-sizing:border-box;"></textarea>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px;">
            <!-- ã€å…³é”®ä¿®æ”¹ã€‘åŠ ä¸Š style="display: inline-block;" -->
            <button class="btn btn-cancel" onclick="document.getElementById('genPreviewModal').style.display='none'" style="display: inline-block;">æ”¾å¼ƒ</button>
            <button class="btn btn-save" onclick="applyGeneratedPersona()" style="display: inline-block;">åº”ç”¨ (è¦†ç›–)</button>
        </div>
    </div>
</div>

<script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/sw.js')
                .then(reg => console.log('SW registered!', reg))
                .catch(err => console.log('SW failed', err));
        });
    }

    const charId = window.location.pathname.split('/').pop();

    // å…¨å±€æ•°æ®ç¼“å­˜ (å­˜å‚¨å®Œæ•´çš„åŸå§‹æ•°æ®ï¼Œç¡®ä¿ä¿å­˜æ—¶ä¸ä¸¢å¤±æœªæ˜¾ç¤ºçš„æ•°æ®)
    let GLOBAL_DATA = {};

    const CONFIG = {
        'short': { title: 'çŸ­æœŸè®°å¿† (Short-term / Recent 1 Day)', method: 'renderShort' },
        'medium': { title: 'ä¸­æœŸè®°å¿† (Medium-term / Recent 1 Week)', method: 'renderKV' },
        'long': { title: 'é•¿æœŸè®°å¿† (Long-term)', method: 'renderKV' },
        'schedule': { title: 'è¿‘æœŸæ—¥ç¨‹ (Schedule)', method: 'renderKV' },
        'relation': { title: 'å…³ç³»å›¾è°± (Relationship)', method: 'renderRelation' },
        'base': { title: 'è§’è‰²äººè®¾ (Base Persona)', method: 'renderMD' },
    };

    // --- ã€é€»è¾‘ç¡®è®¤ã€‘åˆ‡æ¢ç¼–è¾‘çŠ¶æ€ ---
    function toggleMetaEdit(isEditing) {
        const viewMode = document.getElementById('meta-view-mode');
        const editMode = document.getElementById('meta-edit-mode');

        if (isEditing) {
            // è¿›å…¥ç¼–è¾‘ï¼šéšè—æŸ¥çœ‹ï¼Œæ˜¾ç¤ºç¼–è¾‘
            viewMode.style.display = 'none';
            editMode.style.display = 'block';

            // åŒæ­¥æ•°æ®åˆ°è¾“å…¥æ¡†
            const currentRemark = document.getElementById('view-remark').textContent;
            // å¦‚æœæ˜¾ç¤ºçš„æ˜¯â€œ(åŠ è½½ä¸­...)â€ï¼Œå°±ä¸è¦å¡«è¿›å»ï¼Œå¡«ç©ºå­—ç¬¦ä¸²
            document.getElementById('edit-remark-input').value = (currentRemark === '(åŠ è½½ä¸­...)') ? '' : currentRemark;
            document.getElementById('edit-avatar-preview').src = document.getElementById('view-avatar').src;
        } else {
            // é€€å‡ºç¼–è¾‘ï¼šæ˜¾ç¤ºæŸ¥çœ‹ï¼Œéšè—ç¼–è¾‘
            viewMode.style.display = 'block';
            editMode.style.display = 'none';
        }
    }

    // --- ã€ä¿®æ­£ç‰ˆã€‘åŠ è½½è§’è‰²å…ƒæ•°æ® ---
    async function loadCharMeta() {
        try {
            // åŠ ä¸ªæ—¶é—´æˆ³é˜²æ­¢ç¼“å­˜ï¼Œè§£å†³â€œåˆ·æ–°åä¸è§äº†â€çš„é—®é¢˜
            const res = await fetch(`/api/${charId}/config?t=${new Date().getTime()}`);
            const data = await res.json();

            if(data && !data.error) {
                const avatarUrl = data.avatar || '/static/default_avatar.png';
                const remarkText = data.remark || data.name || 'Unknown';

                // 1. å¡«å……ã€æŸ¥çœ‹æ¨¡å¼ã€‘çš„æ•°æ®
                document.getElementById('view-avatar').src = avatarUrl;
                document.getElementById('view-remark').textContent = remarkText;
                document.getElementById('view-id').textContent = charId;

                // 2. å¡«å……ã€ç¼–è¾‘æ¨¡å¼ã€‘çš„æ•°æ® (ä½œä¸ºåˆå§‹å€¼)
                document.getElementById('edit-avatar-preview').src = avatarUrl;
                document.getElementById('edit-remark-input').value = remarkText;
            }
        } catch(e) {
            console.error("åŠ è½½è§’è‰²å…ƒæ•°æ®å¤±è´¥", e);
        }
    }

    // --- ã€ä¿®æ”¹ç‰ˆã€‘ä¿å­˜å¹¶é€€å‡º ---
    async function saveMetaAndExit() {
        const newRemark = document.getElementById('edit-remark-input').value.trim();
        // æ³¨æ„ï¼šå¤´åƒåœ¨ uploadAvatar æ—¶å·²ç»ä¸Šä¼ å¹¶æ›´æ–°äº†é…ç½®æ–‡ä»¶ï¼Œè¿™é‡Œä¸»è¦ä¿å­˜å¤‡æ³¨å
        // ä½†ä¸ºäº†é€»è¾‘ä¸¥è°¨ï¼Œæˆ‘ä»¬è¿˜æ˜¯æŠŠå½“å‰çš„å¤´åƒè·¯å¾„ï¼ˆè™½ç„¶è¿™é‡Œå‰ç«¯æ‹¿ä¸åˆ°æœ€æ–°è·¯å¾„å­—ç¬¦ä¸²ï¼Œé™¤éå­˜å…¨å±€å˜é‡ï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼‰
        // è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼šåªæ›´æ–°å¤‡æ³¨åã€‚å¤´åƒç”± uploadAvatar ç‹¬ç«‹å¤„ç†ã€‚

        const btn = document.querySelector('#module-meta .btn-save');
        btn.textContent = 'ä¿å­˜ä¸­...';
        btn.disabled = true;

        try {
            const res = await fetch(`/api/${charId}/update_meta`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    remark: newRemark
                    // avatar: null // ä¸ä¼  avatarï¼Œåç«¯å°±ä¸ä¼šè¦†ç›–æ‰åˆšæ‰ä¸Šä¼ çš„æ–°å¤´åƒ
                })
            });
            const result = await res.json();
            if(result.status === 'success') {
                // ä¿å­˜æˆåŠŸåï¼Œæ‰‹åŠ¨æ›´æ–°å‰ç«¯æ˜¾ç¤ºï¼Œä¸åˆ·æ–°é¡µé¢
                document.getElementById('view-remark').textContent = newRemark;
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                toggleMetaEdit(false);
            } else {
                alert('æ›´æ–°å¤±è´¥: ' + result.error);
            }
        } catch(e) {
            alert('ç½‘ç»œé”™è¯¯');
        } finally {
            btn.textContent = 'ä¿å­˜ / Save';
            btn.disabled = false;
        }
    }

    // --- ã€ä¿æŒã€‘ä¸Šä¼ å¤´åƒé€»è¾‘ (å¾®è°ƒ) ---
    async function uploadAvatar(inputElement) {
        const file = inputElement.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            document.getElementById('edit-avatar-preview').src = e.target.result;
        };
        reader.readAsDataURL(file);

        const formData = new FormData();
        formData.append('file', file);

        try {
            const imgEl = document.getElementById('edit-avatar-preview');
            imgEl.style.opacity = '0.5';

            const res = await fetch(`/api/${charId}/upload_avatar`, {
                method: 'POST',
                body: formData
            });
            const result = await res.json();

            if (result.status === 'success') {
                // ä¸Šä¼ æˆåŠŸåï¼Œç«‹åˆ»æ›´æ–°ã€æŸ¥çœ‹æ¨¡å¼ã€‘çš„å¤´åƒï¼Œè¿™æ ·ç‚¹ä¿å­˜é€€å‡ºåçœ‹åˆ°çš„æ˜¯æ–°çš„
                document.getElementById('view-avatar').src = result.url;
                imgEl.src = result.url;
                imgEl.style.opacity = '1';
                // alert('å¤´åƒå·²ä¸Šä¼ '); // å¯ä»¥å»æ‰å¼¹çª—ï¼Œä½“éªŒæ›´æµç•…
            } else {
                alert('ä¸Šä¼ å¤±è´¥: ' + result.error);
                imgEl.style.opacity = '1';
            }
        } catch (e) {
            alert('ç½‘ç»œé”™è¯¯');
            document.getElementById('edit-avatar-preview').style.opacity = '1';
        }
    }

    // --- åˆå§‹åŒ–éƒ¨åˆ† ---
    loadCharMeta(); // <--- ã€å…³é”®ã€‘é¡µé¢åŠ è½½æ—¶æ‰§è¡Œè¿™ä¸ª

    // åˆå§‹åŒ–
    fetch(`/api/${charId}/prompts_data`)
        .then(r => r.json())
        .then(data => {
            GLOBAL_DATA = data;
            Object.keys(CONFIG).forEach(key => initModule(key, data[key]));
        });

    function initModule(key, data) {
        const tpl = document.getElementById('tpl-module').content.cloneNode(true);
        const container = document.getElementById('module-' + key);

        tpl.querySelector('.mod-title').textContent = CONFIG[key].title;
        container.appendChild(tpl);

        // åˆå§‹æ¸²æŸ“è§†å›¾
        renderView(key, data);
    }

    // ================= æ¸²æŸ“è§†å›¾é€»è¾‘ (View Mode) =================

    function renderView(key, data) {
        const container = document.querySelector(`#module-${key} .view-mode`);
        if(!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
            container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
            return;
        }

        // 1. Markdown æ¸²æŸ“
        if(CONFIG[key].method === 'renderMD') {
            container.innerHTML = `<div style="padding:15px; white-space:pre-wrap;">${data}</div>`;
            return;
        }

        // 2. Short æ¸²æŸ“ (æ™ºèƒ½æ˜¾ç¤ºï¼šå‡Œæ™¨æ˜¾ç¤º2å¤©ï¼Œç™½å¤©æ˜¾ç¤º1å¤©)
        if(key === 'short') {
            // è·å–ç°æœ‰æ•°æ®çš„æ—¥æœŸåˆ—è¡¨
            const availableDates = Object.keys(data);
            if(availableDates.length === 0) {
                container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
                return;
            }

            // è®¡ç®—ã€åº”è¯¥ã€‘æ˜¾ç¤ºçš„æ—¥æœŸ
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];

            // é€»è¾‘ï¼šå¦‚æœæ˜¯å‡Œæ™¨4ç‚¹å‰ï¼Œç›®æ ‡æ—¥æœŸæ˜¯ [ä»Šå¤©, æ˜¨å¤©]ï¼›å¦åˆ™åªæ˜¯ [ä»Šå¤©]
            const targetDates = [todayStr];
            if (now.getHours() < 4) {
                targetDates.push(yesterdayStr);
            }

            // è¿‡æ»¤ï¼šåªæ˜¾ç¤ºç›®æ ‡æ—¥æœŸä¸­å­˜åœ¨çš„
            let hasContent = false;
            let html = '';

            targetDates.forEach(dateKey => {
                if (availableDates.includes(dateKey)) {
                    const dayData = data[dateKey];
                    const events = Array.isArray(dayData) ? dayData : (dayData.events || []);

                    // å¦‚æœè¿™ä¸€å¤©è™½ç„¶æœ‰Keyä½†æ²¡äº‹ä»¶ï¼Œä¹Ÿä¸æ˜¾ç¤º
                    if (events.length === 0) return;

                    hasContent = true;
                    const label = (dateKey === todayStr) ? '(Today)' : '';

                    html += `<div class="mem-item" style="border-left: 3px solid #ffb6b9; padding-left:12px;">
                      <div class="mem-header">ğŸ“… ${dateKey} ${label}</div>`;

                    events.forEach(e => {
                        html += `<div class="time-capsule">
                          <span class="time-tag">${e.time}</span>
                          <span>${e.event}</span>
                      </div>`;
                    });
                    html += `</div>`;
                }
            });

            container.innerHTML = hasContent ? html : '<div class="empty-state">æš‚æ— ä»Šæ—¥/æ˜¨æ—¥æ•°æ®</div>';
            return;
        }

        // 3. Medium æ¸²æŸ“ (åªå–æœ€è¿‘7å¤©)
        if(key === 'medium') {
            const dates = Object.keys(data).sort().reverse().slice(0, 7);
            let html = '';
            dates.forEach(d => {
                html += `<div class="mem-item"><div class="mem-header">ğŸ“” ${d}</div><div class="mem-text">${data[d]}</div></div>`;
            });
            container.innerHTML = html || '<div class="empty-state">æš‚æ— æ•°æ® (è¿‘7å¤©)</div>';
            return;
        }

        // --- Schedule æ¸²æŸ“ (åªæ˜¾ç¤ºæœªæ¥ 7 å¤©) ---
        if(key === 'schedule') {
            // è®¡ç®—ä»Šå¤©å’Œ7å¤©åçš„æ—¥æœŸå­—ç¬¦ä¸²
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];

            const limitDate = new Date(now);
            limitDate.setDate(now.getDate() + 7);
            const limitStr = limitDate.toISOString().split('T')[0];

            const dates = Object.keys(data).sort();
            let html = '';

            dates.forEach(d => {
                // ã€ä¿®æ”¹ã€‘åªæ˜¾ç¤ºèŒƒå›´å†…çš„æ•°æ®
                if (d >= todayStr && d <= limitStr) {
                    html += `<div class="mem-item"><div class="mem-header">ğŸ“Œ ${d}</div><div class="mem-text">${data[d]}</div></div>`;
                }
            });

            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œæˆ–è€…æ•°æ®éƒ½åœ¨èŒƒå›´å¤–
            container.innerHTML = html || '<div class="empty-state">æœªæ¥7å¤©æš‚æ— æ—¥ç¨‹</div>';
            return;
        }

        // 4. é€šç”¨ KV æ¸²æŸ“ (Long, Schedule)
        if(CONFIG[key].method === 'renderKV') {
            const sortedKeys = Object.keys(data).sort().reverse();
            let html = '';
            sortedKeys.forEach(k => {
                html += `<div class="mem-item"><div class="mem-header">ğŸ“Œ ${k}</div><div class="mem-text">${data[k]}</div></div>`;
            });
            container.innerHTML = html;

            return;
        }

        // 5. Relation æ¸²æŸ“
        if(key === 'relation') {
            let html = '';
            Object.keys(data).forEach(name => {
                const info = data[name];
                html += `<div class="mem-item"><div class="mem-header">ğŸ‘¤ ${name} [${info.role}]</div><div class="mem-text">${info.description}</div></div>`;
            });
            container.innerHTML = html;
        }
    }

    // ================= ç¼–è¾‘æ¨¡å¼é€»è¾‘ (Edit Mode) =================

    function toggleEdit(btn) {
        const module = btn.closest('.module');
        const key = module.id.replace('module-', '');
        const editBox = module.querySelector('.edit-mode');

        module.classList.add('editing');

        // ã€Fixã€‘åŸæ¥çš„ module.closest('details') æ˜¯é”™çš„ï¼Œå› ä¸º details åœ¨ module é‡Œé¢
        // æˆ‘ä»¬ç›´æ¥è®©å½“å‰æ¨¡å—å†…éƒ¨çš„ details å±•å¼€å³å¯
        const detailsEl = module.querySelector('details');
        if(detailsEl) detailsEl.open = true;

        // æ ¹æ®ç±»å‹ç”Ÿæˆç¼–è¾‘å™¨
        buildEditor(key, editBox);
    }

    function cancelEdit(btn) {
        const module = btn.closest('.module');
        module.classList.remove('editing');
    }

    function buildEditor(key, container) {
        const data = GLOBAL_DATA[key];
        container.innerHTML = ''; // æ¸…ç©º

        // 1. Markdown ç¼–è¾‘å™¨
        if(CONFIG[key].method === 'renderMD') {
            let extraHtml = '';
            // ã€æ–°å¢ã€‘åªåœ¨è§’è‰²äººè®¾(base)æ¨¡å—æ˜¾ç¤º AIç”ŸæˆæŒ‰é’®
            if (key === 'base') {
                extraHtml = `<button class="btn" style="background:#e1bee7; color:#4a148c; margin-bottom:10px; width:100%;" onclick="openGenModal()">âœ¨ AI è‡ªåŠ¨ç¼–å†™äººè®¾</button>`;
            }

            container.innerHTML = `${extraHtml}<textarea class="md-editor">${data || ''}</textarea>`;
            return;
        }

        // 2. Short ç¼–è¾‘å™¨ (ç‰¹æ®Šï¼šåªç¼–è¾‘æœ€è¿‘ä¸€å¤©ï¼Œæˆ–è€…æä¾›æ·»åŠ æ–°æ—¥æœŸçš„èƒ½åŠ›ï¼Ÿä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç¼–è¾‘â€œå±•ç¤ºå‡ºæ¥çš„é‚£ä¸ªæ—¥æœŸâ€)
        if(key === 'short') {
            const dates = Object.keys(data).sort().reverse();
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé»˜è®¤åˆ›å»ºä»Šå¤©
            const targetDate = dates.length > 0 ? dates[0] : new Date().toISOString().split('T')[0];
            const dayData = data[targetDate] || [];
            const events = Array.isArray(dayData) ? dayData : (dayData.events || []);

            // æ˜¾ç¤ºæ—¥æœŸæ ‡é¢˜
            container.innerHTML += `<div style="font-weight:bold; margin-bottom:10px; color:#ffb6b9; display:flex; justify-content:space-between;">
                <span>ç¼–è¾‘æ—¥æœŸ: ${targetDate}</span>
                <!-- ã€æ–°å¢ã€‘é‡ç½®è¿›åº¦å¤é€‰æ¡† -->
                <label style="font-size:12px; color:#666; display:flex; align-items:center; cursor:pointer;">
                    <input type="checkbox" id="reset-progress-chk" style="margin-right:4px;">
                    é‡ç½®è¯»å–è¿›åº¦ (å…è®¸é‡æ–°æ€»ç»“)
                </label>
            </div>`;

            // éšè—åŸŸå­˜å‚¨å½“å‰ç¼–è¾‘çš„æ—¥æœŸ Key
            container.dataset.dateKey = targetDate;

            // ç”Ÿæˆäº‹ä»¶åˆ—è¡¨
            const listDiv = document.createElement('div');
            listDiv.className = 'edit-list';
            events.forEach(e => {
                listDiv.innerHTML += `
                  <div class="input-group">
                      <input type="text" class="input-key" value="${e.time}" placeholder="HH:MM">
                      <input type="text" class="input-val" value="${e.event}" placeholder="äº‹ä»¶å†…å®¹">
                      <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
                  </div>`;
            });
            container.appendChild(listDiv);
            container.innerHTML += `<button class="btn-add" onclick="addShortRow(this)">+ æ·»åŠ äº‹ä»¶</button>`;
            return;
        }

        // 3. é€šç”¨ KV ç¼–è¾‘å™¨ (Medium, Long, Schedule)
        if(CONFIG[key].method === 'renderKV') {
            // å®¹é”™å¤„ç†
            if (typeof data !== 'object' || data === null) {
                container.innerHTML = `<div style="color:red;font-size:12px;margin-bottom:5px;">âš ï¸ æ•°æ®æ ¼å¼é”™è¯¯æˆ–ä¸ºç©ºï¼Œè¯·ç›´æ¥ç²˜è´´ JSON ä¿®å¤ï¼š</div>
                                     <textarea class="md-editor">${data || ''}</textarea>`;
                return;
            }

            // === ã€æ–°å¢ã€‘å¦‚æœæ˜¯ Scheduleï¼Œæ’å…¥å¤åˆ¶å·¥å…·æ  ===
            if (key === 'schedule') {
                const copyTool = document.createElement('div');
                copyTool.style.cssText = "background:#f0f7ff; padding:10px; border-radius:8px; margin-bottom:15px; border:1px solid #cce5ff;";
                copyTool.innerHTML = `
                  <div style="font-size:12px; color:#1565c0; font-weight:bold; margin-bottom:5px;">ğŸ“¥ ä»ä»–äººå¤åˆ¶æ—¥ç¨‹ (è¦†ç›–å½“å‰)</div>
                  <div style="display:flex; gap:5px;">
                      <select id="schedule-source-select" style="flex:1; padding:6px; border-radius:4px; border:1px solid #ddd;">
                          <option>æ­£åœ¨åŠ è½½...</option>
                      </select>
                      <button class="btn" style="background:#1565c0; color:white;" onclick="copyScheduleFrom()">å¤åˆ¶</button>
                  </div>
              `;
                container.appendChild(copyTool);

                // ã€å…³é”®ã€‘ç«‹å³è°ƒç”¨åŠ è½½å‡½æ•°ï¼Œå¹¶ä¸”åŠ ä¸ªå»¶æ—¶ç¡®ä¿å…ƒç´ å·²æ¸²æŸ“
                setTimeout(() => {
                    loadContactsForSelect();
                }, 50);
            }
            // ========================================================

            const sortedKeys = Object.keys(data).sort().reverse();
            const listDiv = document.createElement('div');
            sortedKeys.forEach(k => {
                listDiv.innerHTML += `
                  <div class="input-group">
                      <input type="text" class="input-key" value="${k}" placeholder="Key/Date">
                      <textarea class="input-val" rows="2">${data[k]}</textarea>
                      <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
                  </div>`;
            });
            container.appendChild(listDiv);
            container.innerHTML += `<button class="btn-add" onclick="addKVRow(this)">+ æ·»åŠ æ¡ç›®</button>`;

            return; // <--- return å¿…é¡»åœ¨æœ€åï¼
        }

        // 4. Relation ç¼–è¾‘å™¨
        if(key === 'relation') {
            const names = Object.keys(data);
            const listDiv = document.createElement('div');
            names.forEach(name => {
                const info = data[name];
                listDiv.innerHTML += `
                   <div class="rel-edit-card">
                       <div class="input-group">
                           <input type="text" class="input-key" value="${name}" placeholder="å§“å">
                           <input type="text" class="input-val" value="${info.role}" placeholder="å…³ç³»å®šä½">
                           <button class="btn-del" onclick="this.closest('.rel-edit-card').remove()">Ã—</button>
                       </div>
                       <textarea class="input-full" rows="2" placeholder="è¯¦ç»†æè¿°">${info.description}</textarea>
                   </div>`;
            });
            container.appendChild(listDiv);
            container.innerHTML += `<button class="btn-add" onclick="addRelRow(this)">+ æ·»åŠ è§’è‰²</button>`;
        }
    }

    // --- åŠ¨æ€æ·»åŠ è¡Œçš„è¾…åŠ©å‡½æ•° ---
    function addShortRow(btn) {
        const row = `<div class="input-group">
          <input type="text" class="input-key" value="" placeholder="HH:MM">
          <input type="text" class="input-val" value="" placeholder="äº‹ä»¶å†…å®¹">
          <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
      </div>`;
        btn.previousElementSibling.insertAdjacentHTML('beforeend', row);
    }

    function addKVRow(btn) {
        const row = `<div class="input-group">
          <input type="text" class="input-key" value="" placeholder="Key/Date">
          <textarea class="input-val" rows="2"></textarea>
          <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
      </div>`;
        btn.previousElementSibling.insertAdjacentHTML('beforeend', row);
    }

    function addRelRow(btn) {
        const row = `<div class="rel-edit-card">
           <div class="input-group">
               <input type="text" class="input-key" value="" placeholder="å§“å">
               <input type="text" class="input-val" value="" placeholder="å…³ç³»å®šä½">
               <button class="btn-del" onclick="this.closest('.rel-edit-card').remove()">Ã—</button>
           </div>
           <textarea class="input-full" rows="2" placeholder="è¯¦ç»†æè¿°"></textarea>
       </div>`;
        btn.previousElementSibling.insertAdjacentHTML('beforeend', row);
    }

    // ================= ä¿å­˜é€»è¾‘ (Save) =================

    async function saveData(btn) {
        const module = btn.closest('.module');
        const key = module.id.replace('module-', '');
        const container = module.querySelector('.edit-mode');

        let newData = null;

        // 1. Markdown ä¿å­˜
        if(CONFIG[key].method === 'renderMD') {
            newData = container.querySelector('textarea').value;
        }

        // 2. Short ä¿å­˜ (ç‰¹æ®Šï¼šåªæ›´æ–°äº†é‚£ä¸€å¤©ï¼Œéœ€è¦åˆå¹¶å› GLOBAL_DATA)
        else if(key === 'short') {
            const dateKey = container.dataset.dateKey;
            const rows = container.querySelectorAll('.input-group');
            const newEvents = [];
            rows.forEach(row => {
                const t = row.querySelector('.input-key').value.trim();
                const v = row.querySelector('.input-val').value.trim();
                if(t && v) newEvents.push({time: t, event: v});
            });

            // è·å–åŸå§‹ last_id
            const originalDayData = GLOBAL_DATA[key][dateKey] || {};
            let lastId = 0;
            if(!Array.isArray(originalDayData)) lastId = originalDayData.last_id || 0;

            // ã€æ–°å¢ã€‘æ£€æŸ¥å¤é€‰æ¡†æ˜¯å¦å‹¾é€‰
            const resetChk = container.querySelector('#reset-progress-chk');
            if (resetChk && resetChk.checked) {
                lastId = 0; // å¼ºåˆ¶å½’é›¶ï¼ä¸‹æ¬¡å°±ä¼šé‡æ–°æ‰«ææ‰€æœ‰æ¶ˆæ¯
                console.log("å·²é‡ç½® last_id ä¸º 0");
            }

            newData = { ...GLOBAL_DATA[key] };
            newData[dateKey] = {
                events: newEvents,
                last_id: lastId
            };
        }

        // 3. KV ä¿å­˜ (Medium, Long, Schedule)
        else if(CONFIG[key].method === 'renderKV') {
            newData = {};
            const rows = container.querySelectorAll('.input-group');
            rows.forEach(row => {
                const k = row.querySelector('.input-key').value.trim();
                const v = row.querySelector('.input-val').value.trim();
                if(k) newData[k] = v;
            });
        }

        // 4. Relation ä¿å­˜
        else if(key === 'relation') {
            newData = {};
            const cards = container.querySelectorAll('.rel-edit-card');
            cards.forEach(card => {
                const name = card.querySelector('.input-key').value.trim();
                const role = card.querySelector('.input-val').value.trim();
                const desc = card.querySelector('.input-full').value.trim();
                if(name) {
                    newData[name] = { role: role, description: desc };
                }
            });
        }

        // --- å‘é€ç»™åç«¯ ---
        btn.textContent = 'Saving...';
        try {
            const res = await fetch(`/api/${charId}/save_prompt`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: key, content: newData })
            });
            const result = await res.json();
            if(result.status === 'success') {
                // æ›´æ–°æœ¬åœ°ç¼“å­˜
                GLOBAL_DATA[key] = newData;
                // é‡æ–°æ¸²æŸ“è§†å›¾
                renderView(key, newData);
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                module.classList.remove('editing');
                btn.textContent = 'ä¿å­˜ / Save';
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + result.message);
                btn.textContent = 'ä¿å­˜ / Save';
            }
        } catch(e) {
            alert('ç½‘ç»œé”™è¯¯');
            btn.textContent = 'ä¿å­˜ / Save';
        }
    }

    // --- è·å–è”ç³»äººåˆ—è¡¨ (å¢å¼ºç‰ˆ) ---
    async function loadContactsForSelect() {
        console.log("æ­£åœ¨åŠ è½½è”ç³»äººåˆ—è¡¨..."); // Debugæ—¥å¿—

        const select = document.getElementById('schedule-source-select');
        if (!select) {
            console.error("é”™è¯¯ï¼šæ‰¾ä¸åˆ° select å…ƒç´ ï¼");
            return;
        }

        try {
            // è¯·æ±‚åç«¯ API
            const res = await fetch('/api/contacts');
            if (!res.ok) {
                throw new Error(`API é”™è¯¯: ${res.status}`);
            }

            const contacts = await res.json();
            console.log("è·å–åˆ°çš„è”ç³»äºº:", contacts); // Debugæ—¥å¿—

            let html = '<option value="">-- é€‰æ‹©è§’è‰² --</option>';
            let count = 0;

            contacts.forEach(c => {
                // æ’é™¤è‡ªå·± (charId æ˜¯å…¨å±€å˜é‡)
                if (c.id !== charId) {
                    html += `<option value="${c.id}">${c.remark || c.name}</option>`;
                    count++;
                }
            });

            if (count === 0) {
                html = '<option value="">æ²¡æœ‰å…¶ä»–è§’è‰²å¯å¤åˆ¶</option>';
            }

            select.innerHTML = html;

        } catch(e) {
            console.error("åŠ è½½è”ç³»äººå¤±è´¥", e);
            select.innerHTML = '<option>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</option>';
        }
    }

    // --- æ‰§è¡Œå¤åˆ¶æ—¥ç¨‹ ---
    async function copyScheduleFrom() {
        const select = document.getElementById('schedule-source-select');
        const sourceId = select.value;
        if (!sourceId) return alert("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè§’è‰²ï¼");

        if (!confirm("âš ï¸ è­¦å‘Šï¼šè¿™å°†å®Œå…¨è¦†ç›–å½“å‰çš„æ—¥ç¨‹æ–‡ä»¶ï¼\nç¡®å®šè¦ä»è¯¥è§’è‰²å¤åˆ¶å—ï¼Ÿ")) return;

        const btn = event.target;
        btn.textContent = "...";
        btn.disabled = true;

        try {
            const res = await fetch(`/api/${charId}/copy_schedule`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ source_id: sourceId })
            });
            const result = await res.json();

            if (result.status === 'success') {
                alert("å¤åˆ¶æˆåŠŸï¼é¡µé¢å°†åˆ·æ–°ã€‚");
                // æ›´æ–°å…¨å±€ç¼“å­˜å¹¶åˆ·æ–°ç¼–è¾‘ç•Œé¢
                GLOBAL_DATA['schedule'] = result.data;
                // é‡æ–°æ„å»ºç¼–è¾‘å™¨ä»¥æ˜¾ç¤ºæ–°æ•°æ®
                const container = document.querySelector('#module-schedule .edit-mode');
                buildEditor('schedule', container);
            } else {
                alert("å¤åˆ¶å¤±è´¥: " + result.error);
            }
        } catch(e) {
            alert("ç½‘ç»œé”™è¯¯");
        } finally {
            btn.textContent = "å¤åˆ¶";
            btn.disabled = false;
        }
    }

    // --- AI ç”Ÿæˆäººè®¾é€»è¾‘ ---

    function openGenModal() {
        // è‡ªåŠ¨å¡«å…¥å½“å‰è§’è‰²é…ç½®é‡Œçš„åå­—ï¼Œæ–¹ä¾¿ç”¨æˆ·
        // è¿™é‡Œå‡è®¾ charConfig å…¨å±€å˜é‡è¿˜åœ¨ï¼Œå¦‚æœä¸åœ¨ä¹Ÿæ²¡å…³ç³»ï¼Œç©ºç€å°±è¡Œ
        // document.getElementById('gen-char-name').value = ...
        document.getElementById('genInputModal').style.display = 'flex';
    }

    async function submitGeneration() {
        const name = document.getElementById('gen-char-name').value.trim();
        const ip = document.getElementById('gen-source-ip').value.trim();
        if(!name || !ip) return alert("è¯·å¡«å†™å®Œæ•´ï¼");

        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "ç”Ÿæˆä¸­(çº¦15ç§’)...";
        btn.disabled = true;

        try {
            const res = await fetch('/api/generate_persona', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ char_name: name, source_ip: ip })
            });
            const result = await res.json();

            if(result.status === 'success') {
                // å…³é—­è¾“å…¥æ¡†ï¼Œæ‰“å¼€é¢„è§ˆæ¡†
                document.getElementById('genInputModal').style.display = 'none';
                document.getElementById('gen-preview-text').value = result.content;
                document.getElementById('genPreviewModal').style.display = 'flex';
            } else {
                alert("ç”Ÿæˆå¤±è´¥: " + result.error);
            }
        } catch(e) {
            alert("ç½‘ç»œé”™è¯¯");
        } finally {
            btn.textContent = originalText;
            btn.disabled = false;
        }
    }

    function applyGeneratedPersona() {
        const content = document.getElementById('gen-preview-text').value;
        if(!content) return;

        // 1. æŠŠå†…å®¹å¡«å…¥ä¸»ç¼–è¾‘å™¨çš„æ–‡æœ¬æ¡†
        // æˆ‘ä»¬éœ€è¦æ‰¾åˆ°å½“å‰å±•å¼€çš„ base æ¨¡å—çš„ textarea
        const editor = document.querySelector('#module-base .md-editor');
        if(editor) {
            editor.value = content;
            // 2. å…³é—­å¼¹çª—
            document.getElementById('genPreviewModal').style.display = 'none';
            alert("å·²å¡«å…¥ç¼–è¾‘å™¨ï¼\nè¯·æ£€æŸ¥æ— è¯¯åï¼Œç‚¹å‡»ä¸‹æ–¹çš„ã€Œä¿å­˜ã€æŒ‰é’®å†™å…¥æ–‡ä»¶ã€‚");
        } else {
            alert("æ‰¾ä¸åˆ°ç¼–è¾‘å™¨å®ä¾‹ï¼Œè¯·åˆ·æ–°é‡è¯•");
        }
    }

</script>

</body>
</html>