<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®°å¿†æ ¸å¿ƒ | Memory Core</title>
    <style>
        /* --- å…¨å±€åŸºç¡€ --- */
        * { box-sizing: border-box; /* å…³é”®ï¼šé˜²æ­¢å†…è¾¹è·æ’‘ç ´å®¹å™¨ */ }

        body {
            font-family: "Segoe UI", "PingFang SC", sans-serif;
            background: linear-gradient(135deg, #fff3f8 0%, #ffe9e1 100%);
            margin: 0; padding: 15px; color: #444; min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding-bottom: 80px;}

        /* å¤´éƒ¨ */
        .header {
            display: flex; align-items: center; margin-bottom: 20px;
            background: rgba(255,255,255,0.6); backdrop-filter: blur(10px);
            padding: 12px 20px; border-radius: 16px; border: 1px solid #ffe5e8;
        }
        .back-btn { font-size: 24px; margin-right: 15px; cursor: pointer; color: #ffb6b9; }
        h1 { margin: 0; font-size: 16px; color: #333; flex: 1; text-align: center; margin-right: 24px;}

        /* æ¨¡å—é€šç”¨ */
        .section-title { font-size: 13px; color: #aaa; margin: 25px 0 10px 5px; font-weight: bold; text-transform: uppercase; }

        details {
            background: #fff; border-radius: 12px; margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03); border: 1px solid #fff0f2;
            overflow: hidden;
        }
        summary {
            padding: 15px; cursor: pointer; font-weight: 600; list-style: none;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.5); font-size: 14px;
        }
        summary::-webkit-details-marker { display: none; }

        /* æ“ä½œæ  */
        .action-bar {
            padding: 10px 15px; background: #fffcfc; border-bottom: 1px solid #eee;
            display: flex; justify-content: flex-end; gap: 10px; flex-wrap: wrap;
        }
        .btn {
            padding: 6px 14px; border-radius: 6px; font-size: 13px; cursor: pointer; border: none; font-weight: bold; flex-shrink: 0;
        }
        .btn-edit { background: #e3f2fd; color: #1565c0; }
        .btn-save { background: #e8f5e9; color: #2e7d32; display: none; }
        .btn-cancel { background: #ffebee; color: #c62828; display: none; }

        /* å†…å®¹åŒº */
        .content-box { padding: 0; background: #fafafa; }
        .empty-state { padding: 20px; text-align: center; color: #bbb; font-style: italic; font-size: 13px; }

        /* ------------------- å±•ç¤ºæ¨¡å¼ (View Mode) ------------------- */
        .view-mode .mem-item { padding: 12px 16px; border-bottom: 1px solid #eee; }
        .view-mode .mem-header { font-size: 12px; color: #ffb6b9; font-weight: bold; margin-bottom: 6px; word-break: break-all;}
        .view-mode .mem-text { font-size: 14px; white-space: pre-wrap; color: #555; line-height: 1.6; word-break: break-word;}
        .view-mode .time-capsule { display: flex; gap: 10px; padding: 6px 0; font-size: 14px; align-items: flex-start;}
        .view-mode .time-tag { background: #e3f2fd; color: #1565c0; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-family: monospace; white-space: nowrap; margin-top: 2px;}

        /* ------------------- ç¼–è¾‘æ¨¡å¼ (Edit Mode) ------------------- */
        .edit-mode { padding: 15px; display: none; background: #fff; }

        /* åˆ‡æ¢æ˜¾ç¤º */
        .editing .view-mode { display: none; }
        .editing .edit-mode { display: block; }
        .editing .btn-edit { display: none; }
        .editing .btn-save, .editing .btn-cancel { display: inline-block; }

        /* --- è¾“å…¥æ§ä»¶ç»„ (Desktop é»˜è®¤) --- */
        .input-group {
            display: flex; gap: 8px; margin-bottom: 12px;
            align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
            border-bottom: 1px dashed #f0f0f0; /* åˆ†éš”çº¿ */
            padding-bottom: 12px;
        }
        .input-group:last-child { border-bottom: none; }

        /* æ‰€æœ‰çš„è¾“å…¥æ¡† */
        input[type="text"], textarea {
            border: 1px solid #ddd; border-radius: 6px; padding: 10px;
            font-family: inherit; font-size: 14px;
            transition: border-color 0.2s;
        }
        input:focus, textarea:focus { border-color: #ffb6b9; outline: none; }

        /* 1. Key è¾“å…¥æ¡† (æ—¶é—´/æ—¥æœŸ/é”®å) */
        .input-key { width: 140px; flex-shrink: 0; background: #fff; font-weight: bold; color: #555; }

        /* 2. Value è¾“å…¥æ¡† (å†…å®¹) - è§£å†³â€œæ¡†å¤ªå°â€é—®é¢˜ */
        .input-val { flex: 1; min-width: 0; } /* min-width:0 é˜²æ­¢flexæº¢å‡º */
        textarea.input-val { min-height: 100px; resize: vertical; line-height: 1.5; }

        /* 3. Full è¾“å…¥æ¡† (å¤§æ®µæè¿°) */
        .input-full { width: 100%; min-height: 80px; margin-top: 6px; resize: vertical; }

        /* åˆ é™¤æŒ‰é’® */
        .btn-del {
            background: #ffebee; color: #c62828; width: 36px; height: 36px;
            border-radius: 6px; border: none; cursor: pointer; flex-shrink: 0;
            font-size: 18px; display: flex; align-items: center; justify-content: center;
        }

        /* æ·»åŠ æŒ‰é’® */
        .btn-add {
            width: 100%; padding: 12px; background: #f8f9fa; border: 2px dashed #ddd;
            color: #888; border-radius: 8px; cursor: pointer; margin-top: 10px; font-weight: bold;
            transition: all 0.2s;
        }
        .btn-add:hover { border-color: #ffb6b9; color: #ffb6b9; background: #fff; }

        /* å…³ç³»ç¼–è¾‘å¡ç‰‡ */
        .rel-edit-card {
            border: 1px solid #eee; padding: 12px; border-radius: 8px;
            margin-bottom: 12px; background: #fafafa;
        }

        /* Markdown æ–‡æœ¬åŸŸ */
        .md-editor { width: 100%; min-height: 300px; padding: 12px; line-height: 1.6; font-family: monospace; }

        /* ================= ğŸ“± æ‰‹æœºç«¯é€‚é… (å…³é”®ï¼) ================= */
        @media (max-width: 600px) {
            body { padding: 10px; }

            /* 1. å¼ºåˆ¶çºµå‘æ’åˆ—ï¼šè§£å†³â€œé£å‡ºå»â€å’Œâ€œæ˜¾ç¤ºä¸å…¨â€ */
            .input-group {
                flex-direction: column; /* ä¸Šä¸‹æ’ */
                background: #fdfdfd;
                border: 1px solid #eee;
                border-radius: 8px;
                padding: 10px;
                gap: 10px; /* æ§ä»¶é—´è·åŠ å¤§ */
            }

            /* 2. æ‰€æœ‰è¾“å…¥æ¡†å®½åº¦ 100% */
            .input-key, .input-val, .input-full {
                width: 100% !important; /* å¼ºåˆ¶å¡«æ»¡ */
                flex: none;
                max-width: 100%;
            }

            /* çŸ­æœŸè®°å¿†çš„æ—¶é—´æ¡†å¯ä»¥ç¨å¾®çŸ®ä¸€ç‚¹ */
            .input-key { background-color: #fff8f8; }

            /* 3. åˆ é™¤æŒ‰é’®å˜æˆåº•éƒ¨çš„å®½æ¡ï¼Œæ–¹ä¾¿æ‰‹æŒ‡ç‚¹ */
            .btn-del {
                width: 100%;
                height: 32px;
                margin-top: 5px;
                background-color: #fff0f0;
                border: 1px solid #ffcdd2;
            }
            .btn-del::after { content: ' åˆ é™¤ / Delete'; font-size: 12px; margin-left: 5px; }

            /* å…³ç³»å¡ç‰‡é‡Œçš„å¸ƒå±€è°ƒæ•´ */
            .rel-edit-card .input-group {
                border: none; padding: 0; background: transparent;
            }

            /* æ“ä½œæ æŒ‰é’® */
            .action-bar .btn { flex: 1; text-align: center; } /* æŒ‰é’®å‡åˆ†å®½åº¦ */
        }

    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <div class="back-btn" onclick="window.location.href='/'">â†</div>
        <h1>è¨˜æ†¶ã®ä¿ç®¡åº« (Memory Archive)</h1>
    </div>

    <!-- ================= åŠ¨æ€è®°å¿†åŒºåŸŸ ================= -->
    <div class="section-title">ğŸ§  åŠ¨æ€è®°å¿† (Dynamic Memory)</div>

    <!-- 1. çŸ­æœŸè®°å¿† (JSON, ä»…å±•ç¤ºæœ€è¿‘1å¤©, åˆ—è¡¨ç¼–è¾‘) -->
    <div id="module-short" class="module" data-type="short"></div>

    <!-- 2. ä¸­æœŸè®°å¿† (JSON, ä»…å±•ç¤ºæœ€è¿‘7å¤©, KVç¼–è¾‘) -->
    <div id="module-medium" class="module" data-type="medium"></div>

    <!-- 3. é•¿æœŸè®°å¿† (JSON, å…¨éƒ¨, KVç¼–è¾‘) -->
    <div id="module-long" class="module" data-type="long"></div>

    <!-- 4. æ—¥ç¨‹ (JSON, å…¨éƒ¨, KVç¼–è¾‘) -->
    <div id="module-schedule" class="module" data-type="schedule"></div>

    <!-- ================= æ ¸å¿ƒè®¾å®šåŒºåŸŸ ================= -->
    <div class="section-title">ğŸ§¬ æ ¸å¿ƒè®¾å®š (Core Prompts)</div>

    <!-- 5. å…³ç³» (JSON, å¤æ‚å¯¹è±¡ç¼–è¾‘) -->
    <div id="module-relation" class="module" data-type="relation"></div>

    <!-- 6. Markdown æ–‡æœ¬ç±» -->
    <div id="module-base" class="module" data-type="base"></div>
    <div id="module-user" class="module" data-type="user"></div>
    <div id="module-format" class="module" data-type="format"></div>

</div>

<!-- æ¨¡æ¿ï¼šæ¨¡å—å¤–å£³ -->
<template id="tpl-module">
    <details>
        <summary><span class="mod-title"></span></summary>
        <div class="action-bar">
            <button class="btn btn-edit" onclick="toggleEdit(this)">ç¼–è¾‘ / Edit</button>
            <button class="btn btn-cancel" onclick="cancelEdit(this)">å–æ¶ˆ</button>
            <button class="btn btn-save" onclick="saveData(this)">ä¿å­˜ / Save</button>
        </div>
        <div class="content-box">
            <!-- å±•ç¤ºæ¨¡å¼ -->
            <div class="view-mode"></div>
            <!-- ç¼–è¾‘æ¨¡å¼ -->
            <div class="edit-mode"></div>
        </div>
    </details>
</template>

<script>
    // å…¨å±€æ•°æ®ç¼“å­˜ (å­˜å‚¨å®Œæ•´çš„åŸå§‹æ•°æ®ï¼Œç¡®ä¿ä¿å­˜æ—¶ä¸ä¸¢å¤±æœªæ˜¾ç¤ºçš„æ•°æ®)
    let GLOBAL_DATA = {};

    const CONFIG = {
        'short': { title: 'çŸ­æœŸè®°å¿† (Short-term / Recent 1 Day)', method: 'renderShort' },
        'medium': { title: 'ä¸­æœŸè®°å¿† (Medium-term / Recent 1 Week)', method: 'renderKV' },
        'long': { title: 'é•¿æœŸè®°å¿† (Long-term)', method: 'renderKV' },
        'schedule': { title: 'è¿‘æœŸæ—¥ç¨‹ (Schedule)', method: 'renderKV' },
        'relation': { title: 'å…³ç³»å›¾è°± (Relationship)', method: 'renderRelation' },
        'base': { title: 'è§’è‰²äººè®¾ (Base Persona)', method: 'renderMD' },
        'user': { title: 'ç”¨æˆ·æ¡£æ¡ˆ (User Persona)', method: 'renderMD' },
        'format': { title: 'æ ¼å¼è§„åˆ™ (System Rules)', method: 'renderMD' }
    };

    // åˆå§‹åŒ–
    fetch('/api/prompts_data')
        .then(r => r.json())
        .then(data => {
            GLOBAL_DATA = data;
            Object.keys(CONFIG).forEach(key => initModule(key, data[key]));
        });

    function initModule(key, data) {
        const tpl = document.getElementById('tpl-module').content.cloneNode(true);
        const container = document.getElementById('module-' + key);

        tpl.querySelector('.mod-title').textContent = CONFIG[key].title;
        container.appendChild(tpl);

        // åˆå§‹æ¸²æŸ“è§†å›¾
        renderView(key, data);
    }

    // ================= æ¸²æŸ“è§†å›¾é€»è¾‘ (View Mode) =================

    function renderView(key, data) {
        const container = document.querySelector(`#module-${key} .view-mode`);
        if(!data || (typeof data === 'object' && Object.keys(data).length === 0)) {
            container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>';
            return;
        }

        // 1. Markdown æ¸²æŸ“
        if(CONFIG[key].method === 'renderMD') {
            container.innerHTML = `<div style="padding:15px; white-space:pre-wrap;">${data}</div>`;
            return;
        }

        // 2. Short æ¸²æŸ“ (åªå–æœ€è¿‘1å¤©)
        if(key === 'short') {
            const dates = Object.keys(data).sort().reverse();
            if(dates.length === 0) { container.innerHTML = '<div class="empty-state">æš‚æ— æ•°æ®</div>'; return; }

            const latestDate = dates[0]; // åªå±•ç¤ºæœ€è¿‘ä¸€å¤©
            const dayData = data[latestDate];
            const events = Array.isArray(dayData) ? dayData : (dayData.events || []);

            let html = `<div class="mem-item"><div class="mem-header">ğŸ“… ${latestDate} (Displaying Latest)</div>`;
            events.forEach(e => {
                html += `<div class="time-capsule"><span class="time-tag">${e.time}</span><span>${e.event}</span></div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
            return;
        }

        // 3. Medium æ¸²æŸ“ (åªå–æœ€è¿‘7å¤©)
        if(key === 'medium') {
            const dates = Object.keys(data).sort().reverse().slice(0, 7);
            let html = '';
            dates.forEach(d => {
                html += `<div class="mem-item"><div class="mem-header">ğŸ“” ${d}</div><div class="mem-text">${data[d]}</div></div>`;
            });
            container.innerHTML = html || '<div class="empty-state">æš‚æ— æ•°æ® (è¿‘7å¤©)</div>';
            return;
        }

        // --- ã€æ–°å¢ã€‘Schedule æ¸²æŸ“ (åªæ˜¾ç¤ºä»Šå¤©åŠä»¥å) ---
        if(key === 'schedule') {
            const today = new Date().toISOString().split('T')[0]; // è·å–ä»Šå¤© YYYY-MM-DD
            // æ—¥æœŸå‡åºæ’åˆ— (ç¦»ä»Šå¤©æœ€è¿‘çš„åœ¨æœ€ä¸Šé¢)
            const dates = Object.keys(data).sort();

            let html = '';
            let count = 0;
            dates.forEach(d => {
                // æ ¸å¿ƒè¿‡æ»¤ï¼šåªæœ‰æ—¥æœŸ >= ä»Šå¤©æ‰æ˜¾ç¤º
                if (d >= today) {
                    html += `<div class="mem-item"><div class="mem-header">ğŸ“Œ ${d}</div><div class="mem-text">${data[d]}</div></div>`;
                    count++;
                }
            });
            container.innerHTML = html || '<div class="empty-state">è¿‘æœŸæ— æ—¥ç¨‹</div>';
            return;
        }

        // 4. é€šç”¨ KV æ¸²æŸ“ (Long, Schedule)
        if(CONFIG[key].method === 'renderKV') {
            const sortedKeys = Object.keys(data).sort().reverse();
            let html = '';
            sortedKeys.forEach(k => {
                html += `<div class="mem-item"><div class="mem-header">ğŸ“Œ ${k}</div><div class="mem-text">${data[k]}</div></div>`;
            });
            container.innerHTML = html;
            return;
        }

        // 5. Relation æ¸²æŸ“
        if(key === 'relation') {
            let html = '';
            Object.keys(data).forEach(name => {
                const info = data[name];
                html += `<div class="mem-item"><div class="mem-header">ğŸ‘¤ ${name} [${info.role}]</div><div class="mem-text">${info.description}</div></div>`;
            });
            container.innerHTML = html;
        }
    }

    // ================= ç¼–è¾‘æ¨¡å¼é€»è¾‘ (Edit Mode) =================

    function toggleEdit(btn) {
        const module = btn.closest('.module');
        const key = module.id.replace('module-', '');
        const editBox = module.querySelector('.edit-mode');

        module.classList.add('editing');

        // ã€Fixã€‘åŸæ¥çš„ module.closest('details') æ˜¯é”™çš„ï¼Œå› ä¸º details åœ¨ module é‡Œé¢
        // æˆ‘ä»¬ç›´æ¥è®©å½“å‰æ¨¡å—å†…éƒ¨çš„ details å±•å¼€å³å¯
        const detailsEl = module.querySelector('details');
        if(detailsEl) detailsEl.open = true;

        // æ ¹æ®ç±»å‹ç”Ÿæˆç¼–è¾‘å™¨
        buildEditor(key, editBox);
    }

    function cancelEdit(btn) {
        const module = btn.closest('.module');
        module.classList.remove('editing');
    }

    function buildEditor(key, container) {
        const data = GLOBAL_DATA[key];
        container.innerHTML = ''; // æ¸…ç©º

        // 1. Markdown ç¼–è¾‘å™¨
        if(CONFIG[key].method === 'renderMD') {
            container.innerHTML = `<textarea class="md-editor">${data || ''}</textarea>`;
            return;
        }

        // 2. Short ç¼–è¾‘å™¨ (ç‰¹æ®Šï¼šåªç¼–è¾‘æœ€è¿‘ä¸€å¤©ï¼Œæˆ–è€…æä¾›æ·»åŠ æ–°æ—¥æœŸçš„èƒ½åŠ›ï¼Ÿä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬ç¼–è¾‘â€œå±•ç¤ºå‡ºæ¥çš„é‚£ä¸ªæ—¥æœŸâ€)
        if(key === 'short') {
            const dates = Object.keys(data).sort().reverse();
            // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œé»˜è®¤åˆ›å»ºä»Šå¤©
            const targetDate = dates.length > 0 ? dates[0] : new Date().toISOString().split('T')[0];
            const dayData = data[targetDate] || [];
            const events = Array.isArray(dayData) ? dayData : (dayData.events || []);

            // æ˜¾ç¤ºæ—¥æœŸæ ‡é¢˜
            container.innerHTML += `<div style="font-weight:bold; margin-bottom:10px; color:#ffb6b9;">ç¼–è¾‘æ—¥æœŸ: ${targetDate}</div>`;

            // éšè—åŸŸå­˜å‚¨å½“å‰ç¼–è¾‘çš„æ—¥æœŸ Key
            container.dataset.dateKey = targetDate;

            // ç”Ÿæˆäº‹ä»¶åˆ—è¡¨
            const listDiv = document.createElement('div');
            listDiv.className = 'edit-list';
            events.forEach(e => {
                listDiv.innerHTML += `
                  <div class="input-group">
                      <input type="text" class="input-key" value="${e.time}" placeholder="HH:MM">
                      <input type="text" class="input-val" value="${e.event}" placeholder="äº‹ä»¶å†…å®¹">
                      <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
                  </div>`;
            });
            container.appendChild(listDiv);
            container.innerHTML += `<button class="btn-add" onclick="addShortRow(this)">+ æ·»åŠ äº‹ä»¶</button>`;
            return;
        }

        // 3. é€šç”¨ KV ç¼–è¾‘å™¨ (Medium, Long, Schedule)
        if(CONFIG[key].method === 'renderKV') {
            // è¿™é‡Œçš„ç­–ç•¥ï¼šè™½ç„¶ view åªæ˜¾ç¤º7å¤©ï¼Œä½† edit åº”è¯¥å…è®¸ç¼–è¾‘æ‰€æœ‰ï¼Œæˆ–è€…è‡³å°‘æ˜¾ç¤ºæ‰€æœ‰
            // ä¸ºäº†é˜²æ­¢æ•°æ®ä¸¢å¤±ï¼Œæˆ‘ä»¬åˆ—å‡ºæ‰€æœ‰ Key
            const sortedKeys = Object.keys(data).sort().reverse();
            const listDiv = document.createElement('div');
            sortedKeys.forEach(k => {
                listDiv.innerHTML += `
                  <div class="input-group">
                      <input type="text" class="input-key" value="${k}" placeholder="Key/Date">
                      <textarea class="input-val" rows="2">${data[k]}</textarea>
                      <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
                  </div>`;
            });
            container.appendChild(listDiv);
            container.innerHTML += `<button class="btn-add" onclick="addKVRow(this)">+ æ·»åŠ æ¡ç›®</button>`;
            return;
        }

        // 4. Relation ç¼–è¾‘å™¨
        if(key === 'relation') {
            const names = Object.keys(data);
            const listDiv = document.createElement('div');
            names.forEach(name => {
                const info = data[name];
                listDiv.innerHTML += `
                   <div class="rel-edit-card">
                       <div class="input-group">
                           <input type="text" class="input-key" value="${name}" placeholder="å§“å">
                           <input type="text" class="input-val" value="${info.role}" placeholder="å…³ç³»å®šä½">
                           <button class="btn-del" onclick="this.closest('.rel-edit-card').remove()">Ã—</button>
                       </div>
                       <textarea class="input-full" rows="2" placeholder="è¯¦ç»†æè¿°">${info.description}</textarea>
                   </div>`;
            });
            container.appendChild(listDiv);
            container.innerHTML += `<button class="btn-add" onclick="addRelRow(this)">+ æ·»åŠ è§’è‰²</button>`;
        }
    }

    // --- åŠ¨æ€æ·»åŠ è¡Œçš„è¾…åŠ©å‡½æ•° ---
    function addShortRow(btn) {
        const row = `<div class="input-group">
          <input type="text" class="input-key" value="" placeholder="HH:MM">
          <input type="text" class="input-val" value="" placeholder="äº‹ä»¶å†…å®¹">
          <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
      </div>`;
        btn.previousElementSibling.insertAdjacentHTML('beforeend', row);
    }

    function addKVRow(btn) {
        const row = `<div class="input-group">
          <input type="text" class="input-key" value="" placeholder="Key/Date">
          <textarea class="input-val" rows="2"></textarea>
          <button class="btn-del" onclick="this.parentElement.remove()">Ã—</button>
      </div>`;
        btn.previousElementSibling.insertAdjacentHTML('beforeend', row);
    }

    function addRelRow(btn) {
        const row = `<div class="rel-edit-card">
           <div class="input-group">
               <input type="text" class="input-key" value="" placeholder="å§“å">
               <input type="text" class="input-val" value="" placeholder="å…³ç³»å®šä½">
               <button class="btn-del" onclick="this.closest('.rel-edit-card').remove()">Ã—</button>
           </div>
           <textarea class="input-full" rows="2" placeholder="è¯¦ç»†æè¿°"></textarea>
       </div>`;
        btn.previousElementSibling.insertAdjacentHTML('beforeend', row);
    }

    // ================= ä¿å­˜é€»è¾‘ (Save) =================

    async function saveData(btn) {
        const module = btn.closest('.module');
        const key = module.id.replace('module-', '');
        const container = module.querySelector('.edit-mode');

        let newData = null;

        // 1. Markdown ä¿å­˜
        if(CONFIG[key].method === 'renderMD') {
            newData = container.querySelector('textarea').value;
        }

        // 2. Short ä¿å­˜ (ç‰¹æ®Šï¼šåªæ›´æ–°äº†é‚£ä¸€å¤©ï¼Œéœ€è¦åˆå¹¶å› GLOBAL_DATA)
        else if(key === 'short') {
            const dateKey = container.dataset.dateKey;
            const rows = container.querySelectorAll('.input-group');
            const newEvents = [];
            rows.forEach(row => {
                const t = row.querySelector('.input-key').value.trim();
                const v = row.querySelector('.input-val').value.trim();
                if(t && v) newEvents.push({time: t, event: v});
            });

            // è·å–åŸå§‹ç»“æ„ï¼Œä¿ç•™ last_id
            const originalDayData = GLOBAL_DATA[key][dateKey] || {};
            let lastId = 0;
            if(!Array.isArray(originalDayData)) lastId = originalDayData.last_id || 0;

            // æ„é€ æ–°çš„å…¨é‡æ•°æ®
            newData = { ...GLOBAL_DATA[key] }; // å¤åˆ¶æ—§æ•°æ®
            newData[dateKey] = {
                events: newEvents,
                last_id: lastId
            };
        }

        // 3. KV ä¿å­˜ (Medium, Long, Schedule)
        else if(CONFIG[key].method === 'renderKV') {
            newData = {};
            const rows = container.querySelectorAll('.input-group');
            rows.forEach(row => {
                const k = row.querySelector('.input-key').value.trim();
                const v = row.querySelector('.input-val').value.trim();
                if(k) newData[k] = v;
            });
        }

        // 4. Relation ä¿å­˜
        else if(key === 'relation') {
            newData = {};
            const cards = container.querySelectorAll('.rel-edit-card');
            cards.forEach(card => {
                const name = card.querySelector('.input-key').value.trim();
                const role = card.querySelector('.input-val').value.trim();
                const desc = card.querySelector('.input-full').value.trim();
                if(name) {
                    newData[name] = { role: role, description: desc };
                }
            });
        }

        // --- å‘é€ç»™åç«¯ ---
        btn.textContent = 'Saving...';
        try {
            const res = await fetch('/api/save_prompt', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ key: key, content: newData })
            });
            const result = await res.json();
            if(result.status === 'success') {
                // æ›´æ–°æœ¬åœ°ç¼“å­˜
                GLOBAL_DATA[key] = newData;
                // é‡æ–°æ¸²æŸ“è§†å›¾
                renderView(key, newData);
                // é€€å‡ºç¼–è¾‘æ¨¡å¼
                module.classList.remove('editing');
                btn.textContent = 'ä¿å­˜ / Save';
            } else {
                alert('ä¿å­˜å¤±è´¥: ' + result.message);
                btn.textContent = 'ä¿å­˜ / Save';
            }
        } catch(e) {
            alert('ç½‘ç»œé”™è¯¯');
            btn.textContent = 'ä¿å­˜ / Save';
        }
    }

</script>

</body>
</html>