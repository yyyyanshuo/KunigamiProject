<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººä¸­å¿ƒ</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#fff3f8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body {
      font-family: "Segoe UI", "PingFang SC", sans-serif;
      background: #f7f7f7; margin: 0; padding: 0 0 80px 0;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .header {
      background: #fff; padding: 40px 20px 20px;
      text-align: center; border-bottom: 1px solid #eee;
    }
    .avatar-large {
      width: 80px; height: 80px; border-radius: 50%;
      background: #eee; margin: 0 auto 10px;
      border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .username { font-size: 18px; font-weight: bold; color: #333; }

    /* æ¨¡å—é€šç”¨æ ·å¼ */
    .section-container { margin: 20px 0; }

    .section-header {
      padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: center;
    }
    .section-title { font-size: 13px; color: #888; font-weight: bold; }

    .btn-edit-toggle {
      color: #2196f3; font-size: 13px; background: none; border: none;
      cursor: pointer; font-weight: bold; padding: 5px;
    }

    .config-card {
      background: #fff; border-top: 1px solid #eee; border-bottom: 1px solid #eee;
      padding: 15px 20px; position: relative;
    }

    /* --- ä¸¤ç§æ¨¡å¼çš„æ ·å¼ --- */

    /* 1. æŸ¥çœ‹æ¨¡å¼ (View Mode) */
    .view-box {
      font-size: 14px; line-height: 1.6; color: #444;
      white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
      min-height: 20px;
    }

    /* 2. ç¼–è¾‘æ¨¡å¼ (Edit Mode) */
    .edit-box { display: none; } /* é»˜è®¤éšè— */

    .editor-area {
      width: 100%; min-height: 150px; padding: 10px;
      border: 1px solid #ddd; border-radius: 8px; outline: none;
      font-size: 14px; line-height: 1.6; font-family: monospace;
      resize: vertical; box-sizing: border-box; color: #333; background: #fafafa;
    }

    .action-bar {
      margin-top: 10px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;
    }

    .btn {
      padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: bold; border: none;
    }
    .btn-cancel { background: #f5f5f5; color: #666; }
    .btn-save { background: #ffb6b9; color: #fff; }

    /* --- çŠ¶æ€åˆ‡æ¢ç±» --- */
    .editing .view-box { display: none; }
    .editing .edit-box { display: block; }
    .editing .btn-edit-toggle { display: none; } /* ç¼–è¾‘æ—¶éšè—å³ä¸Šè§’ç¼–è¾‘æŒ‰é’® */

    .empty-tip { color: #ccc; font-style: italic; }

  </style>
</head>
<body>

<div class="header">
  <!-- ã€ä¿®æ”¹ã€‘å¤´åƒç‚¹å‡»ä¸Šä¼ åŒºåŸŸ -->
  <div style="position: relative; display: inline-block; cursor: pointer;" onclick="document.getElementById('user-avatar-input').click()">

    <!-- å¤´åƒå›¾ç‰‡ -->
    <img id="user-avatar-img" src="/static/avatar_user.png" class="avatar-large" style="transition: opacity 0.3s;">

    <!-- å³ä¸‹è§’çš„å°ç›¸æœºå›¾æ ‡ -->
    <div style="position: absolute; bottom: 10px; right: 0; background: #ffb6b9; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border: 2px solid #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
      <svg viewBox="0 0 24 24" style="width:16px; height:16px; fill:currentColor;"><path d="M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z"/></svg>
    </div>

    <!-- éšè—çš„æ–‡ä»¶è¾“å…¥æ¡† -->
    <input type="file" id="user-avatar-input" accept="image/*" style="display: none;" onchange="uploadUserAvatar(this)">
  </div>

  <!-- å¤´åƒéƒ¨åˆ†ä¿æŒä¸å˜ -->

  <!-- ã€ä¿®æ”¹ã€‘ç”¨æˆ·ååŒºåŸŸ -->
  <div style="margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 8px;">
    <input type="text" id="current-username-input" value="åŠ è½½ä¸­..."
           style="font-size: 18px; font-weight: bold; color: #333; text-align: center; border: none; background: transparent; border-bottom: 1px dashed #ccc; width: 150px;"
           onfocus="this.style.borderBottom='1px solid #ffb6b9'"
           onblur="saveUserName(this)">

    <!-- ä¸€ä¸ªå°å°çš„ç¼–è¾‘å›¾æ ‡æç¤º -->
    <svg viewBox="0 0 24 24" style="width:16px; height:16px; color:#aaa; cursor:pointer;" onclick="document.getElementById('current-username-input').focus()">
      <path fill="currentColor" d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
    </svg>
  </div>

  <!-- è¯­è¨€é€‰æ‹© -->
  <div style="margin-top: 15px; text-align: center;">
    <label style="font-size: 12px; color: #999; margin-right: 5px;">AI è¯­è¨€ / Language:</label>
    <select id="ai-lang-select" onchange="saveAiLanguage(this)" style="padding: 4px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px; color: #555;">
      <option value="ja">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª (é»˜è®¤)</option>
      <option value="zh">ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (Chinese)</option>
    </select>
  </div>
</div>

<!-- æ¨¡å— 1: ç”¨æˆ·è®¾å®š -->
<div class="section-container" id="container-user">
  <div class="section-header">
    <div class="section-title">ğŸ‘¤ å…¨å±€ç”¨æˆ·è®¾å®š (Global User Persona)</div>
    <button class="btn-edit-toggle" onclick="enterEdit('user')">ç¼–è¾‘ / Edit</button>
  </div>

  <div class="config-card">
    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <div class="view-box" id="view-user"><span class="empty-tip">åŠ è½½ä¸­...</span></div>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <div class="edit-box">
      <textarea id="input-user" class="editor-area"></textarea>
      <div class="action-bar">
        <button class="btn btn-cancel" onclick="cancelEdit('user')">å–æ¶ˆ</button>
        <button class="btn btn-save" onclick="saveConfig('user')">ä¿å­˜è®¾å®š</button>
      </div>
    </div>
  </div>
</div>

<!-- æ¨¡å— 2: ç³»ç»Ÿè§„åˆ™ -->
<div class="section-container" id="container-format">
  <div class="section-header">
    <div class="section-title">âš–ï¸ å…¨å±€ç³»ç»Ÿè§„åˆ™ (Global System Rules)</div>
    <button class="btn-edit-toggle" onclick="enterEdit('format')">ç¼–è¾‘ / Edit</button>
  </div>

  <div class="config-card">
    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <div class="view-box" id="view-format"><span class="empty-tip">åŠ è½½ä¸­...</span></div>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <div class="edit-box">
      <textarea id="input-format" class="editor-area"></textarea>
      <div class="action-bar">
        <button class="btn btn-cancel" onclick="cancelEdit('format')">å–æ¶ˆ</button>
        <button class="btn btn-save" onclick="saveConfig('format')">ä¿å­˜è§„åˆ™</button>
      </div>
    </div>
  </div>
</div>

<!-- ã€é‡æ„ç‰ˆã€‘API çº¿è·¯ä¸æ¨¡å‹è®¾ç½® -->
<div class="section-title">ğŸ”Œ çº¿è·¯ä¸æ¨¡å‹è®¾ç½® (API Settings)</div>

<div class="module" id="module-api">
  <div class="config-card">

    <!-- 1. æŸ¥çœ‹æ¨¡å¼ (View Mode) -->
    <div class="view-mode" id="api-view-mode" style="padding: 10px;">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
        <div style="font-weight:bold; color:#555;">å½“å‰çŠ¶æ€</div>
        <button class="btn-edit-toggle" onclick="toggleApiEdit(true)">ç¼–è¾‘é…ç½® / Edit</button>
      </div>

      <!-- å±•ç¤ºå½“å‰é€‰ä¸­çš„å†…å®¹ -->
      <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <div>
          <div style="font-size:12px; color:#999;">å½“å‰çº¿è·¯</div>
          <div id="view-route-name" style="font-weight:bold; color:#d81b60; font-size:15px;">-</div>
        </div>
        <div>
          <div style="font-size:12px; color:#999;">èŠå¤©æ¨¡å‹</div>
          <div id="view-chat-model" style="font-family:monospace; background:#f0f0f0; padding:2px 6px; border-radius:4px; display:inline-block;">-</div>
        </div>
        <div>
          <div style="font-size:12px; color:#999;">è®°å¿†æ€»ç»“æ¨¡å‹</div>
          <div id="view-summary-model" style="font-family:monospace; background:#f0f0f0; padding:2px 6px; border-radius:4px; display:inline-block;">-</div>
        </div>
        <div>
          <div style="font-size:12px; color:#999;">äººè®¾ç”Ÿæˆæ¨¡å‹</div>
          <div id="view-gen-model" style="font-family:monospace; background:#f0f0f0; padding:2px 6px; border-radius:4px; display:inline-block;">-</div>
        </div>
      </div>
    </div>

    <!-- 2. ç¼–è¾‘æ¨¡å¼ (Edit Mode) -->
    <div class="edit-mode" id="api-edit-mode" style="display:none; padding: 10px;">

      <!-- A. çº¿è·¯é€‰æ‹© -->
      <div style="margin-bottom: 20px;">
        <div style="font-size:13px; color:#888; margin-bottom:8px; font-weight:bold;">1. é€‰æ‹©çº¿è·¯ Route</div>
        <div style="display:flex; gap:10px;">
          <label class="radio-card" onclick="selectRoute('gemini')">
            <input type="radio" name="route" value="gemini" id="radio-gemini">
            <span>çº¿è·¯ä¸€ï¼šGemini ç›´è¿</span>
          </label>
          <label class="radio-card" onclick="selectRoute('relay')">
            <input type="radio" name="route" value="relay" id="radio-relay">
            <span>çº¿è·¯äºŒï¼šå›½å†…ä¸­è½¬</span>
          </label>
        </div>
      </div>

      <!-- B. æ¨¡å‹é€‰æ‹© (ä¸‹æ‹‰æ¡†) -->
      <div id="model-settings" style="margin-bottom: 20px;">
        <div style="font-size:13px; color:#888; margin-bottom:8px; font-weight:bold;">2. é€‰æ‹©æ¨¡å‹ Select Models</div>
        <div style="display:grid; grid-template-columns: 1fr; gap:10px;">
          <div>
            <div class="input-label">èŠå¤© (Chat)</div>
            <select id="model-chat" class="model-select"></select>
          </div>
          <div>
            <div class="input-label">è®°å¿†æ€»ç»“ (Summary)</div>
            <select id="model-summary" class="model-select"></select>
          </div>
          <div>
            <div class="input-label">äººè®¾ç”Ÿæˆ (Persona)</div>
            <select id="model-gen" class="model-select"></select>
          </div>
        </div>
      </div>

      <hr style="border:0; border-top:1px dashed #eee; margin:20px 0;">

      <!-- C. æ¨¡å‹åˆ—è¡¨ç®¡ç† (æ·»åŠ /åˆ é™¤) -->
      <div style="margin-bottom: 20px;">
        <div style="font-size:13px; color:#888; margin-bottom:8px; font-weight:bold;">
          3. ç®¡ç†åˆ—è¡¨ (è‡ªå®šä¹‰æ·»åŠ æ¨¡å‹)
          <span id="manage-route-name" style="font-weight:normal; color:#ffb6b9; margin-left:5px;">-</span>
        </div>

        <!-- æ ‡ç­¾åˆ—è¡¨ -->
        <div id="model-tags-list" style="display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px;"></div>

        <!-- æ·»åŠ æ¡† -->
        <div style="display:flex; gap:8px;">
          <input type="text" id="new-model-input" placeholder="è¾“å…¥æ¨¡å‹ID (å¦‚ gpt-4o)" class="model-select" style="flex:1;">
          <button class="btn" style="background:#e3f2fd; color:#1565c0; padding:8px 15px; border:none; border-radius:6px; cursor:pointer;" onclick="addNewModel()">+ æ·»åŠ </button>
        </div>
      </div>

      <!-- æ“ä½œæŒ‰é’® -->
      <div class="action-bar">
        <button class="btn btn-cancel" onclick="toggleApiEdit(false)">å–æ¶ˆ / Cancel</button>
        <button class="btn btn-save" onclick="saveApiConfig()">ä¿å­˜é…ç½® / Save Config</button>
      </div>

    </div>
  </div>
</div>

<style>
  /* é…å¥—æ ·å¼ */
  .radio-card {
    flex: 1; border: 1px solid #ddd; padding: 10px; border-radius: 8px;
    cursor: pointer; text-align: center; font-size: 13px; color: #555;
    background: #fafafa; transition: all 0.2s;
  }
  .radio-card:has(input:checked) {
    border-color: #ffb6b9; background: #fff0f2; color: #d81b60; font-weight: bold;
  }
  .radio-card input { display: none; }

  .model-select {
    width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 6px;
    font-size: 12px; background: #fff;
  }
  .input-label { font-size: 11px; color: #999; margin-bottom: 4px; }
</style>

<!-- ã€æ–°å¢ã€‘API æ¶ˆè€—æ—¥å¿—é¢æ¿ -->
<div class="section-title">ğŸ“Š ç³»ç»Ÿè°ƒç”¨æ—¥å¿— (API Usage Logs)</div>
<div class="config-card" style="padding: 0; overflow: hidden; margin-bottom: 80px;">
  <div style="max-height: 300px; overflow-y: auto;">
    <table style="width: 100%; border-collapse: collapse; font-size: 12px; font-family: monospace;">
      <thead style="background: #f8f9fa; color: #666; position: sticky; top: 0;">
      <tr>
        <th style="padding: 10px; text-align: left;">æ—¶é—´</th>
        <th style="padding: 10px; text-align: left;">è§’è‰²</th>
        <th style="padding: 10px; text-align: right;">Input</th>
        <th style="padding: 10px; text-align: right;">Output</th>
        <th style="padding: 10px; text-align: right;">Total</th>
      </tr>
      </thead>
      <tbody id="usage-log-body">
      <tr><td colspan="5" style="text-align:center; padding:20px; color:#ccc;">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- å¼•å…¥åº•éƒ¨å¯¼èˆªæ  -->
{% include 'tabbar.html' %}

<script>
  // ç¼“å­˜æ•°æ®
  let cacheData = {
    user: '',
    format: ''
  };

  // 1. åŠ è½½æ‰€æœ‰é…ç½® (åˆå¹¶è°ƒç”¨)
  async function loadConfigs() {
    try {
      // --- A. åŠ è½½å…¨å±€äººè®¾ & æ ¼å¼ (åŸæœ‰çš„é€»è¾‘) ---
      const resConfig = await fetch('/api/global_config');
      const dataConfig = await resConfig.json();

      // æ›´æ–°ç¼“å­˜
      cacheData.user = dataConfig.user_persona || '';
      cacheData.format = dataConfig.system_format || '';

      // æ¸²æŸ“é¡µé¢
      renderUI('user');
      renderUI('format');

      // --- B. ã€æ–°å¢ã€‘åŠ è½½å½“å‰ç”¨æˆ·å ---
      const resUser = await fetch('/api/user/profile_settings');
      const dataUser = await resUser.json();

      // æ‰¾åˆ°é‚£ä¸ªé¡¶éƒ¨è¾“å…¥æ¡†å¹¶å¡«å€¼
      const nameInput = document.getElementById('current-username-input');
      if (nameInput) {
        nameInput.value = dataUser.name || 'User';
      }

      // ã€æ–°å¢ã€‘è®¾ç½®è¯­è¨€ä¸‹æ‹‰æ¡†çš„å€¼
      const langSelect = document.getElementById('ai-lang-select');
      if (langSelect) langSelect.value = dataUser.ai_language || 'ja';

    } catch(e) {
      console.error("é…ç½®åŠ è½½å¤±è´¥", e);
      // alert('é…ç½®åŠ è½½å¤±è´¥'); // å»ºè®®æ³¨é‡Šæ‰ï¼Œé˜²æ­¢ä¸€ä¸ªæ¥å£å¤±è´¥å¯¼è‡´ä¸€ç›´å¼¹çª—
    }
  }

  // 2. ã€æ–°å¢ã€‘ä¿å­˜ç”¨æˆ·å (å¤±å»ç„¦ç‚¹æ—¶è§¦å‘)
  async function saveUserName(input) {
    const newName = input.value.trim();
    if (!newName) return; // å¦‚æœä¸ºç©ºå°±ä¸ä¿å­˜

    try {
      const res = await fetch('/api/user/profile_settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name: newName })
      });
      const result = await res.json();

      if (result.status === 'success') {
        // è§†è§‰åé¦ˆï¼šè¾¹æ¡†å˜ç»¿é—ªçƒä¸€ä¸‹ï¼Œæç¤ºä¿å­˜æˆåŠŸ
        input.style.borderBottom = '2px solid #4cd964';
        setTimeout(() => {
          input.style.borderBottom = '1px dashed #ccc'; // æ¢å¤åŸæ ·
        }, 1000);
      } else {
        alert("ä¿®æ”¹å¤±è´¥: " + result.error);
      }
    } catch(e) {
      alert("ç½‘ç»œé”™è¯¯ï¼Œæ— æ³•ä¿å­˜ç”¨æˆ·å");
    }
  }

  // --- ã€æ–°å¢ã€‘ä¸Šä¼ ç”¨æˆ·å¤´åƒ ---
  async function uploadUserAvatar(input) {
    const file = input.files[0];
    if (!file) return;

    // 1. æœ¬åœ°é¢„è§ˆ (è®©ç”¨æˆ·ç«‹åˆ»çœ‹åˆ°å˜åŒ–)
    const reader = new FileReader();
    reader.onload = function(e) {
      document.getElementById('user-avatar-img').src = e.target.result;
    };
    reader.readAsDataURL(file);

    // 2. ä¸Šä¼ åˆ°æœåŠ¡å™¨
    const formData = new FormData();
    formData.append('file', file);

    const imgEl = document.getElementById('user-avatar-img');
    // å˜åŠé€æ˜æç¤ºæ­£åœ¨ä¸Šä¼ 
    imgEl.style.opacity = '0.5';

    try {
      const res = await fetch('/api/upload_user_avatar', {
        method: 'POST',
        body: formData
      });
      const result = await res.json();

      if (result.status === 'success') {
        // æˆåŠŸåï¼Œæ›´æ–° src (å¸¦æ—¶é—´æˆ³)ï¼Œç¡®ä¿ä¸‹æ¬¡åˆ·æ–°ä¹Ÿæ˜¯æ–°çš„
        imgEl.src = result.url;
        // alert('å¤´åƒæ›´æ–°æˆåŠŸï¼'); // å¯é€‰ï¼šä¸å–œæ¬¢å¼¹çª—å¯ä»¥å»æ‰
      } else {
        alert('ä¸Šä¼ å¤±è´¥: ' + result.error);
      }
    } catch (e) {
      alert('ç½‘ç»œé”™è¯¯');
    } finally {
      imgEl.style.opacity = '1';
      // æ¸…ç©º inputï¼Œé˜²æ­¢é€‰åŒä¸€å¼ å›¾ä¸è§¦å‘ onchange
      input.value = '';
    }
  }

  // 2. æ¸²æŸ“ UI (æŠŠç¼“å­˜æ•°æ®æ˜¾ç¤ºå‡ºæ¥)
  function renderUI(type) {
    const content = cacheData[type];
    // æ›´æ–°æŸ¥çœ‹æ¡†
    const viewEl = document.getElementById(`view-${type}`);
    viewEl.textContent = content || '(æš‚æ— å†…å®¹)';
    if(!content) viewEl.classList.add('empty-tip');
    else viewEl.classList.remove('empty-tip');

    // æ›´æ–°è¾“å…¥æ¡† (ä¿æŒåŒæ­¥)
    document.getElementById(`input-${type}`).value = content;
  }

  // 3. è¿›å…¥ç¼–è¾‘æ¨¡å¼
  function enterEdit(type) {
    document.getElementById(`container-${type}`).classList.add('editing');
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById(`input-${type}`).focus();
  }

  // 4. å–æ¶ˆç¼–è¾‘ (è¿˜åŸæ•°æ®)
  function cancelEdit(type) {
    document.getElementById(`container-${type}`).classList.remove('editing');
    // é‡ç½®è¾“å…¥æ¡†å†…å®¹ä¸ºç¼“å­˜å†…å®¹
    document.getElementById(`input-${type}`).value = cacheData[type];
  }

  // 5. ä¿å­˜é…ç½®
  async function saveConfig(type) {
    const inputEl = document.getElementById(`input-${type}`);
    const content = inputEl.value;
    const btn = document.querySelector(`#container-${type} .btn-save`);

    // æ˜ å°„åç«¯ Key
    const apiKey = (type === 'user') ? 'user_persona' : 'system_format';

    const originalText = btn.textContent;
    btn.textContent = 'ä¿å­˜ä¸­...';
    btn.disabled = true;

    try {
      const res = await fetch('/api/save_global_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ key: apiKey, content: content })
      });
      const result = await res.json();

      if(result.status === 'success') {
        // æ›´æ–°ç¼“å­˜
        cacheData[type] = content;
        // é‡æ–°æ¸²æŸ“è§†å›¾
        renderUI(type);
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        document.getElementById(`container-${type}`).classList.remove('editing');
      } else {
        alert('ä¿å­˜å¤±è´¥: ' + result.error);
      }
    } catch(e) {
      alert('ç½‘ç»œé”™è¯¯');
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }

  // ã€æ–°å¢ã€‘ä¿å­˜è¯­è¨€è®¾ç½®
  async function saveAiLanguage(select) {
    const lang = select.value;
    try {
      const res = await fetch('/api/user/profile_settings', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ ai_language: lang })
      });
      if(res.ok) {
        // ç»™ä¸ªå¾®å°çš„è§†è§‰åé¦ˆ
        select.style.borderColor = '#4cd964';
        setTimeout(() => select.style.borderColor = '#ddd', 1000);
      }
    } catch(e) { alert('è®¾ç½®ä¿å­˜å¤±è´¥'); }
  }

  // åˆå§‹åŒ–
  loadConfigs();

  // ã€æ–°å¢ã€‘åŠ è½½æ—¥å¿—å‡½æ•°
  async function loadUsageLogs() {
    try {
      const res = await fetch('/api/usage_logs');
      const logs = await res.json();

      const tbody = document.getElementById('usage-log-body');
      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#ccc;">æš‚æ— è°ƒç”¨è®°å½•</td></tr>';
        return;
      }

      let html = '';
      logs.forEach(log => {
        // ç»™ Total åŠ ä¸ªé¢œè‰²ï¼Œæ¶ˆè€—è¶Šå¤šè¶Šçº¢
        let color = '#444';
        if(log.total > 2000) color = '#e65100'; // æ©™è‰²
        if(log.total > 5000) color = '#c62828'; // çº¢è‰²

        html += `
              <tr style="border-bottom: 1px solid #eee;">
                  <td style="padding: 8px 10px; color: #888;">${log.time.split(' ')[1]}</td> <!-- åªæ˜¾ç¤ºæ—¶åˆ†ç§’ -->
                  <td style="padding: 8px 10px; font-weight:bold;">${log.char_id}</td>
                  <td style="padding: 8px 10px; text-align: right; color: #1565c0;">${log.input}</td>
                  <td style="padding: 8px 10px; text-align: right; color: #2e7d32;">${log.output}</td>
                  <td style="padding: 8px 10px; text-align: right; font-weight: bold; color: ${color};">${log.total}</td>
              </tr>`;
      });
      tbody.innerHTML = html;
    } catch(e) { console.error("æ—¥å¿—åŠ è½½å¤±è´¥", e); }
  }

  // åˆå§‹åŒ–æ—¶è°ƒç”¨
  loadUsageLogs();

  // --- å…¨å±€é…ç½®ç¼“å­˜ ---
  let apiConfig = {};

  // 1. åŠ è½½é…ç½®å¹¶åˆå§‹åŒ–
  async function loadApiConfig() {
    try {
      const res = await fetch('/api/system_config');
      apiConfig = await res.json();

      // å®¹é”™åˆå§‹åŒ–
      if (!apiConfig.model_options) {
        apiConfig.model_options = { 'gemini': [], 'relay': [] };
      }

      // æ¸²æŸ“æŸ¥çœ‹æ¨¡å¼
      renderApiView();

      // é¢„æ¸²æŸ“ç¼–è¾‘æ¨¡å¼ (ä½†ä¸æ˜¾ç¤º)
      const active = apiConfig.active_route;
      document.getElementById(`radio-${active}`).checked = true;
      refreshEditUI(active);

    } catch(e) { console.error("APIé…ç½®åŠ è½½å¤±è´¥", e); }
  }

  // 2. æ¸²æŸ“æŸ¥çœ‹æ¨¡å¼ (View Mode)
  function renderApiView() {
    const route = apiConfig.active_route;
    const routeName = (route === 'gemini') ? 'Gemini ç›´è¿' : 'å›½å†…ä¸­è½¬';
    const models = apiConfig.routes[route].models;

    document.getElementById('view-route-name').textContent = routeName;
    document.getElementById('view-chat-model').textContent = models.chat;
    document.getElementById('view-summary-model').textContent = models.summary;
    document.getElementById('view-gen-model').textContent = models.gen_persona;
  }

  // 3. åˆ‡æ¢ç¼–è¾‘çŠ¶æ€
  function toggleApiEdit(isEditing) {
    const viewMode = document.getElementById('api-view-mode');
    const editMode = document.getElementById('api-edit-mode');

    if (isEditing) {
      viewMode.style.display = 'none';
      editMode.style.display = 'block';
      // è¿›å…¥ç¼–è¾‘æ—¶ï¼Œé‡ç½®ä¸ºå½“å‰ç”Ÿæ•ˆçš„é…ç½®
      const active = apiConfig.active_route;
      document.getElementById(`radio-${active}`).click(); // è§¦å‘ç‚¹å‡»æ¥åˆ·æ–°UI
    } else {
      viewMode.style.display = 'block';
      editMode.style.display = 'none';
    }
  }

  // 4. ç¼–è¾‘æ¨¡å¼ï¼šåˆ‡æ¢çº¿è·¯è§¦å‘
  function selectRoute(route) {
    refreshEditUI(route);
  }

  // 5. åˆ·æ–°ç¼–è¾‘ç•Œé¢ UI (ä¸‹æ‹‰æ¡† + æ ‡ç­¾åˆ—è¡¨)
  function refreshEditUI(route) {
    // æ›´æ–°æ ‡é¢˜
    document.getElementById('manage-route-name').textContent = (route === 'gemini') ? '[Gemini]' : '[ä¸­è½¬]';

    // A. æ¸²æŸ“ä¸‹æ‹‰æ¡†é€‰é¡¹
    const options = apiConfig.model_options[route] || [];
    // å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œç»™ä¸ªæç¤º
    const optionsHtml = options.length > 0
            ? options.map(m => `<option value="${m}">${m}</option>`).join('')
            : '<option value="">(æš‚æ— æ¨¡å‹ï¼Œè¯·åœ¨ä¸‹æ–¹æ·»åŠ )</option>';

    document.getElementById('model-chat').innerHTML = optionsHtml;
    document.getElementById('model-summary').innerHTML = optionsHtml;
    document.getElementById('model-gen').innerHTML = optionsHtml;

    // B. é€‰ä¸­å½“å‰(æˆ–é»˜è®¤)å€¼
    // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬ä¼˜å…ˆæ˜¾ç¤ºé…ç½®æ–‡ä»¶é‡Œå­˜çš„å€¼ã€‚å¦‚æœé‚£ä¸ªå€¼ä¸åœ¨åˆ—è¡¨é‡Œäº†(è¢«åˆ äº†)ï¼Œå°±é€‰åˆ—è¡¨ç¬¬ä¸€ä¸ªã€‚
    const savedModels = apiConfig.routes[route].models;

    setSelectValue('model-chat', savedModels.chat);
    setSelectValue('model-summary', savedModels.summary);
    setSelectValue('model-gen', savedModels.gen_persona);

    // C. æ¸²æŸ“ç®¡ç†æ ‡ç­¾åˆ—è¡¨
    const listEl = document.getElementById('model-tags-list');
    let tagsHtml = '';
    options.forEach(m => {
      tagsHtml += `
          <div style="background:#fff; border:1px solid #ddd; border-radius:4px; padding:4px 8px; font-size:12px; display:flex; align-items:center; gap:6px;">
              <span>${m}</span>
              <span onclick="deleteModel('${m}')" style="cursor:pointer; color:#c62828; font-weight:bold;">Ã—</span>
          </div>`;
    });
    listEl.innerHTML = tagsHtml;
  }

  // è¾…åŠ©ï¼šè®¾ç½®ä¸‹æ‹‰æ¡†çš„å€¼ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™é€‰ç¬¬ä¸€ä¸ª
  function setSelectValue(id, value) {
    const select = document.getElementById(id);
    // å°è¯•è®¾ç½®
    select.value = value;
    // å¦‚æœè®¾ç½®å¤±è´¥(valueä¸åœ¨optionsé‡Œ)ï¼Œselect.value ä¼šæ˜¯ç©ºæˆ–è€…ç¬¬ä¸€ä¸ªï¼Œ
    // è¿™é‡Œæˆ‘ä»¬å¯ä»¥å¼ºåˆ¶è®¾ä¸ºç¬¬ä¸€ä¸ªæœ‰æ•ˆå€¼ï¼Œæˆ–è€…ä¿ç•™ç©º
    if (select.selectedIndex === -1 && select.options.length > 0) {
      select.selectedIndex = 0;
    }
  }

  // 6. æ·»åŠ æ–°æ¨¡å‹
  function addNewModel() {
    const input = document.getElementById('new-model-input');
    const newVal = input.value.trim();
    if (!newVal) return;

    const currentRoute = document.querySelector('input[name="route"]:checked').value;

    if (!apiConfig.model_options[currentRoute]) apiConfig.model_options[currentRoute] = [];

    if (!apiConfig.model_options[currentRoute].includes(newVal)) {
      apiConfig.model_options[currentRoute].push(newVal);

      // åˆ·æ–° UI
      refreshEditUI(currentRoute);

      // è‡ªåŠ¨é€‰ä¸­æ–°åŠ çš„æ¨¡å‹åˆ°ç¬¬ä¸€ä¸ªä¸‹æ‹‰æ¡†(æ–¹ä¾¿ç”¨æˆ·)
      // document.getElementById('model-chat').value = newVal;

      input.value = '';
    } else {
      alert('è¯¥æ¨¡å‹å·²å­˜åœ¨');
    }
  }

  // 7. åˆ é™¤æ¨¡å‹
  function deleteModel(val) {
    const currentRoute = document.querySelector('input[name="route"]:checked').value;
    if (confirm(`ç¡®å®šåˆ é™¤æ¨¡å‹ "${val}" å—ï¼Ÿ`)) {
      const list = apiConfig.model_options[currentRoute];
      const index = list.indexOf(val);
      if (index > -1) {
        list.splice(index, 1);
        refreshEditUI(currentRoute);
      }
    }
  }

  // 8. ä¿å­˜æœ€ç»ˆé…ç½®
  async function saveApiConfig() {
    const activeRoute = document.querySelector('input[name="route"]:checked').value;

    // æ›´æ–°å†…å­˜ä¸­çš„é…ç½®å¯¹è±¡
    apiConfig.active_route = activeRoute;
    apiConfig.routes[activeRoute].models.chat = document.getElementById('model-chat').value;
    apiConfig.routes[activeRoute].models.summary = document.getElementById('model-summary').value;
    apiConfig.routes[activeRoute].models.gen_persona = document.getElementById('model-gen').value;

    const btn = document.querySelector('#module-api .btn-save');
    const originalText = btn.textContent;
    btn.textContent = 'ä¿å­˜ä¸­...';
    btn.disabled = true;

    try {
      const res = await fetch('/api/system_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(apiConfig)
      });
      if(res.ok) {
        // é‡æ–°æ¸²æŸ“æŸ¥çœ‹æ¨¡å¼
        renderApiView();
        toggleApiEdit(false);
        alert('API é…ç½®å·²æ›´æ–°ï¼');
      } else {
        alert('ä¿å­˜å¤±è´¥');
      }
    } catch(e) {
      alert('ç½‘ç»œé”™è¯¯');
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }

  // å¯åŠ¨åŠ è½½
  loadApiConfig();
  // loadConfigs(); // åˆ«å¿˜äº†ä¿ç•™åŸæ¥åŠ è½½ User/Format çš„å‡½æ•°è°ƒç”¨
</script>

</body>
</html>