<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä¸ªäººä¸­å¿ƒ</title>
  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#fff3f8">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    body {
      font-family: "Segoe UI", "PingFang SC", sans-serif;
      background: #f7f7f7; margin: 0; padding: 0 0 80px 0;
    }

    /* å¤´éƒ¨æ ·å¼ */
    .header {
      background: #fff; padding: 40px 20px 20px;
      text-align: center; border-bottom: 1px solid #eee;
    }
    .avatar-large {
      width: 80px; height: 80px; border-radius: 50%;
      background: #eee; margin: 0 auto 10px;
      border: 3px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .username { font-size: 18px; font-weight: bold; color: #333; }

    /* æ¨¡å—é€šç”¨æ ·å¼ */
    .section-container { margin: 20px 0; }

    .section-header {
      padding: 0 20px 10px; display: flex; justify-content: space-between; align-items: center;
    }
    .section-title { font-size: 13px; color: #888; font-weight: bold; }

    .btn-edit-toggle {
      color: #2196f3; font-size: 13px; background: none; border: none;
      cursor: pointer; font-weight: bold; padding: 5px;
    }

    .config-card {
      background: #fff; border-top: 1px solid #eee; border-bottom: 1px solid #eee;
      padding: 15px 20px; position: relative;
    }

    /* --- ä¸¤ç§æ¨¡å¼çš„æ ·å¼ --- */

    /* 1. æŸ¥çœ‹æ¨¡å¼ (View Mode) */
    .view-box {
      font-size: 14px; line-height: 1.6; color: #444;
      white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
      min-height: 20px;
    }

    /* 2. ç¼–è¾‘æ¨¡å¼ (Edit Mode) */
    .edit-box { display: none; } /* é»˜è®¤éšè— */

    .editor-area {
      width: 100%; min-height: 150px; padding: 10px;
      border: 1px solid #ddd; border-radius: 8px; outline: none;
      font-size: 14px; line-height: 1.6; font-family: monospace;
      resize: vertical; box-sizing: border-box; color: #333; background: #fafafa;
    }

    .action-bar {
      margin-top: 10px; text-align: right; display: flex; gap: 10px; justify-content: flex-end;
    }

    .btn {
      padding: 6px 16px; border-radius: 20px; font-size: 12px; cursor: pointer; font-weight: bold; border: none;
    }
    .btn-cancel { background: #f5f5f5; color: #666; }
    .btn-save { background: #ffb6b9; color: #fff; }

    /* --- çŠ¶æ€åˆ‡æ¢ç±» --- */
    .editing .view-box { display: none; }
    .editing .edit-box { display: block; }
    .editing .btn-edit-toggle { display: none; } /* ç¼–è¾‘æ—¶éšè—å³ä¸Šè§’ç¼–è¾‘æŒ‰é’® */

    .empty-tip { color: #ccc; font-style: italic; }

  </style>
</head>
<body>

<div class="header">
  <img src="/static/avatar_user.jpg" class="avatar-large">
  <div class="username">ç¯ åŸæ¡å¥ˆ</div>
</div>

<!-- æ¨¡å— 1: ç”¨æˆ·è®¾å®š -->
<div class="section-container" id="container-user">
  <div class="section-header">
    <div class="section-title">ğŸ‘¤ å…¨å±€ç”¨æˆ·è®¾å®š (Global User Persona)</div>
    <button class="btn-edit-toggle" onclick="enterEdit('user')">ç¼–è¾‘ / Edit</button>
  </div>

  <div class="config-card">
    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <div class="view-box" id="view-user"><span class="empty-tip">åŠ è½½ä¸­...</span></div>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <div class="edit-box">
      <textarea id="input-user" class="editor-area"></textarea>
      <div class="action-bar">
        <button class="btn btn-cancel" onclick="cancelEdit('user')">å–æ¶ˆ</button>
        <button class="btn btn-save" onclick="saveConfig('user')">ä¿å­˜è®¾å®š</button>
      </div>
    </div>
  </div>
</div>

<!-- æ¨¡å— 2: ç³»ç»Ÿè§„åˆ™ -->
<div class="section-container" id="container-format">
  <div class="section-header">
    <div class="section-title">âš–ï¸ å…¨å±€ç³»ç»Ÿè§„åˆ™ (Global System Rules)</div>
    <button class="btn-edit-toggle" onclick="enterEdit('format')">ç¼–è¾‘ / Edit</button>
  </div>

  <div class="config-card">
    <!-- æŸ¥çœ‹æ¨¡å¼ -->
    <div class="view-box" id="view-format"><span class="empty-tip">åŠ è½½ä¸­...</span></div>

    <!-- ç¼–è¾‘æ¨¡å¼ -->
    <div class="edit-box">
      <textarea id="input-format" class="editor-area"></textarea>
      <div class="action-bar">
        <button class="btn btn-cancel" onclick="cancelEdit('format')">å–æ¶ˆ</button>
        <button class="btn btn-save" onclick="saveConfig('format')">ä¿å­˜è§„åˆ™</button>
      </div>
    </div>
  </div>
</div>

<!-- å¼•å…¥åº•éƒ¨å¯¼èˆªæ  -->
{% include 'tabbar.html' %}

<script>
  // ç¼“å­˜æ•°æ®ï¼Œç”¨äºå–æ¶ˆç¼–è¾‘æ—¶æ¢å¤
  let cacheData = {
    user: '',
    format: ''
  };

  // 1. åŠ è½½é…ç½®
  async function loadConfigs() {
    try {
      const res = await fetch('/api/global_config');
      const data = await res.json();

      // æ›´æ–°ç¼“å­˜
      cacheData.user = data.user_persona || '';
      cacheData.format = data.system_format || '';

      // æ¸²æŸ“é¡µé¢
      renderUI('user');
      renderUI('format');

    } catch(e) {
      alert('é…ç½®åŠ è½½å¤±è´¥');
    }
  }

  // 2. æ¸²æŸ“ UI (æŠŠç¼“å­˜æ•°æ®æ˜¾ç¤ºå‡ºæ¥)
  function renderUI(type) {
    const content = cacheData[type];
    // æ›´æ–°æŸ¥çœ‹æ¡†
    const viewEl = document.getElementById(`view-${type}`);
    viewEl.textContent = content || '(æš‚æ— å†…å®¹)';
    if(!content) viewEl.classList.add('empty-tip');
    else viewEl.classList.remove('empty-tip');

    // æ›´æ–°è¾“å…¥æ¡† (ä¿æŒåŒæ­¥)
    document.getElementById(`input-${type}`).value = content;
  }

  // 3. è¿›å…¥ç¼–è¾‘æ¨¡å¼
  function enterEdit(type) {
    document.getElementById(`container-${type}`).classList.add('editing');
    // èšç„¦è¾“å…¥æ¡†
    document.getElementById(`input-${type}`).focus();
  }

  // 4. å–æ¶ˆç¼–è¾‘ (è¿˜åŸæ•°æ®)
  function cancelEdit(type) {
    document.getElementById(`container-${type}`).classList.remove('editing');
    // é‡ç½®è¾“å…¥æ¡†å†…å®¹ä¸ºç¼“å­˜å†…å®¹
    document.getElementById(`input-${type}`).value = cacheData[type];
  }

  // 5. ä¿å­˜é…ç½®
  async function saveConfig(type) {
    const inputEl = document.getElementById(`input-${type}`);
    const content = inputEl.value;
    const btn = document.querySelector(`#container-${type} .btn-save`);

    // æ˜ å°„åç«¯ Key
    const apiKey = (type === 'user') ? 'user_persona' : 'system_format';

    const originalText = btn.textContent;
    btn.textContent = 'ä¿å­˜ä¸­...';
    btn.disabled = true;

    try {
      const res = await fetch('/api/save_global_config', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ key: apiKey, content: content })
      });
      const result = await res.json();

      if(result.status === 'success') {
        // æ›´æ–°ç¼“å­˜
        cacheData[type] = content;
        // é‡æ–°æ¸²æŸ“è§†å›¾
        renderUI(type);
        // é€€å‡ºç¼–è¾‘æ¨¡å¼
        document.getElementById(`container-${type}`).classList.remove('editing');
      } else {
        alert('ä¿å­˜å¤±è´¥: ' + result.error);
      }
    } catch(e) {
      alert('ç½‘ç»œé”™è¯¯');
    } finally {
      btn.textContent = originalText;
      btn.disabled = false;
    }
  }

  // åˆå§‹åŒ–
  loadConfigs();
</script>

</body>
</html>