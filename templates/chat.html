<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ¡å¥ˆ âœ¿ Chat</title>
<!-- è¿™æ˜¯åœ¨ chat.html çš„ <head> æ ‡ç­¾å†… -->
<style>
  body {
    font-family: "Segoe UI", "PingFang SC", "Helvetica Neue", sans-serif;
    background: linear-gradient(135deg, #fff3f8 0%, #ffe9e1 100%);
    margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh;
  }
  .chat-container {
    flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; scroll-behavior: smooth;
  }

  /* 1. å¤–å±‚åŒ…è£… */
  .message-wrapper {
    display: flex; flex-direction: column; margin: 8px 0; max-width: 78%;
  }
  .message-wrapper.user { align-self: flex-end; }
  .message-wrapper.assistant { align-self: flex-start; }

  /* 2. æ°”æ³¡ */
  .bubble {
    padding: 12px 16px; border-radius: 16px; line-height: 1.5; word-wrap: break-word;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08); animation: fadeIn 0.3s ease;
  }
  .message-wrapper.user .bubble {
    background: linear-gradient(135deg, #ffb6b9, #ffc9c9); color: #fff;
    border-bottom-right-radius: 4px;
  }
  .message-wrapper.assistant .bubble {
    background: #fff; color: #444; border-bottom-left-radius: 4px; border: 1px solid #ffb6b9;
  }

  /* 3. å¤–éƒ¨æ§åˆ¶å®¹å™¨ */
  .controls-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
  }

  /* 4. äº¤å‰å¯¹é½ */
  .message-wrapper.user .controls-container { flex-direction: row; }
  .message-wrapper.assistant .controls-container { flex-direction: row-reverse; }

  /* 5. æ—¶é—´æˆ³å’Œå¤åˆ¶æŒ‰é’® */
  .timestamp {
    font-size: 11px;
    color: #aaa;
    padding: 0 5px;
  }
  .copy-btn {
    background: transparent; border: none; cursor: pointer;
    width: 26px; height: 26px; padding: 5px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
  }
  .copy-btn img {
    width: 14px; height: 14px; opacity: 0.5; transition: opacity 0.2s;
  }
  .copy-btn:hover img { opacity: 0.8; }
  .copy-btn.copied img { opacity: 1; }

  /* --- ã€æ–°å¢ã€‘æ—¥æœŸåˆ†éš”ç¬¦çš„æ ·å¼ --- */
  .date-separator {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    margin: 20px 0;     /* ä¸Šä¸‹ç•™å‡ºè¶³å¤Ÿçš„é—´è· */
    padding: 4px 12px;
    background-color: rgba(0, 0, 0, 0.05); /* ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-radius: 12px; /* åœ†è§’ */
    color: #aaa;         /* æŸ”å’Œçš„æ–‡å­—é¢œè‰² */
    font-size: 12px;
    font-weight: 500;
  }

  /* 6. å…¶ä»– */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  .input-container { display: flex; align-items: center; padding: 12px; border-top: 1px solid #ffdce0; background-color: #fff; }
  #messageInput { flex: 1; padding: 10px 14px; border: 1px solid #ffd1d1; border-radius: 20px; outline: none; font-size: 15px; background: #fff8f9; transition: border-color 0.2s; }
  #messageInput:focus { border-color: #ff9b9e; }
  #sendBtn { margin-left: 8px; background: linear-gradient(135deg, #ffb6b9, #ff9b73); color: white; border: none; border-radius: 20px; padding: 10px 18px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 6px rgba(255,140,140,0.3); transition: all 0.2s; }
  #sendBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255,140,140,0.4); }
</style>
</head>
<body>

<div class="chat-container" id="chatContainer">
  <div class="bubble assistant">
    âœ¿ ã“ã‚“ã«ã¡ã¯ï½ æˆ‘æ˜¯æ¡å¥ˆã®å°èŠå¤©åŠ©æ‰‹ ğŸ’Œ
  </div>
</div>

<div class="input-container">
  <input id="messageInput" type="text" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" />
  <button id="sendBtn">å‘é€</button>
</div>

<!-- è¿™æ˜¯åœ¨ chat.html çš„ <body> æ ‡ç­¾åº•éƒ¨ -->
<script>
  const chatContainer = document.getElementById('chatContainer');
  const input = document.getElementById('messageInput');
  const btn = document.getElementById('sendBtn');
  const copyIconPath = '/static/copy-icon.svg';
  const checkIconPath = '/static/check-icon.svg';

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  // å®Œæ•´çš„ appendBubble å‡½æ•°ï¼Œä»¥é˜²ä¸‡ä¸€
  function appendBubble(text, role, timestampStr = null, showControls = true) {
    const wrapper = document.createElement('div');
    wrapper.classList.add('message-wrapper', role);
    const bubble = document.createElement('div');
    bubble.classList.add('bubble');
    bubble.innerHTML = text.replace(/\n/g, "<br>");
    wrapper.appendChild(bubble);

    if (showControls) {
      const controls = document.createElement('div');
      controls.classList.add('controls-container');
      const timestamp = document.createElement('div');
      timestamp.classList.add('timestamp');
      if (timestampStr) {
        const date = new Date(timestampStr);
        timestamp.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      } else {
        const now = new Date();
        timestamp.textContent = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      }
      const copyBtn = document.createElement('button');
      copyBtn.classList.add('copy-btn');
      const icon = document.createElement('img');
      icon.src = copyIconPath;
      copyBtn.appendChild(icon);
      copyBtn.addEventListener('click', () => {
        const fullText = wrapper.dataset.fulltext || text;
        navigator.clipboard.writeText(fullText).then(() => {
          icon.src = checkIconPath;
          copyBtn.classList.add('copied');
          setTimeout(() => {
            icon.src = copyIconPath;
            copyBtn.classList.remove('copied');
          }, 1500);
        });
      });
      controls.appendChild(timestamp);
      controls.appendChild(copyBtn);
      wrapper.appendChild(controls);
    }

    chatContainer.appendChild(wrapper);
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  // --- æˆ‘ä»¬éœ€è¦ç¨å¾®å‡çº§ä¸€ä¸‹ displayBubbleGroup ---
  async function displayBubbleGroup(bubbleTexts, fullText, role, timestamp, isUserInput = false, isHistory = false) {
    for (const [index, text] of bubbleTexts.entries()) {
      const isLast = (index === bubbleTexts.length - 1);

      // ã€å…³é”®ã€‘å¦‚æœæ˜¯å†å²è®°å½•ï¼Œæˆ‘ä»¬ä¸å¸Œæœ›æœ‰ä»»ä½•å»¶è¿Ÿ
      if (!isHistory) {
          if (isUserInput && index > 0) {
            await sleep(600);
          } else if (!isUserInput) {
            let typingDelay = text.length * 200; // åŠ å¿«ä¸€ç‚¹å†å²æ„Ÿ
            typingDelay = Math.max(500, Math.min(typingDelay, 3000));
            await sleep(typingDelay);
          }
      }

      appendBubble(text, role, isLast ? timestamp : null, isLast);

      if (isLast) {
          const allWrappers = chatContainer.querySelectorAll('.message-wrapper');
          const lastWrapper = allWrappers[allWrappers.length - 1];
          if (lastWrapper) {
              lastWrapper.dataset.fulltext = fullText;
          }
      }
    }
  }

  // --- ã€æ ¸å¿ƒä¿®æ­£ã€‘åœ¨åŠ è½½å†å²æ—¶ï¼Œå¢åŠ æ—¥æœŸåˆ†éš”ç¬¦ ---
  window.addEventListener('DOMContentLoaded', async () => {
    chatContainer.innerHTML = '';
    try {
      const res = await fetch('/api/history');
      const history = await res.json();
      if (history.length === 0) {
        appendBubble('âœ¿ ã“ã‚“ã«ã¡ã¯ï½ æˆ‘æ˜¯æ¡å¥ˆã®å°èŠå¤©åŠ©æ‰‹ ğŸ’Œ', 'assistant');
      } else {
        // 1. æˆ‘ä»¬çš„â€œè®°å¿†â€å˜é‡ï¼Œåˆå§‹ä¸º null
        let lastMessageDate = null;

        // 2. ç”¨æœ‰åºçš„ for...of å¾ªç¯æ¥å¤„ç†å†å²
        for (const msg of history) {
          const currentMessageDate = new Date(msg.timestamp);

          // 3. æ¯”è¾ƒæ—¥æœŸæ˜¯å¦å˜åŒ–
          //    å¦‚æœè¿™æ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯(lastMessageDateä¸ºnull)ï¼Œæˆ–è€…å½“å‰æ—¥æœŸä¸ä¸Šä¸€æ¡ä¸åŒ
          if ( !lastMessageDate ||
               lastMessageDate.getDate() !== currentMessageDate.getDate() ||
               lastMessageDate.getMonth() !== currentMessageDate.getMonth() ||
               lastMessageDate.getFullYear() !== currentMessageDate.getFullYear() )
          {
            // 4. åˆ›å»ºå¹¶æ’å…¥æ—¥æœŸåˆ†éš”ç¬¦
            const separator = document.createElement('div');
            separator.classList.add('date-separator');
            // ä½¿ç”¨ toLocaleDateString æ¥æ˜¾ç¤ºä¸€ä¸ªæ¼‚äº®çš„ã€æœ¬åœ°åŒ–çš„æ—¥æœŸæ ¼å¼
            separator.textContent = currentMessageDate.toLocaleDateString([], {
              year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
            });
            chatContainer.appendChild(separator);
          }

          // 5. æ˜¾ç¤ºå½“å‰è¿™ç»„æ°”æ³¡ (æ— å»¶è¿Ÿï¼Œç¬é—´åŠ è½½)
          const bubbles = msg.content.split('/').map(p => p.trim()).filter(Boolean);
          await displayBubbleGroup(bubbles, msg.content, msg.role, currentMessageDate, false, true);

          // 6. æ›´æ–°â€œè®°å¿†â€ï¼Œä¸ºä¸‹ä¸€æ¬¡å¾ªç¯åšå‡†å¤‡
          lastMessageDate = currentMessageDate;
        }
      }
    } catch (e) {
      appendBubble('[å†å²è®°å½•åŠ è½½å¤±è´¥]', 'assistant');
    }
  });

  // --- ã€è¿™æ‰æ˜¯æœ€ç»ˆæ­£ç¡®çš„ sendMessage å‡½æ•°ï¼ã€‘ ---
  async function sendMessage() {
    const originalText = input.value.trim();
    if (!originalText) return;

    input.value = '';
    btn.disabled = true;
    btn.textContent = "å‘é€ä¸­â€¦";

    // æŠŠå‰§æœ¬äº¤ç»™ç”¨æˆ·ç»„çš„å¯¼æ¼”
    const userBubbles = originalText.split('/').map(p => p.trim()).filter(Boolean);
    await displayBubbleGroup(userBubbles, originalText, 'user', new Date(), true, false);

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: originalText})
      });
      const data = await res.json();

      // æŠŠå‰§æœ¬äº¤ç»™ AI ç»„çš„å¯¼æ¼”
      if (data.replies && data.replies.length > 0) {
        const fullReplyText = data.replies.join(' / ');
        await displayBubbleGroup(data.replies, fullReplyText, 'assistant', new Date(), false, false);
      } else {
        appendBubble(data.reply || '[æ— å›å¤]', 'assistant');
      }

    } catch (e) {
      appendBubble('[è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•]', 'assistant');
    } finally {
      btn.disabled = false;
      btn.textContent = "å‘é€";
    }
  }

  btn.addEventListener('click', sendMessage);
  input.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
</script>

</body>
</html>
