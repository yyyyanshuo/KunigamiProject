<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ¡å¥ˆ âœ¿ Chat</title>
<!-- è¿™æ˜¯åœ¨ chat.html çš„ <head> æ ‡ç­¾å†… -->
<style>
  body {
    font-family: "Segoe UI", "PingFang SC", "Helvetica Neue", sans-serif;
    background: linear-gradient(135deg, #fff3f8 0%, #ffe9e1 100%);
    margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh;
  }

  /* --- Header å¸ƒå±€ä¿®æ”¹ --- */
  .chat-header {
    position: relative;
    display: flex; align-items: center; justify-content: space-between;
    padding: 10px 16px;
    background-color: rgba(255, 255, 255, 0.85);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid #ffe5e8;
    z-index: 100; flex-shrink: 0;
  }

  /* å·¦è¾¹æŒ‰é’®ç»„ (æ–°å¢) */
  .header-left-group {
    display: flex; gap: 4px; z-index: 2; /* ä¿è¯åœ¨åå­—å›¾å±‚ä¹‹ä¸Š */
  }

  /* å³è¾¹æŒ‰é’®ç»„ (ä¿æŒ) */
  .header-right-group {
    display: flex; gap: 4px; z-index: 2;
  }

  /* ä¸­é—´åå­— (ä¿æŒç»å¯¹å±…ä¸­) */
  .header-title-box {
    position: absolute; left: 50%; transform: translateX(-50%);
    text-align: center; display: flex; flex-direction: column; align-items: center;
    pointer-events: none; z-index: 1;
  }

  /* å·¦å³æŒ‰é’®é€šç”¨æ ·å¼ */
  .header-btn {
    background: none; border: none; cursor: pointer; padding: 8px;
    display: flex; align-items: center; justify-content: center;
    color: #ff9b9e; border-radius: 50%; transition: background 0.2s;
  }
  .header-btn:hover { background-color: rgba(0,0,0,0.05); }
  .header-btn svg { width: 24px; height: 24px; fill: currentColor; }

  /* ä¸­é—´æ–‡å­—åŒºåŸŸ */
  .header-title-box {
    position: absolute; /* å…³é”®ï¼šè„±ç¦»æ–‡æ¡£æµ */
    left: 50%;
    transform: translateX(-50%); /* å®Œç¾çš„æ°´å¹³å±…ä¸­ */
    text-align: center; display: flex; flex-direction: column; align-items: center;
    pointer-events: none; /* é˜²æ­¢é®æŒ¡ä¸‹æ–¹çš„ç‚¹å‡»ï¼ˆè™½ç„¶è¿™é‡Œheaderé«˜å±‚çº§æ²¡äº‹ï¼ŒåŠ ä¸ªä¿é™©ï¼‰ */
  }
  .header-name { font-size: 16px; font-weight: bold; color: #444; }
  .header-status { font-size: 11px; color: #999; display: flex; align-items: center; gap: 4px; margin-top: 2px;}
  .status-dot { width: 8px; height: 8px; background-color: #4cd964; border-radius: 50%; display: inline-block; }

  .chat-container {
    flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; scroll-behavior: smooth;
  }

  /* --- ã€é‡æ„ã€‘å¤´åƒ + æ°”æ³¡ç»„ å¸ƒå±€ --- */
  .message-group {
    display: flex;
    margin: 8px 0; /* æ¯ç»„å¯¹è¯çš„ä¸Šä¸‹é—´è· */
    align-items: flex-start; /* é¡¶å¯¹é½ï¼šå¤´åƒå§‹ç»ˆåœ¨æ¶ˆæ¯ç»„çš„æœ€ä¸Šæ–¹ */
    /*max-width: 90%;*/
    max-width: 100%;    /* <-- æ”¹ä¸º 100% */
  }

  /* ç”¨æˆ·ï¼šå³å¯¹é½ï¼Œåå‘æ’åˆ—(å¤´åƒåœ¨å³) */
  .message-group.user {
    align-self: flex-end;
    flex-direction: row-reverse;
    margin-left: 50px;
  }

  /* åŠ©æ‰‹ï¼šå·¦å¯¹é½ï¼Œæ­£å‘æ’åˆ—(å¤´åƒåœ¨å·¦) */
  .message-group.assistant {
    align-self: flex-start;
    flex-direction: row;
    margin-right: 50px;
  }

  /* --- å¤´åƒæ ·å¼ --- */
  .avatar-img {
    width: 40px; height: 40px;
    border-radius: 10px;
    object-fit: cover;
    flex-shrink: 0; /* é˜²æ­¢å¤´åƒè¢«æŒ¤å‹ */
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    margin-top: 2px;
    margin-bottom: 2px;
  }
  .message-group.user .avatar-img { margin-left: 10px;}
  .message-group.assistant .avatar-img { margin-right: 10px; }

  /* --- æ°”æ³¡å‚ç›´å †å å®¹å™¨ --- */
  .bubble-stack {
    display: flex; flex-direction: column;
    min-width: 0; /* ä¿®å¤Flexå­å…ƒç´ æº¢å‡ºé—®é¢˜ */
  }
  /* ç”¨æˆ·æ°”æ³¡é å³ */
  .message-group.user .bubble-stack { align-items: flex-end; }
  /* åŠ©æ‰‹æ°”æ³¡é å·¦ */
  .message-group.assistant .bubble-stack { align-items: flex-start; }

  /* --- å¾®è°ƒåŸæœ‰æ ·å¼ --- */
  /* è¦†ç›–ä¹‹å‰çš„ wrapper æ ·å¼ï¼Œè®©å®ƒé€‚åº”æ–°å®¹å™¨ */
  /* --- Fix 4: é˜²æ­¢æ°”æ³¡è¢«åº•éƒ¨æŒ‰é’®æ’‘å¤§ï¼Œæ¢å¤è‡ªç„¶å®½åº¦ --- */
  .message-wrapper {
    display: flex; flex-direction: column; margin: 2px 0;
    max-width: 100%; /* è¿™é‡Œçš„ 100% æ˜¯ç›¸å¯¹äº stack çš„ */
  }

  /* 2. æ°”æ³¡ */
  .bubble {
    padding: 10px 14px; /* å†…è¾¹è·ç¨å¾®è°ƒå°ä¸€ç‚¹ç‚¹ */
    border-radius: 16px;
    line-height: 1.5;
    word-wrap: break-word;
    font-size: 14.5px; /* åŸæ¥å¯èƒ½æ˜¯ 16pxï¼Œæ”¹å° */
    box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    animation: fadeIn 0.3s ease;

    /* --- ã€æ–°å¢ã€‘è¿™ä¸¤è¡Œæ˜¯å…³é”® --- */
    width: fit-content;  /* å¼ºåˆ¶æ°”æ³¡å®½åº¦åªé€‚åº”æ–‡å­—å†…å®¹ */
    max-width: 100%;     /* é˜²æ­¢æ–‡å­—å¤ªé•¿æ—¶ä¸æ¢è¡Œ */
  }
  /* --- ã€Fixã€‘å¼ºåˆ¶ç”¨æˆ·æ°”æ³¡å’Œæ§ä»¶é å³å¯¹é½ --- */
  .message-wrapper.user {
    align-items: flex-end !important; /* å…³é”®ï¼šåŠ ä¸Š !important æé«˜ä¼˜å…ˆçº§ */
    text-align: right; /* åŒé‡ä¿é™© */
  }

  /* å¯¹åº”çš„ï¼ŒåŠ©æ‰‹æ°”æ³¡é å·¦å¯¹é½ */
  .message-wrapper.assistant {
    align-items: flex-start !important;
    text-align: left;
  }
  .message-wrapper.user .bubble {
    background: linear-gradient(135deg, #ffb6b9, #ffc9c9); color: #fff;
    border-bottom-right-radius: 4px;
    text-align: left; /* æ°”æ³¡è¿˜æ˜¯åœ¨å³è¾¹ï¼Œä½†é‡Œé¢çš„å­—å·¦å¯¹é½ */
  }
  .message-wrapper.assistant .bubble {
    background: #fff; color: #444; border-bottom-left-radius: 4px; border: 1px solid #ffb6b9;
  }

  /* 3. å¤–éƒ¨æ§åˆ¶å®¹å™¨ (ä¿®æ”¹ç‰ˆï¼šä¸€ç›´æ˜¾ç¤º + æ°´å¹³å¯¹é½) */
  .controls-container {
    display: flex;
    align-items: center; /* ã€å…³é”®ã€‘è®©æ—¶é—´æˆ³å’ŒæŒ‰é’®åœ¨åŒä¸€æ°´å¹³çº¿ä¸Šå‚ç›´å±…ä¸­ */
    gap: 6px;            /* æŒ‰é’®å’Œæ—¶é—´æˆ³ä¹‹é—´çš„é—´è· */
    margin-top: 4px;
    opacity: 1 !important; /* ã€å…³é”®ã€‘å¼ºåˆ¶ä¸€ç›´æ˜¾ç¤ºï¼Œä¸å†é€æ˜ */
    visibility: visible;
  }

  /* 4. å·¦å³å¯¹é½é€»è¾‘ (ä¿®æ”¹ç‰ˆ) */

  /* ç”¨æˆ·çš„æ¶ˆæ¯ï¼šæ§ä»¶é å³å¯¹é½ */
  .message-wrapper.user .controls-container {
    justify-content: flex-end;
    flex-direction: row; /* ä¿æŒ [æ—¶é—´æˆ³] [æŒ‰é’®ç»„] çš„é¡ºåºï¼Œæˆ–è€…æ‚¨å¯ä»¥æ”¹æˆ row-reverse è®©æŒ‰é’®åœ¨æœ€å¤–ä¾§ */
  }

  /* åŠ©æ‰‹çš„æ¶ˆæ¯ï¼šæ§ä»¶é å·¦å¯¹é½ */
  .message-wrapper.assistant .controls-container {
    justify-content: flex-start;
    flex-direction: row;
  }

  /* ã€æ³¨æ„ã€‘è¯·æŠŠä¹‹å‰è¿™è¡Œåˆ æ‰æˆ–æ³¨é‡Šæ‰ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰å†²çª */
  /* .message-group:hover .controls-container { opacity: 1; } */

  /* æ‰€æœ‰çš„æ“ä½œæŒ‰é’®é€šç”¨æ ·å¼ */
  .action-btn {
    background: transparent; border: none; cursor: pointer;
    width: 24px; height: 24px; padding: 4px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    color: #aaa; transition: all 0.2s;
  }
  .action-btn:hover { background-color: rgba(0,0,0,0.05); color: #ff9b9e; }
  .action-btn svg { width: 14px; height: 14px; fill: currentColor; }

  /* ç§»é™¤åŸæ¥ .copy-btn çš„éƒ¨åˆ†æ ·å¼ï¼Œç»Ÿä¸€ç”¨ .action-btn */

  /* 5. æ—¶é—´æˆ³å’Œå¤åˆ¶æŒ‰é’® */
  .timestamp {
    font-size: 11px;
    color: #aaa;
    padding: 0 5px;
  }

  /* --- ã€æ–°å¢ã€‘æ—¥æœŸåˆ†éš”ç¬¦çš„æ ·å¼ --- */
  .date-separator {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    margin: 20px 0;     /* ä¸Šä¸‹ç•™å‡ºè¶³å¤Ÿçš„é—´è· */
    padding: 4px 12px;
    background-color: rgba(0, 0, 0, 0.05); /* ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-radius: 12px; /* åœ†è§’ */
    color: #aaa;         /* æŸ”å’Œçš„æ–‡å­—é¢œè‰² */
    font-size: 12px;
    font-weight: 500;
  }

  /* 6. å…¶ä»– */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  .input-container { display: flex; align-items: center; padding: 12px; border-top: 1px solid #ffdce0; background-color: #fff; }
  textarea#messageInput {
   flex: 1;
   padding: 10px 14px;
   border: 1px solid #ffd1d1;
   border-radius: 20px;
   outline: none;
   font-size: 15px;
   background: #fff8f9;
   transition: border-color 0.2s;
   resize: none;
   box-sizing: border-box;
  }
  #messageInput:focus { border-color: #ff9b9e; }
  #sendBtn { margin-left: 8px; background: linear-gradient(135deg, #ffb6b9, #ff9b73); color: white; border: none; border-radius: 20px; padding: 10px 18px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 6px rgba(255,140,140,0.3); transition: all 0.2s; }
  #sendBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255,140,140,0.4); }

  /* --- ã€æ–°å¢ã€‘å¼ºåˆ¶éšè—â€œåŠ è½½æ›´å¤šâ€æŒ‰é’® --- */
  #load-more-container {
    display: none !important;
  }

  /* --- ã€æ–°å¢ã€‘å¤šé€‰æ¨¡å¼æ ·å¼ --- */

  /* å¤šé€‰æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯å˜æˆå¯ç‚¹å‡»æ‰‹å‹ */
  body.selection-mode .message-group {
    cursor: pointer;
    position: relative;
    transition: all 0.2s;
  }

  /* ç¦ç”¨å¤šé€‰æ¨¡å¼ä¸‹çš„å†…éƒ¨æŒ‰é’®äº¤äº’ï¼Œé˜²æ­¢è¯¯è§¦ */
  body.selection-mode .message-group button { pointer-events: none; }

  /* é€‰ä¸­çŠ¶æ€ */
  .message-group.selected {
    background-color: rgba(255, 182, 185, 0.15); /* æ·¡æ·¡çš„ç²‰è‰²èƒŒæ™¯ */
    border-radius: 12px;
    outline: 2px solid #ffb6b9; /* ç²‰è‰²è¾¹æ¡† */
  }

  /* åœ¨é€‰ä¸­é¡¹å³ä¸Šè§’åŠ ä¸ªå‹¾å‹¾ (å¯é€‰ï¼Œä¸ºäº†å¥½çœ‹) */
  .message-group.selected::after {
    content: 'âœ”';
    position: absolute; top: -8px; right: -8px;
    width: 20px; height: 20px; background: #ffb6b9; color: #fff;
    border-radius: 50%; font-size: 12px;
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }
</style>
</head>
<body>

<!-- ã€æ–°å¢ã€‘é¡¶éƒ¨å¯¼èˆªæ  -->
<header class="chat-header">
  <!-- å·¦è¾¹ç»„ï¼šé€€å‡º + æœç´¢ -->
  <div class="header-left-group">
    <!-- é€€å‡ºæŒ‰é’® -->
    <button class="header-btn" onclick="alert('ç‚¹å‡»äº†é€€å‡º')">
      <svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
    </button>
    <!-- æœç´¢æŒ‰é’® (ç§»åˆ°è¿™é‡Œäº†) -->
    <button class="header-btn" onclick="openSearchModal()">
      <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
    </button>
  </div>

  <!-- ä¸­é—´ï¼šäººå + çŠ¶æ€ -->
  <div class="header-title-box">
    <div class="header-name">ç§ã®ãƒ’ãƒ¼ãƒ­ãƒ¼</div>
    <div class="header-status">
      <span class="status-dot"></span> <!-- ç»¿è‰²å°åœ†ç‚¹ -->
      <span>æ‰‹æœºåœ¨çº¿</span>
    </div>
  </div>

  <!-- å³è¾¹ï¼šã€æ–°å¢ã€‘æŠŠä¸¤ä¸ªæŒ‰é’®åŒ…èµ·æ¥ï¼Œæ–¹ä¾¿å³å¯¹é½ -->
  <div class="header-right-group" style="display:flex; gap:4px;">
    <!-- åŠ åœ¨ header-right-group é‡Œé¢ -->
    <button class="header-btn" onclick="snapshotMemory()" title="æ•´ç†ä»Šæ—¥è®°å¿†">
      <!-- è„‘å­å›¾æ ‡ -->
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/></svg>
    </button>
    <!-- å¤šé€‰æŒ‰é’® -->
    <button class="header-btn" id="toggleSelectBtn" onclick="toggleSelectionMode()">
      <svg viewBox="0 0 24 24"><path d="M3 13h2v-2H3v2zm0 4h2v-2H3v2zm0-8h2V7H3v2zm4 4h14v-2H7v2zm0 4h14v-2H7v2zM7 7v2h14V7H7z"/></svg>
    </button>
    <!-- è¯¦æƒ…æŒ‰é’® -->
    <button class="header-btn" onclick="window.location.href='/memory'">
      <svg viewBox="0 0 24 24"><path d="M12 8c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm0 2c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2zm0 6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z"/></svg>
    </button>
  </div>
</header>

<!-- ã€æ–°å¢ã€‘åŠ è½½æ›´å¤šå†å²è®°å½•çš„æŒ‰é’® -->
<div id="load-more-container" style="text-align: center; padding: 10px; display: none;">
  <button id="loadMoreBtn">åŠ è¼‰æ›´æ—©çš„è¨˜éŒ„</button>
</div>

<div class="chat-container" id="chatContainer">
  <div class="bubble assistant">
    âœ¿ ã“ã‚“ã«ã¡ã¯ï½ æˆ‘æ˜¯æ¡å¥ˆã®å°èŠå¤©åŠ©æ‰‹ ğŸ’Œ
  </div>
</div>

<div class="input-container">
  <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" rows="1"></textarea>
  <button id="sendBtn">å‘é€</button>
</div>

<!-- ã€æ–°å¢ã€‘ç¼–è¾‘å¼¹çª— -->
<div id="editModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:80%; max-width:500px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
    <h3 style="margin:0 0 10px 0; color:#444;">ç¼–è¾‘æ¶ˆæ¯</h3>
    <textarea id="editInput" rows="5" style="width:100%; box-sizing: border-box; border:1px solid #ddd; border-radius:8px; padding:10px; font-size:14px; resize:vertical;"></textarea>
    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px;">
      <button onclick="closeEditModal()" style="padding:6px 12px; border:none; background:#f0f0f0; border-radius:6px; cursor:pointer;">å–æ¶ˆ</button>
      <button id="saveEditBtn" style="padding:6px 12px; border:none; background:#ffb6b9; color:#fff; border-radius:6px; cursor:pointer;">ä¿å­˜</button>
    </div>
  </div>
</div>

<!-- ã€æ–°å¢ã€‘åº•éƒ¨å¤šé€‰æ“ä½œæ  -->
<div id="selectionBar" style="display:none; position:fixed; bottom:0; left:0; width:100%; background:#fff; padding:16px; box-shadow:0 -2px 10px rgba(0,0,0,0.1); z-index:200; align-items:center; justify-content:space-between; box-sizing:border-box;">
  <span id="selectCount" style="color:#666; font-weight:bold;">å·²é€‰æ‹© 0 æ¡</span>
  <div style="display:flex; gap:10px;">
    <button onclick="toggleSelectionMode()" style="padding:8px 16px; border:1px solid #ddd; background:#fff; border-radius:20px; cursor:pointer;">å–æ¶ˆ</button>
    <button onclick="exportSelectedMessages()" style="padding:8px 20px; border:none; background:linear-gradient(135deg, #ffb6b9, #ff9b73); color:white; border-radius:20px; cursor:pointer; font-weight:bold;">ç”Ÿæˆè®°å½•</button>
  </div>
</div>

<!-- ã€æ–°å¢ã€‘å¯¼å‡ºç»“æœå¼¹çª— -->
<div id="exportResultModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
  <div style="background:#fff; padding:20px; border-radius:12px; width:85%; max-width:600px; height: 60vh; display:flex; flex-direction:column; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
    <h3 style="margin:0 0 10px 0; color:#444; flex-shrink:0;">å¯¼å‡ºé¢„è§ˆ</h3>
    <p style="margin:0 0 10px 0; color:#888; font-size:12px; flex-shrink:0;">æ‚¨å¯ä»¥ç›´æ¥å¤åˆ¶ä¸‹æ–¹å†…å®¹ï¼Œæˆ–è€…ç‚¹å‡»æŒ‰é’®ä¸€é”®å¤åˆ¶ã€‚</p>

    <!-- æ–‡æœ¬åŸŸ -->
    <textarea id="exportResultInput" style="flex:1; width:100%; box-sizing:border-box; border:1px solid #ddd; border-radius:8px; padding:12px; font-size:13px; resize:none; line-height:1.6; background:#fafafa;"></textarea>

    <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:15px; flex-shrink:0;">
      <button onclick="document.getElementById('exportResultModal').style.display='none'" style="padding:8px 16px; border:none; background:#f0f0f0; border-radius:6px; cursor:pointer;">å…³é—­</button>
      <button id="copyResultBtn" style="padding:8px 20px; border:none; background:linear-gradient(135deg, #4cd964, #2ac1bc); color:white; border-radius:6px; cursor:pointer; font-weight:bold;">å¤åˆ¶å…¨éƒ¨</button>
    </div>
  </div>
</div>

<!-- ã€æ–°å¢ã€‘æœç´¢å¼¹çª— -->
<div id="searchModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:3000; flex-direction:column;">
  <!-- é¡¶éƒ¨æœç´¢æ  -->
  <div style="padding:15px; display:flex; gap:10px; border-bottom:1px solid #eee; background:#fff;">
    <div style="position:relative; flex:1;">
      <input type="text" id="searchInput" placeholder="æœç´¢èŠå¤©è®°å½•..." style="width:100%; padding:10px 10px 10px 35px; border-radius:20px; border:1px solid #ddd; outline:none; font-size:16px; box-sizing:border-box;">
      <span style="position:absolute; left:12px; top:10px; color:#aaa;">ğŸ”</span>
    </div>
    <button onclick="closeSearchModal()" style="border:none; background:transparent; font-size:16px; color:#666;">å–æ¶ˆ</button>
  </div>
  <!-- ç»“æœåˆ—è¡¨ -->
  <div id="searchResults" style="flex:1; overflow-y:auto; padding:15px;">
    <div style="text-align:center; color:#999; margin-top:50px;">è¾“å…¥å…³é”®è¯å¼€å§‹æœç´¢</div>
  </div>
</div>

<!-- ã€æœ€ç»ˆçš„ã€ç»å¯¹æ­£ç¡®çš„ <script> æ ‡ç­¾ã€‘-->
<script>
    const chatContainer = document.getElementById('chatContainer');
    const input = document.getElementById('messageInput');
    const btn = document.getElementById('sendBtn');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const copyIconPath = '/static/copy-icon.svg';
    const checkIconPath = '/static/check-icon.svg';
    let currentPage = 1;
    let totalMessages = 0;
    let isLoading = false;
    const messagesPerPage = 20;

    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }

    function renderMessageGroup({ id, content, role, timestamp }, mode = 'append') {
      // 1. å¤„ç†ç©ºæ¶ˆæ¯
      const bubbles = content.split('/').map(p => p.trim()).filter(Boolean);
      if (bubbles.length === 0 && mode === 'append') bubbles.push(content);
      if (bubbles.length === 0) return;

      const fullText = content;
      const date = new Date(timestamp);

      // --- 2. åˆ›å»ºæœ€å¤–å±‚çš„ Group å®¹å™¨ ---
      const group = document.createElement('div');
      group.classList.add('message-group', role); // åŠ ä¸Š user æˆ– assistant ç±»
      group.dataset.timestamp = date.toISOString();
      group.dataset.id = id;

      // --- 3. åˆ›å»ºå¤´åƒ ---
      const avatar = document.createElement('img');
      avatar.classList.add('avatar-img');
      // æ ¹æ®è§’è‰²è‡ªåŠ¨é€‰æ‹©å›¾ç‰‡
      avatar.src = role === 'user' ? '/static/avatar_user.jpg' : '/static/avatar_assistant.jpg';

      // --- 4. åˆ›å»ºæ°”æ³¡æ ˆ (Bubble Stack) ---
      const stack = document.createElement('div');
      stack.classList.add('bubble-stack');

      // --- 5. å¾ªç¯ç”Ÿæˆæ°”æ³¡å¹¶æ”¾å…¥æ ˆä¸­ (åŸæœ‰é€»è¾‘å¾®è°ƒ) ---
      bubbles.forEach((text, index) => {
        const isLast = (index === bubbles.length - 1);
        const wrapper = document.createElement('div');
        wrapper.classList.add('message-wrapper', role); // ä¿ç•™åŸæœ‰æ ·å¼ç±»ä»¥ä¾¿å…¼å®¹CSS

        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        bubble.innerHTML = text.replace(/\n/g, "<br>");

        wrapper.appendChild(bubble);

        // å¦‚æœæ˜¯æœ€åä¸€ä¸ªæ°”æ³¡ï¼Œæ·»åŠ æ—¶é—´æˆ³å’Œå¤åˆ¶æŒ‰é’®
        if (isLast) {
          wrapper.dataset.fulltext = fullText;
          const controls = document.createElement('div');
          controls.classList.add('controls-container');

          const timestampEl = document.createElement('div');
          timestampEl.classList.add('timestamp');
          timestampEl.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

          // 2. ç¼–è¾‘æŒ‰é’® (SVG å›¾æ ‡: ç¬”)
          const editBtn = document.createElement('button');
          editBtn.className = 'action-btn';
          editBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>';
          editBtn.onclick = () => openEditModal(id, fullText, group);

          // 3. åˆ é™¤æŒ‰é’® (SVG å›¾æ ‡: åƒåœ¾æ¡¶)
          const delBtn = document.createElement('button');
          delBtn.className = 'action-btn';
          delBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>';
          delBtn.onclick = () => deleteMessage(id, group);

          // 4. å¤åˆ¶æŒ‰é’® (ä¿æŒåŸé€»è¾‘ï¼ŒåŠ ä¸Š class)
          const copyBtn = document.createElement('button');
          copyBtn.className = 'action-btn';
          copyBtn.innerHTML = `<img src="${copyIconPath}" style="width:14px;height:14px;opacity:0.6;">`;
          copyBtn.onclick = () => {
            if (navigator.clipboard) {
              navigator.clipboard.writeText(fullText).then(() => {
                icon.src = checkIconPath; copyBtn.classList.add('copied');
                setTimeout(() => { icon.src = copyIconPath; copyBtn.classList.remove('copied'); }, 1500);
              });
            }
          }

          controls.appendChild(timestampEl);
          if(id) { // åªæœ‰æœ‰ ID çš„æ¶ˆæ¯æ‰èƒ½ç¼–è¾‘/åˆ é™¤
            controls.appendChild(editBtn);
            controls.appendChild(delBtn);
          }
          controls.appendChild(copyBtn);
          wrapper.appendChild(controls);
        }
        stack.appendChild(wrapper);
      });

      // --- 6. ç»„è£…å¹¶æ’å…¥ ---
      group.appendChild(avatar); // æ’å…¥å¤´åƒ
      group.appendChild(stack);  // æ’å…¥æ°”æ³¡æ ˆ

      if (mode === 'prepend') {
        chatContainer.prepend(group);
      } else {
        chatContainer.appendChild(group);
      }
    }

    // --- ã€æ–°å¢ã€‘å…¨å±€æ—¥æœŸé‡æ’å‡½æ•° (å½»åº•è§£å†³æ—¥æœŸé‡å¤/Invalidé—®é¢˜) ---
    function refreshDateSeparators() {
      // 1. å…ˆæŠŠæ—§çš„åˆ†éš”ç¬¦ç»Ÿç»Ÿåˆ æ‰ï¼Œé˜²æ­¢é‡å¤
      document.querySelectorAll('.date-separator').forEach(el => el.remove());

      // 2. è·å–é¡µé¢ä¸Šæ‰€æœ‰çš„æ¶ˆæ¯ç»„ (æŒ‰è‡ªç„¶é¡ºåº)
      const groups = document.querySelectorAll('.message-group');
      let lastDateKey = null;

      groups.forEach(group => {
        const ts = group.dataset.timestamp;
        if (!ts) return;

        // è§£ææ—¥æœŸ
        const date = new Date(ts);
        // ç”Ÿæˆä¸€ä¸ªç”¨æ¥å¯¹æ¯”çš„ Keyï¼Œä¾‹å¦‚ "2025-11-28"
        const dateKey = `${date.getFullYear()}-${date.getMonth()}-${date.getDate()}`;

        // 3. å¦‚æœè¿™ä¸€æ¡çš„æ—¥æœŸ å’Œ ä¸Šä¸€æ¡ä¸ä¸€æ ·ï¼Œå°±åŠ ä¸ªåˆ†éš”ç¬¦
        if (dateKey !== lastDateKey) {
          const sep = document.createElement('div');
          sep.classList.add('date-separator');
          // è®¾ç½®æ˜¾ç¤ºçš„æ ¼å¼
          sep.textContent = date.toLocaleDateString([], {year:'numeric', month:'long', day:'numeric', weekday:'long'});

          // ã€å…³é”®ã€‘æ’å…¥åˆ°å½“å‰æ¶ˆæ¯ç»„çš„å‰é¢
          group.parentNode.insertBefore(sep, group);

          lastDateKey = dateKey; // æ›´æ–°è®°å½•
        }
      });
    }

    async function loadHistory(page = 1) {
      if (isLoading) return;
      isLoading = true;
      loadMoreBtn.textContent = 'åŠ è¼‰ä¸­...';
      try {
        const res = await fetch(`/api/history?page=${page}&limit=${messagesPerPage}`);
        const data = await res.json();
        if (data.messages && data.messages.length > 0) {
          const oldScrollHeight = chatContainer.scrollHeight;

          // --- 1. çº¯ç²¹åœ°æ¸²æŸ“æ¶ˆæ¯ (ä¸åœ¨è¿™é‡Œå¤„ç†æ—¥æœŸ) ---
          for (const msg of data.messages.reverse()) {
            // ç¡®ä¿è°ƒç”¨ renderMessageGroup æ—¶ä¸å¸¦æ—¥æœŸé€»è¾‘ï¼Œåªè´Ÿè´£ç”Ÿæˆ DOM
            renderMessageGroup(msg, 'prepend');
          }

          // --- 2. ã€æ ¸å¿ƒã€‘æ‰€æœ‰æ¶ˆæ¯æ’è¿›å»åï¼Œç»Ÿä¸€æ´—ç‰Œæ•´ç†æ—¥æœŸ ---
          refreshDateSeparators();

          // --- 3. æ¢å¤æ»šåŠ¨ä½ç½® ---
          if (page === 1) { chatContainer.scrollTop = chatContainer.scrollHeight; }
          else {
            // é‡æ–°è®¡ç®—æ»šåŠ¨é«˜åº¦ï¼Œä¿è¯è§†è§‰ä½ç½®ä¸å˜
            chatContainer.scrollTop = chatContainer.scrollHeight - oldScrollHeight;
          }

          totalMessages = data.total;
          currentPage = page;
          if ((currentPage * messagesPerPage) < totalMessages) { loadMoreContainer.style.display = 'block'; }
          else { loadMoreContainer.style.display = 'none'; }
        } else {
          if (page === 1) {
            // å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œæ˜¾ç¤ºä¸ªæ¬¢è¿è¯­
            renderMessageGroup({ content: 'âœ¿ ã“ã‚“ã«ã¡ã¯ï½ æˆ‘æ˜¯æ¡å¥ˆã®å°èŠå¤©åŠ©æ‰‹ ğŸ’Œ', role: 'assistant', timestamp: new Date() });
          }
          loadMoreContainer.style.display = 'none';
        }
      } catch (e) { console.error("Failed to load history:", e); }
      finally { isLoading = false; loadMoreBtn.textContent = 'åŠ è¼‰æ›´æ—©çš„è¨˜éŒ„'; }
    }

    async function sendMessage() {
        const originalText = input.value.trim();
        if (!originalText) return;
        input.value = ''; input.style.height = 'auto';
        btn.disabled = true; btn.textContent = "å‘é€ä¸­â€¦";

        // æ¸²æŸ“ç”¨æˆ·æ¶ˆæ¯ï¼ˆä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼‰
        const userMsg = { content: originalText, role: 'user', timestamp: new Date() };
        renderMessageGroup(userMsg, 'append');
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const res = await fetch('/api/chat', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({message: originalText}) });
            const data = await res.json();

            if (data.replies && data.replies.length > 0) {
                const fullReplyText = data.replies.join(' / ');
                // æ¸²æŸ“ AI æ¶ˆæ¯ï¼ˆä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼‰
                const aiMsg = { content: fullReplyText, role: 'assistant', timestamp: new Date() };
                await sleep(1000); // æ¨¡æ‹Ÿæ€è€ƒæ—¶é—´
                renderMessageGroup(aiMsg, 'append');
                // åœ¨ sendMessage å‡½æ•°æœ«å°¾
                refreshDateSeparators();
            } else { displayBubbleGroup([data.reply || '[æ— å›å¤]'], data.reply || '[æ— å›å¤]', 'assistant', new Date()); }
        } catch (e) { displayBubbleGroup(['[è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•]'], '[è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•]', 'assistant', new Date()); }
        finally { btn.disabled = false; btn.textContent = "å‘é€"; chatContainer.scrollTop = chatContainer.scrollHeight; }
    }

    // 2. ä¿®æ”¹é¡µé¢åŠ è½½é€»è¾‘ï¼šåŠ è½½å®Œæˆåè·³è½¬åˆ°è¯¥ ID
    window.addEventListener('DOMContentLoaded', async () => {
      chatContainer.innerHTML = '';
      await loadHistory(1); // ç­‰å¾…åŠ è½½å®Œæˆ

      // ã€Fix 3ã€‘æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦è·³è½¬çš„æ¶ˆæ¯
      const jumpId = sessionStorage.getItem('jump_to_msg_id');
      if (jumpId) {
        // === æ¨¡å¼ A: å®šä½åŠ è½½ (ç±»ä¼¼äºæœç´¢è·³è½¬) ===
        // æ—¢ç„¶æˆ‘ä»¬è¦è·³åˆ°æŸæ¡æ¶ˆæ¯ï¼Œå°±å¿…é¡»ä¿è¯å®ƒè¢«åŠ è½½å‡ºæ¥
        // 1. å…ˆé—®åç«¯ï¼šè¿™æ¡æ¶ˆæ¯åœ¨ç¬¬å‡ é¡µï¼Ÿ
        try {
          const checkRes = await fetch(`/api/history?limit=${messagesPerPage}&target_id=${jumpId}`);
          const checkData = await checkRes.json();
          const targetPage = checkData.page || 1;

          // 2. ä¸€æ¬¡æ€§åŠ è½½è¶³å¤Ÿæ·±çš„æ•°æ® (Page 1 ~ TargetPage)
          // è¿™æ ·èƒ½ä¿è¯ç›®æ ‡æ¶ˆæ¯åŠå…¶ä¸‹æ–¹çš„æ‰€æœ‰æ–°æ¶ˆæ¯éƒ½åœ¨
          const totalCountToLoad = targetPage * messagesPerPage;
          const loadRes = await fetch(`/api/history?page=1&limit=${totalCountToLoad}`);
          const data = await loadRes.json();

          // 3. æ›´æ–°å…¨å±€çŠ¶æ€
          totalMessages = data.total;
          currentPage = targetPage; // æ¬ºéª—ç³»ç»Ÿæˆ‘ä»¬åœ¨ targetPageï¼Œå®é™…ä¸Šæ˜¯ä¸€æ¬¡æ€§æ‹‰å–çš„

          // 4. æ¸²æŸ“
          for (const msg of data.messages.reverse()) {
            renderMessageGroup(msg, 'prepend');
          }
          refreshDateSeparators();

          // 5. å®šä½å¹¶é«˜äº®
          setTimeout(() => {
            const el = document.querySelector(`.message-group[data-id="${jumpId}"]`);
            if (el) {
              el.scrollIntoView({block: 'center', behavior: 'smooth'});
              // é«˜äº®ç‰¹æ•ˆ
              el.style.transition = 'background 0.5s';
              el.style.backgroundColor = 'rgba(255, 251, 235, 1)';
              setTimeout(() => el.style.backgroundColor = 'transparent', 1500);
            }
            // æ¸…é™¤æ ‡è®°ï¼Œä»¥å…ä¸‹æ¬¡åˆ·æ–°è¿˜è·³
            sessionStorage.removeItem('jump_to_msg_id');
          }, 300);

        } catch (e) {
          console.error("å®šä½åŠ è½½å¤±è´¥ï¼Œå›é€€åˆ°æ™®é€šåŠ è½½", e);
          await loadHistory(1);
        }
      } else {
        // === æ¨¡å¼ B: æ™®é€šåŠ è½½ (åªåŠ è½½æœ€æ–°ä¸€é¡µ) ===
        await loadHistory(1);
      }
    });
    loadMoreBtn.addEventListener('click', () => loadHistory(currentPage + 1));
    chatContainer.addEventListener('scroll', () => { if (chatContainer.scrollTop === 0 && !isLoading && (currentPage * messagesPerPage) < totalMessages) { loadHistory(currentPage + 1); } });
    btn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    input.addEventListener('input', () => { input.style.height = 'auto'; input.style.height = `${input.scrollHeight}px`; });

    // --- æ–°å¢é€»è¾‘å‡½æ•° ---
    let currentEditId = null;
    let currentEditGroup = null;

    function openEditModal(id, content, groupElement) {
      currentEditId = id;
      currentEditGroup = groupElement;
      const input = document.getElementById('editInput');
      input.value = content; // è¿™é‡Œä¼šæ˜¾ç¤ºåŒ…å« '/' çš„åŸå§‹å†…å®¹
      document.getElementById('editModal').style.display = 'flex';
      input.focus();
    }

    function closeEditModal() {
      document.getElementById('editModal').style.display = 'none';
      currentEditId = null;
      currentEditGroup = null;
    }

    document.getElementById('saveEditBtn').onclick = async () => {
      if(!currentEditId) return;
      const newContent = document.getElementById('editInput').value.trim();
      if(!newContent) return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");

      try {
        const res = await fetch(`/api/messages/${currentEditId}`, {
          method: 'PUT',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({content: newContent})
        });
        if(res.ok) {
          sessionStorage.setItem('jump_to_msg_id', currentEditId);
          location.reload();
        }
      } catch(e) { alert("ä¿®æ”¹å¤±è´¥"); }
      closeEditModal();
    };

    async function deleteMessage(id, groupElement) {
      if(!confirm("ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ")) return;
      try {
        const res = await fetch(`/api/messages/${id}`, { method: 'DELETE' });
        if(res.ok) {
          // åˆ é™¤æˆåŠŸï¼Œå¸¦åŠ¨ç”»ç§»é™¤ DOM
          groupElement.style.transition = "all 0.3s";
          groupElement.style.opacity = "0";
          groupElement.style.transform = "translateX(20px)";
          setTimeout(() => groupElement.remove(), 300);
        }
      } catch(e) { alert("åˆ é™¤å¤±è´¥"); }
    }

    // --- ã€æ–°å¢ã€‘å¤šé€‰ç”Ÿæˆ & èŒƒå›´é€‰æ‹©åŠŸèƒ½ ---
    let isSelectionMode = false;
    let lastCheckedIndex = null; // ã€å…³é”®ã€‘è®°å½•ä¸Šä¸€æ¬¡ç‚¹å‡»çš„ä½ç½®
    const selectionBar = document.getElementById('selectionBar');
    const selectCountSpan = document.getElementById('selectCount');
    const exportResultModal = document.getElementById('exportResultModal');
    const exportResultInput = document.getElementById('exportResultInput');

    // 1. åˆ‡æ¢æ¨¡å¼
    function toggleSelectionMode() {
      isSelectionMode = !isSelectionMode;
      document.body.classList.toggle('selection-mode', isSelectionMode);
      selectionBar.style.display = isSelectionMode ? 'flex' : 'none';
      lastCheckedIndex = null; // é‡ç½®

      if (!isSelectionMode) {
        document.querySelectorAll('.message-group.selected').forEach(el => el.classList.remove('selected'));
        updateSelectCount();
        exportResultModal.style.display = 'none';
      }
    }

    // --- ç›‘å¬ç‚¹å‡» & é•¿æŒ‰ (å…¼å®¹ PC Shift å’Œ æ‰‹æœºé•¿æŒ‰) ---

    // å°è£…èŒƒå›´é€‰æ‹©çš„æ ¸å¿ƒé€»è¾‘
    function handleRangeSelect(targetGroup) {
      if (!targetGroup) return;
      const allGroups = Array.from(document.querySelectorAll('.message-group'));
      const currentIndex = allGroups.indexOf(targetGroup);

      if (lastCheckedIndex !== null) {
        const start = Math.min(lastCheckedIndex, currentIndex);
        const end = Math.max(lastCheckedIndex, currentIndex);
        for (let i = start; i <= end; i++) {
          allGroups[i].classList.add('selected');
        }
      }
      lastCheckedIndex = currentIndex;
      updateSelectCount();

      // æ‰‹æœºéœ‡åŠ¨åé¦ˆ (å¦‚æœæœ‰)
      if (navigator.vibrate) navigator.vibrate(50);
    }

    // å°è£…å•é€‰çš„æ ¸å¿ƒé€»è¾‘
    function handleSingleSelect(targetGroup) {
      if (!targetGroup) return;
      targetGroup.classList.toggle('selected');

      const allGroups = Array.from(document.querySelectorAll('.message-group'));
      lastCheckedIndex = allGroups.indexOf(targetGroup);
      updateSelectCount();
    }

    // PCç«¯ Click äº‹ä»¶
    chatContainer.addEventListener('click', (e) => {
      if (!isSelectionMode) return;
      const group = e.target.closest('.message-group');
      if (!group) return;

      e.preventDefault(); e.stopPropagation();

      if (e.shiftKey) {
        handleRangeSelect(group); // Shift + ç‚¹å‡»
      } else {
        handleSingleSelect(group); // æ™®é€šç‚¹å‡»
      }
    });

    // --- æ‰‹æœºç«¯é•¿æŒ‰é€»è¾‘ ---
    let touchTimer = null;
    let touchTarget = null;

    chatContainer.addEventListener('touchstart', (e) => {
      if (!isSelectionMode) return;
      const group = e.target.closest('.message-group');
      if (group) {
        touchTarget = group;
        // 500ms åè§¦å‘é•¿æŒ‰
        touchTimer = setTimeout(() => {
          handleRangeSelect(group); // é•¿æŒ‰ = èŒƒå›´é€‰æ‹©
          touchTarget = null; // è§¦å‘åæ¸…ç©ºï¼Œé˜²æ­¢touchendå†æ¬¡è§¦å‘å•é€‰
        }, 600);
      }
    }, {passive: false});

    chatContainer.addEventListener('touchmove', () => {
      // å¦‚æœæ‰‹æŒ‡æ»‘åŠ¨äº†ï¼Œå–æ¶ˆé•¿æŒ‰
      if (touchTimer) clearTimeout(touchTimer);
      touchTimer = null;
      touchTarget = null;
    });

    chatContainer.addEventListener('touchend', (e) => {
      if (!isSelectionMode) return;
      // å¦‚æœ timer è¿˜åœ¨ï¼Œè¯´æ˜æ²¡åˆ°é•¿æŒ‰æ—¶é—´ï¼Œç®—ä½œæ™®é€šç‚¹å‡»
      if (touchTimer) {
        clearTimeout(touchTimer);
        touchTimer = null;
        // åªæœ‰å½“ touchTarget è¿˜æœ‰å€¼æ—¶æ‰è§¦å‘å•é€‰
        // (å¦‚æœä¸åŠ åˆ¤æ–­ï¼Œå¯èƒ½ä¼šå’Œç³»ç»Ÿç‚¹å‡»å†²çªï¼Œä½†è¿™é‡Œæˆ‘ä»¬ä¸»è¦é è‡ªå·±é€»è¾‘)
        if (touchTarget) {
          e.preventDefault(); // é˜»æ­¢é»˜è®¤çš„ clickï¼Œå®Œå…¨ç”±æˆ‘ä»¬æ¥ç®¡
          handleSingleSelect(touchTarget);
        }
      }
    });

    // ç¦ç”¨é•¿æŒ‰å¼¹å‡ºç³»ç»Ÿèœå• (å¤åˆ¶/ç²˜è´´ç­‰)ï¼Œä»…åœ¨å¤šé€‰æ¨¡å¼ä¸‹
    chatContainer.addEventListener('contextmenu', (e) => {
      if (isSelectionMode && e.target.closest('.message-group')) {
        e.preventDefault();
      }
    });

    function updateSelectCount() {
      const count = document.querySelectorAll('.message-group.selected').length;
      selectCountSpan.textContent = `å·²é€‰æ‹© ${count} æ¡`;
    }

    // 3. å¯¼å‡ºç”Ÿæˆé€»è¾‘ (ä¿®æ”¹ä¸ºå¼¹çª—æ˜¾ç¤º)
    function exportSelectedMessages() {
      const selectedEls = Array.from(document.querySelectorAll('.message-group.selected'));
      if (selectedEls.length === 0) return alert("è¯·å…ˆé€‰æ‹©æ¶ˆæ¯ï¼");

      // æŒ‰ DOM é¡ºåºæ’åº
      selectedEls.sort((a, b) => {
        return (a.compareDocumentPosition(b) & Node.DOCUMENT_POSITION_FOLLOWING) ? -1 : 1;
      });

      const roleMap = { 'user': 'ç¯ åŸæ¡å¥ˆ', 'assistant': 'åœ‹ç¥éŒ¬ä»‹' };
      const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];

      let resultText = "";
      let lastDateStr = "";

      selectedEls.forEach(group => {
        const role = group.classList.contains('user') ? 'user' : 'assistant';
        const name = roleMap[role];
        const timestampStr = group.dataset.timestamp;
        if (!timestampStr) return;
        const dateObj = new Date(timestampStr);

        // æ—¥æœŸå¤´
        const year = dateObj.getFullYear();
        const month = String(dateObj.getMonth() + 1).padStart(2, '0');
        const day = String(dateObj.getDate()).padStart(2, '0');
        const currentDateStr = `${year}-${month}-${day}`;

        if (currentDateStr !== lastDateStr) {
          const weekDay = weekDays[dateObj.getDay()];
          resultText += `\n${currentDateStr}ï¼ˆ${weekDay}ï¼‰\n`;
          lastDateStr = currentDateStr;
        }

        // å†…å®¹
        const bubbles = group.querySelectorAll('.bubble');
        let contentText = "";
        bubbles.forEach((b, idx) => {
          contentText += b.innerText.replace(/\n/g, " ");
          if (idx < bubbles.length - 1) contentText += " / ";
        });

        // æ—¶é—´
        const hours = String(dateObj.getHours()).padStart(2, '0');
        const minutes = String(dateObj.getMinutes()).padStart(2, '0');
        const timeStr = `${hours}:${minutes}`;

        resultText += `${name}ï¼š${contentText}ï¼ˆ${timeStr}ï¼‰\n`;
      });

      // --- ã€ä¿®æ”¹ã€‘æ˜¾ç¤ºå¼¹çª—ï¼Œè€Œä¸æ˜¯ç›´æ¥å¤åˆ¶ ---
      exportResultInput.value = resultText.trim();
      exportResultModal.style.display = 'flex';
    }

    // 4. å¼¹çª—å†…çš„å¤åˆ¶æŒ‰é’®äº‹ä»¶
    document.getElementById('copyResultBtn').addEventListener('click', () => {
      const text = exportResultInput.value;
      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(() => {
          const originalText = document.getElementById('copyResultBtn').textContent;
          document.getElementById('copyResultBtn').textContent = "å¤åˆ¶æˆåŠŸï¼";
          setTimeout(() => {
            document.getElementById('copyResultBtn').textContent = originalText;
          }, 1500);
        });
      } else {
        exportResultInput.select();
        document.execCommand('copy'); // å…¼å®¹æ—§æµè§ˆå™¨
        alert("å·²å°è¯•å¤åˆ¶ï¼Œå¦‚æœå¤±è´¥è¯·æ‰‹åŠ¨å¤åˆ¶æ–‡æœ¬æ¡†å†…å®¹ã€‚");
      }
    });

    async function snapshotMemory() {
      if(!confirm("è¦è®©éŒ¬ä»‹æ•´ç†ä¸€ä¸‹ä»Šå¤©çš„è®°å¿†å—ï¼Ÿ\n(è¿™ä¼šæ¶ˆè€—ä¸€äº› Token å¹¶æ›´æ–°åå°è®°å¿†æ–‡ä»¶)")) return;

      try {
        const res = await fetch('/api/memory/snapshot', { method: 'POST' });
        const data = await res.json();
        if(data.status === 'success') {
          alert(`è®°å¿†æ•´ç†å®Œæˆï¼\næå–äº† ${data.summary.length} ä¸ªå…³é”®äº‹ä»¶ã€‚`);
        } else {
          alert("æ•´ç†å¤±è´¥: " + (data.message || data.error));
        }
      } catch(e) { alert("è¯·æ±‚å‡ºé”™"); }
    }

    // --- æœç´¢ä¸å®šä½åŠŸèƒ½ ---
    const searchModal = document.getElementById('searchModal');
    const searchInput = document.getElementById('searchInput');
    const searchResults = document.getElementById('searchResults');

    function openSearchModal() {
      searchModal.style.display = 'flex';
      searchInput.focus();
    }

    function closeSearchModal() {
      searchModal.style.display = 'none';
      searchInput.value = '';
      searchResults.innerHTML = '';
    }

    // ç›‘å¬è¾“å…¥ (é˜²æŠ–: åœæ­¢è¾“å…¥500msåè‡ªåŠ¨æœç´¢)
    let searchTimer;
    searchInput.addEventListener('input', (e) => {
      clearTimeout(searchTimer);
      const kw = e.target.value.trim();
      if(!kw) { searchResults.innerHTML = ''; return; }

      searchTimer = setTimeout(async () => {
        const res = await fetch('/api/search', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({keyword: kw})
        });
        const list = await res.json();
        renderSearchResults(list, kw);
      }, 500);
    });

    function renderSearchResults(list, kw) {
      if(list.length === 0) {
        searchResults.innerHTML = '<div style="text-align:center; color:#ccc; margin-top:20px;">æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ¶ˆæ¯</div>';
        return;
      }

      let html = '';
      list.forEach(msg => {
        // é«˜äº®å…³é”®è¯
        const highlightContent = msg.content.replace(new RegExp(kw, 'gi'), match => `<span style="color:#e91e63; font-weight:bold;">${match}</span>`);
        const dateStr = new Date(msg.timestamp).toLocaleString();
        const name = msg.role === 'user' ? 'æ¡å¥ˆ' : 'éŒ¬ä»‹';

        html += `
            <div onclick="jumpToMessage(${msg.id})" style="padding:12px; border-bottom:1px solid #f0f0f0; cursor:pointer;">
                <div style="font-size:12px; color:#999; margin-bottom:4px;">${name} Â· ${dateStr}</div>
                <div style="font-size:14px; color:#333; line-height:1.4;">${highlightContent}</div>
            </div>`;
      });
      searchResults.innerHTML = html;
    }

    // --- æ ¸å¿ƒï¼šè·³è½¬å®šä½ ---
    async function jumpToMessage(id) {
      closeSearchModal();

      // 1. å°è¯•åœ¨å½“å‰å·²åŠ è½½çš„ DOM é‡Œæ‰¾
      let targetEl = document.querySelector(`.message-group[data-id="${id}"]`);

      if (targetEl) {
        // å¦‚æœå°±åœ¨å½“å‰å±å¹•ä¸Šï¼Œç›´æ¥æ»šè¿‡å»
        highlightAndScroll(targetEl);
      } else {
        // 2. å¦‚æœä¸åœ¨ï¼Œè¯´æ˜å¤ªä¹…è¿œäº†ï¼Œéœ€è¦é‡æ–°åŠ è½½å†å²è®°å½•
        // æˆ‘ä»¬åˆ©ç”¨ loadHistory çš„æ–°ç‰¹æ€§ï¼Œä¼  target_id è¿›å»
        chatContainer.innerHTML = ''; // æ¸…ç©ºå½“å‰
        isLoading = true; // é˜²æ­¢æ»šåŠ¨è§¦å‘

        // æ­¥éª¤ A: è¯¢é—®åç«¯è¿™æ¡æ¶ˆæ¯åœ¨ç¬¬å‡ é¡µ (ä½¿ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œlimit=20)
        // è¿™é‡Œæˆ‘ä»¬åªæ˜¯ä¸ºäº†è·å– page å‚æ•°ï¼Œä¸éœ€è¦çœŸæ­£çš„ messages
        const checkRes = await fetch(`/api/history?limit=${messagesPerPage}&target_id=${id}`);
        const checkData = await checkRes.json();

        const targetPage = checkData.page;

        // æ­¥éª¤ B: ã€å…³é”®ã€‘ä¸€æ¬¡æ€§åŠ è½½ä» Page 1 åˆ° TargetPage çš„æ‰€æœ‰æ•°æ®
        // æ¯”å¦‚ç›®æ ‡åœ¨ç¬¬ 5 é¡µï¼Œæˆ‘ä»¬å°±ä¸€æ¬¡æ€§åŠ è½½ 100 æ¡ã€‚
        // è¿™æ ·å°±èƒ½ä¿è¯ç›®æ ‡æ¶ˆæ¯ä¸‹é¢çš„æ–°æ¶ˆæ¯éƒ½åœ¨å±å¹•ä¸Šã€‚
        const totalCountToLoad = targetPage * messagesPerPage;

        // è°ƒç”¨åŠ è½½ (ç›´æ¥è¯·æ±‚ç¬¬ä¸€é¡µï¼Œä½† limit å·¨å¤§)
        const loadRes = await fetch(`/api/history?page=1&limit=${totalCountToLoad}`);
        const data = await loadRes.json();

        // æ›´æ–°å…¨å±€çŠ¶æ€ (å‡è£…æˆ‘ä»¬åªåœ¨ç¬¬1é¡µï¼Œå®é™…ä¸Šæ˜¯ä¸€æ¬¡æ€§åŠ è½½äº†ä¸€å¤§å¨)
        // è¿™æ ·å¤„ç†åï¼Œå¦‚æœå¾€ä¸Šæ»šï¼Œè¿˜èƒ½åŠ è½½ targetPage + 1 é¡µçš„æ•°æ®
        // ä¸‹é¢çš„é€»è¾‘éœ€è¦ç¨å¾® Hack ä¸€ä¸‹ï¼Œè®© infinite scroll è¡”æ¥ä¸Š
        totalMessages = data.total;
        currentPage = targetPage; // è®¾ç½®ä¸ºå½“å‰å®é™…çš„æ·±åº¦

        // æ¸²æŸ“æ‰€æœ‰æ¶ˆæ¯
        for (const msg of data.messages.reverse()) {
          renderMessageGroup(msg, 'prepend');
        }
        refreshDateSeparators();

        isLoading = false;

        // 3. æ¸²æŸ“å®Œæ¯•ï¼Œå®šä½å¹¶é«˜äº®
        setTimeout(() => {
          targetEl = document.querySelector(`.message-group[data-id="${id}"]`);
          if (targetEl) {
            highlightAndScroll(targetEl);
          } else {
            alert("å®šä½å¤±è´¥ï¼Œå¯èƒ½æ¶ˆæ¯å·²è¢«åˆ é™¤");
          }
        }, 300); // ç•™è¶³æ¸²æŸ“æ—¶é—´
      }
    }

    function highlightAndScroll(el) {
      el.scrollIntoView({behavior: 'smooth', block: 'center'});
      // é—ªçƒé«˜äº®ç‰¹æ•ˆ
      el.style.transition = 'background 0.5s';
      el.style.backgroundColor = '#fff59d'; // äº®é»„è‰²
      setTimeout(() => {
        el.style.backgroundColor = 'transparent';
      }, 2000);
    }
</script>

</body>
</html>
