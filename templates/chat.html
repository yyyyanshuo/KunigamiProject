<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>æ¡å¥ˆ âœ¿ Chat</title>
<!-- è¿™æ˜¯åœ¨ chat.html çš„ <head> æ ‡ç­¾å†… -->
<style>
  body {
    font-family: "Segoe UI", "PingFang SC", "Helvetica Neue", sans-serif;
    background: linear-gradient(135deg, #fff3f8 0%, #ffe9e1 100%);
    margin: 0; padding: 0; display: flex; flex-direction: column; height: 100vh;
  }
  .chat-container {
    flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; scroll-behavior: smooth;
  }

  /* 1. å¤–å±‚åŒ…è£… */
  .message-wrapper {
    display: flex; flex-direction: column; margin: 8px 0; max-width: 78%;
  }
  .message-wrapper.user { align-self: flex-end; }
  .message-wrapper.assistant { align-self: flex-start; }

  /* 2. æ°”æ³¡ */
  .bubble {
    padding: 12px 16px; border-radius: 16px; line-height: 1.5; word-wrap: break-word;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08); animation: fadeIn 0.3s ease;
  }
  .message-wrapper.user .bubble {
    background: linear-gradient(135deg, #ffb6b9, #ffc9c9); color: #fff;
    border-bottom-right-radius: 4px;
  }
  .message-wrapper.assistant .bubble {
    background: #fff; color: #444; border-bottom-left-radius: 4px; border: 1px solid #ffb6b9;
  }

  /* 3. å¤–éƒ¨æ§åˆ¶å®¹å™¨ */
  .controls-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 4px;
  }

  /* 4. äº¤å‰å¯¹é½ */
  .message-wrapper.user .controls-container { flex-direction: row; }
  .message-wrapper.assistant .controls-container { flex-direction: row-reverse; }

  /* 5. æ—¶é—´æˆ³å’Œå¤åˆ¶æŒ‰é’® */
  .timestamp {
    font-size: 11px;
    color: #aaa;
    padding: 0 5px;
  }
  .copy-btn {
    background: transparent; border: none; cursor: pointer;
    width: 26px; height: 26px; padding: 5px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
  }
  .copy-btn img {
    width: 14px; height: 14px; opacity: 0.5; transition: opacity 0.2s;
  }
  .copy-btn:hover img { opacity: 0.8; }
  .copy-btn.copied img { opacity: 1; }

  /* --- ã€æ–°å¢ã€‘æ—¥æœŸåˆ†éš”ç¬¦çš„æ ·å¼ --- */
  .date-separator {
    align-self: center; /* å±…ä¸­æ˜¾ç¤º */
    margin: 20px 0;     /* ä¸Šä¸‹ç•™å‡ºè¶³å¤Ÿçš„é—´è· */
    padding: 4px 12px;
    background-color: rgba(0, 0, 0, 0.05); /* ä¸€ä¸ªæ·¡æ·¡çš„èƒŒæ™¯è‰² */
    border-radius: 12px; /* åœ†è§’ */
    color: #aaa;         /* æŸ”å’Œçš„æ–‡å­—é¢œè‰² */
    font-size: 12px;
    font-weight: 500;
  }

  /* 6. å…¶ä»– */
  @keyframes fadeIn { from { opacity: 0; transform: translateY(6px); } to { opacity: 1; transform: translateY(0); } }
  .input-container { display: flex; align-items: center; padding: 12px; border-top: 1px solid #ffdce0; background-color: #fff; }
  textarea#messageInput {
   flex: 1;
   padding: 10px 14px;
   border: 1px solid #ffd1d1;
   border-radius: 20px;
   outline: none;
   font-size: 15px;
   background: #fff8f9;
   transition: border-color 0.2s;
   resize: none;
   box-sizing: border-box;
  }
  #messageInput:focus { border-color: #ff9b9e; }
  #sendBtn { margin-left: 8px; background: linear-gradient(135deg, #ffb6b9, #ff9b73); color: white; border: none; border-radius: 20px; padding: 10px 18px; cursor: pointer; font-weight: bold; box-shadow: 0 3px 6px rgba(255,140,140,0.3); transition: all 0.2s; }
  #sendBtn:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(255,140,140,0.4); }

  /* --- ã€æ–°å¢ã€‘å¼ºåˆ¶éšè—â€œåŠ è½½æ›´å¤šâ€æŒ‰é’® --- */
  #load-more-container {
    display: none !important;
  }
</style>
</head>
<body>

<!-- ã€æ–°å¢ã€‘åŠ è½½æ›´å¤šå†å²è®°å½•çš„æŒ‰é’® -->
<div id="load-more-container" style="text-align: center; padding: 10px; display: none;">
  <button id="loadMoreBtn">åŠ è¼‰æ›´æ—©çš„è¨˜éŒ„</button>
</div>

<div class="chat-container" id="chatContainer">
  <div class="bubble assistant">
    âœ¿ ã“ã‚“ã«ã¡ã¯ï½ æˆ‘æ˜¯æ¡å¥ˆã®å°èŠå¤©åŠ©æ‰‹ ğŸ’Œ
  </div>
</div>

<div class="input-container">
  <textarea id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯â€¦" rows="1"></textarea>
  <button id="sendBtn">å‘é€</button>
</div>

<!-- ã€è¯·ç”¨è¿™ä¸ªå®Œæ•´çš„ã€å¹²å‡€çš„ã€æ­£ç¡®çš„ <script> æ›¿æ¢æ‰æ—§çš„ã€‘ -->
<script>
    // --- 1. è·å–æ‰€æœ‰ DOM å…ƒç´  ---
    const chatContainer = document.getElementById('chatContainer');
    const input = document.getElementById('messageInput');
    const btn = document.getElementById('sendBtn');
    const loadMoreContainer = document.getElementById('load-more-container');
    const loadMoreBtn = document.getElementById('loadMoreBtn');

    // --- 2. å…¨å±€å˜é‡å®šä¹‰ ---
    const copyIconPath = '/static/copy-icon.svg';
    const checkIconPath = '/static/check-icon.svg';
    let currentPage = 1;
    let totalMessages = 0;
    let isLoading = false;
    const messagesPerPage = 20; // ä¸åç«¯çš„ limit ä¿æŒä¸€è‡´

    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // --- 3. ç»Ÿä¸€çš„ã€å”¯ä¸€çš„æ¸²æŸ“å‡½æ•° ---
    function renderMessageGroup({ content, role, timestamp }, mode = 'append') {
        const bubbles = content.split('/').map(p => p.trim()).filter(Boolean);
        if (bubbles.length === 0) return; // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œç›´æ¥è¿”å›

        const fullText = content;
        const date = new Date(timestamp);
        const fragment = document.createDocumentFragment();

        bubbles.forEach((text, index) => {
            const isLast = (index === bubbles.length - 1);
            const wrapper = document.createElement('div');
            wrapper.classList.add('message-wrapper', role);
            wrapper.dataset.timestamp = date.toISOString(); // å­˜å‚¨ISOæ ¼å¼æ—¶é—´æˆ³

            const bubble = document.createElement('div');
            bubble.classList.add('bubble');
            bubble.innerHTML = text.replace(/\n/g, "<br>");
            wrapper.appendChild(bubble);

            if (isLast) {
                wrapper.dataset.fulltext = fullText;
                const controls = document.createElement('div');
                controls.classList.add('controls-container');
                const timestampEl = document.createElement('div');
                timestampEl.classList.add('timestamp');
                timestampEl.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                const copyBtn = document.createElement('button');
                copyBtn.classList.add('copy-btn');
                const icon = document.createElement('img');
                icon.src = copyIconPath;
                copyBtn.appendChild(icon);
                copyBtn.addEventListener('click', () => {
                    if (navigator.clipboard) {
                        navigator.clipboard.writeText(fullText).then(() => {
                            icon.src = checkIconPath; copyBtn.classList.add('copied');
                            setTimeout(() => { icon.src = copyIconPath; copyBtn.classList.remove('copied'); }, 1500);
                        });
                    }
                });
                controls.appendChild(timestampEl);
                controls.appendChild(copyBtn);
                wrapper.appendChild(controls);
            }
            fragment.appendChild(wrapper);
        });

        if (mode === 'prepend') {
            chatContainer.prepend(fragment);
        } else {
            chatContainer.appendChild(fragment);
        }
    }

    // --- 4. æ ¸å¿ƒçš„åˆ†é¡µåŠ è½½å‡½æ•° ---
    async function loadHistory(page = 1) {
        if (isLoading) return;
        isLoading = true;
        loadMoreBtn.textContent = 'åŠ è¼‰ä¸­...';

        try {
            const res = await fetch(`/api/history?page=${page}&limit=${messagesPerPage}`);
            const data = await res.json();

            if (data.messages && data.messages.length > 0) {
                const oldScrollHeight = chatContainer.scrollHeight;

                let topDate = null;
                const topWrapper = chatContainer.querySelector('.message-wrapper');
                if (topWrapper) {
                    topDate = new Date(topWrapper.dataset.timestamp);
                }

                data.messages.reverse().forEach(msg => {
                    const currentDate = new Date(msg.timestamp);
                    if (topDate && (topDate.getDate() !== currentDate.getDate() || topDate.getMonth() !== currentDate.getMonth() || topDate.getFullYear() !== currentDate.getFullYear())) {
                        const separator = document.createElement('div');
                        separator.classList.add('date-separator');
                        separator.textContent = topDate.toLocaleDateString([], { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                        chatContainer.prepend(separator);
                    }
                    renderMessageGroup(msg, 'prepend');
                    topDate = currentDate;
                });

                if (page === 1) { // åªæœ‰åœ¨åŠ è½½ç¬¬ä¸€é¡µæ—¶æ‰æ»šåŠ¨åˆ°åº•éƒ¨
                    chatContainer.scrollTop = chatContainer.scrollHeight;
                } else { // åŠ è½½æ›´å¤šæ—¶ï¼Œä¿æŒä½ç½®
                    chatContainer.scrollTop = chatContainer.scrollHeight - oldScrollHeight;
                }

                totalMessages = data.total;
                currentPage = page;

                if ((currentPage * messagesPerPage) < totalMessages) {
                    loadMoreContainer.style.display = 'block';
                } else {
                    loadMoreContainer.style.display = 'none';
                }
            } else {
                if (page === 1) {
                    renderMessageGroup({ content: 'âœ¿ ã“ã‚“ã«ã¡ã¯ï½ æˆ‘æ˜¯æ¡å¥ˆã®å°èŠå¤©åŠ©æ‰‹ ğŸ’Œ', role: 'assistant', timestamp: new Date() });
                }
                loadMoreContainer.style.display = 'none';
            }
        } catch (e) {
            console.error("Failed to load history:", e);
        } finally {
            isLoading = false;
            loadMoreBtn.textContent = 'åŠ è¼‰æ›´æ—©çš„è¨˜éŒ„';
        }
    }

    // --- 5. å‘é€æ–°æ¶ˆæ¯çš„å‡½æ•° ---
    async function sendMessage() {
        const originalText = input.value.trim();
        if (!originalText) return;

        input.value = '';
        input.style.height = 'auto';
        btn.disabled = true;
        btn.textContent = "å‘é€ä¸­â€¦";

        const userBubbles = originalText.split('/').map(p => p.trim()).filter(Boolean);

        for (const [index, text] of userBubbles.entries()) {
            if (index > 0) await sleep(600);
            renderMessageGroup({
                content: text,
                role: 'user',
                timestamp: new Date()
            });
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({message: originalText})
            });
            const data = await res.json();

            if (data.replies && data.replies.length > 0) {
                for (const replyText of data.replies) {
                    let typingDelay = Math.max(500, Math.min(replyText.length * 200, 3000));
                    await sleep(typingDelay);
                    renderMessageGroup({
                        content: replyText,
                        role: 'assistant',
                        timestamp: new Date()
                    });
                }
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                renderMessageGroup({ content: data.reply || '[æ— å›å¤]', role: 'assistant', timestamp: new Date() });
            }
        } catch (e) {
            renderMessageGroup({ content: '[è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•]', role: 'assistant', timestamp: new Date() });
        } finally {
            btn.disabled = false;
            btn.textContent = "å‘é€";
        }
    }

    // --- 6. äº‹ä»¶ç»‘å®š ---
    window.addEventListener('DOMContentLoaded', () => { chatContainer.innerHTML = ''; loadHistory(1); });
    loadMoreBtn.addEventListener('click', () => loadHistory(currentPage + 1));
    chatContainer.addEventListener('scroll', () => {
        if (chatContainer.scrollTop === 0 && !isLoading && (currentPage * messagesPerPage) < totalMessages) {
            loadHistory(currentPage + 1);
        }
    });
    btn.addEventListener('click', sendMessage);
    input.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
    input.addEventListener('input', () => { input.style.height = 'auto'; input.style.height = `${input.scrollHeight}px`; });

</script>

</body>
</html>
