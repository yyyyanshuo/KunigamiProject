<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- PWA é…ç½® -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#fff3f8">
    <!-- iOS ä¸“ç”¨é…ç½® -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/static/logo.png">

    <title>æ¶ˆæ¯åˆ—è¡¨</title>
    <style>
        body {
            font-family: "Segoe UI", "PingFang SC", sans-serif;
            background: #f7f7f7; margin: 0; padding: 0;
        }
        .header {
            background: #fff; padding: 15px 20px;
            font-weight: bold; font-size: 18px; border-bottom: 1px solid #eee;
            position: sticky; top: 0; z-index: 10;
            display: flex; justify-content: space-between; align-items: center;
        }

        .contact-list { padding-bottom: 20px; }

        .contact-item {
            display: flex; align-items: center;
            background: #fff; padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer; transition: background 0.2s;
            position: relative;
        }
        .contact-item:active { background: #f5f5f5; }

        /* ç½®é¡¶æ ·å¼ */
        .contact-item.pinned { background: #fdfdfd; } /* å¯ä»¥ç¨å¾®ç»™ä¸ªä¸ä¸€æ ·çš„èƒŒæ™¯ */
        .contact-item.pinned::after {
            content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px;
            background-color: #ffb6b9; /* ç½®é¡¶æ ‡è®°è‰² */
        }

        .avatar {
            width: 50px; height: 50px; border-radius: 8px; margin-right: 12px;
            object-fit: cover; flex-shrink: 0;
            border: 1px solid #f0f0f0;
        }

        .info { flex: 1; min-width: 0; /* é˜²æ­¢æ–‡æœ¬æº¢å‡º */ }

        .top-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
        .name { font-size: 16px; font-weight: 500; color: #333; }
        .time { font-size: 11px; color: #bbb; }

        .msg-preview {
            font-size: 13px; color: #888;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        /* --- ä¸‹æ‹‰èœå•ä¿®å¤ç‰ˆ --- */
        #plusMenu {
            display: none;
            position: absolute;
            top: 35px; right: 0;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-radius: 8px;
            min-width: 150px; /* ã€ä¿®æ”¹ã€‘åŠ å®½ */
            z-index: 100;
            overflow: hidden;
            border: 1px solid #eee;
        }

        #plusMenu div {
            padding: 12px 15px;
            border-bottom: 1px solid #f9f9f9;
            cursor: pointer;
            font-size: 14px; /* ã€ä¿®æ”¹ã€‘å­—ä½“é€‚ä¸­ */
            color: #555;
            white-space: nowrap; /* ã€ä¿®æ”¹ã€‘ç¦æ­¢æ¢è¡Œ */
            transition: background 0.1s;
        }

        #plusMenu div:hover { background-color: #fff5f6; color: #ffb6b9; }
        #plusMenu div:last-child { border-bottom: none; }
    </style>
</head>

<!-- åœ¨ </body> ä¹‹å‰åŠ å…¥è¿™ä¸€è¡Œ -->
{% include 'tabbar.html' %}
<body>

<div class="header">
    <span>æ¶ˆæ¯</span>
    <div style="position:relative;">
        <span style="font-size:24px; color:#ffb6b9; cursor:pointer;" onclick="toggleMenu()">+</span>
        <!-- ä¸‹æ‹‰èœå• -->
        <div id="plusMenu" style="display:none; position:absolute; top:30px; right:0; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,0.1); border-radius:8px; width:120px; z-index:100; overflow:hidden;">
            <div onclick="openAddCharModal()" style="padding:10px; border-bottom:1px solid #eee; cursor:pointer;">ğŸ‘¤ æ–°å»ºè”ç³»äºº</div>
            <div onclick="openAddGroupModal()" style="padding:10px; cursor:pointer;">ğŸ‘¥ æ–°å»ºç¾¤èŠ</div>
        </div>
    </div>
</div>

<div class="contact-list" id="list">
    <div style="text-align:center; padding:20px; color:#999;">åŠ è½½ä¸­...</div>
</div>

<!-- ã€æ–°å¢ã€‘æ·»åŠ è§’è‰²å¼¹çª— -->
<div id="addCharModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:80%; max-width:320px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 15px 0; color:#333; text-align:center;">æ–°å»ºè”ç³»äºº</h3>

        <div style="margin-bottom:15px;">
            <label style="display:block; font-size:12px; color:#888; margin-bottom:5px;">è§’è‰² ID (è‹±æ–‡/æ•°å­—, ä¸å¯æ”¹)</label>
            <input type="text" id="new-char-id" placeholder="ä¾‹å¦‚: bachira" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>

        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:12px; color:#888; margin-bottom:5px;">è§’è‰²å§“å</label>
            <input type="text" id="new-char-name" placeholder="ä¾‹å¦‚: èœ‚ä¹å›" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>

        <div style="display:flex; justify-content:space-between; gap:10px;">
            <button onclick="closeAddModal()" style="flex:1; padding:10px; border:none; background:#f5f5f5; color:#666; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
            <button onclick="submitNewChar()" style="flex:1; padding:10px; border:none; background:#ffb6b9; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold;">åˆ›å»º</button>
        </div>
    </div>
</div>

<!-- ã€æ–°å¢ã€‘æ–°å»ºç¾¤èŠå¼¹çª— -->
<div id="addGroupModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:#fff; padding:25px; border-radius:12px; width:85%; max-width:350px; box-shadow:0 4px 20px rgba(0,0,0,0.2);">
        <h3 style="margin:0 0 15px 0; color:#333; text-align:center;">åˆ›å»ºç¾¤èŠ</h3>

        <div style="margin-bottom:15px;">
            <label style="display:block; font-size:12px; color:#888; margin-bottom:5px;">ç¾¤ ID (è‹±æ–‡)</label>
            <input type="text" id="new-group-id" placeholder="ä¾‹å¦‚: team_z" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>

        <div style="margin-bottom:15px;">
            <label style="display:block; font-size:12px; color:#888; margin-bottom:5px;">ç¾¤åç§°</label>
            <input type="text" id="new-group-name" placeholder="ä¾‹å¦‚: æ´&èœ‚ä¹" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; box-sizing:border-box;">
        </div>

        <div style="margin-bottom:20px;">
            <label style="display:block; font-size:12px; color:#888; margin-bottom:5px;">é€‰æ‹©æˆå‘˜ (è‡³å°‘2äºº)</label>
            <div id="char-selection-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; border-radius:8px; padding:5px;">
                <!-- JS åŠ¨æ€å¡«å…… -->
            </div>
        </div>

        <div style="display:flex; justify-content:space-between; gap:10px;">
            <button onclick="document.getElementById('addGroupModal').style.display='none'" style="flex:1; padding:10px; border:none; background:#f5f5f5; color:#666; border-radius:8px; cursor:pointer;">å–æ¶ˆ</button>
            <button onclick="submitNewGroup()" style="flex:1; padding:10px; border:none; background:#ffb6b9; color:#fff; border-radius:8px; cursor:pointer; font-weight:bold;">åˆ›å»º</button>
        </div>
    </div>
</div>

<script>
    // --- å…¨å±€å˜é‡ç¼“å­˜ ---
    let allContactsData = []; // å­˜ä¸€ä¸‹APIè¿”å›çš„æ•°æ®ï¼Œæ–¹ä¾¿å¼¹çª—é‡Œå¤ç”¨

    // --- èœå•é€»è¾‘ ---
    function toggleMenu() {
        const menu = document.getElementById('plusMenu');
        menu.style.display = (menu.style.display === 'block') ? 'none' : 'block';
    }
    // ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­èœå•
    window.addEventListener('click', (e) => {
        if (!e.target.matches('.header span') && !e.target.closest('#plusMenu')) {
            document.getElementById('plusMenu').style.display = 'none';
        }
    });

    // --- åŸæœ‰çš„æ–°å»ºè”ç³»äººé€»è¾‘ (å‡½æ•°åæ”¹ä¸€ä¸‹åŒ¹é…HTML) ---
    function openAddCharModal() {
        document.getElementById('addCharModal').style.display = 'flex';
        toggleMenu(); // å…³èœå•
    }

    // --- ã€æ–°å¢ã€‘æ–°å»ºç¾¤èŠé€»è¾‘ ---
    function openAddGroupModal() {
        const listDiv = document.getElementById('char-selection-list');
        listDiv.innerHTML = '';

        // éå†ç¼“å­˜çš„è”ç³»äººæ•°æ®ï¼Œåªæ˜¾ç¤ºå•äººè§’è‰²(type='char')
        allContactsData.forEach(c => {
            if (c.type === 'char') {
                listDiv.innerHTML += `
                  <label style="display:flex; align-items:center; padding:8px; border-bottom:1px solid #f9f9f9;">
                      <input type="checkbox" value="${c.id}" class="char-checkbox" style="margin-right:10px;">
                      <img src="${c.avatar}" style="width:24px; height:24px; border-radius:4px; margin-right:8px;">
                      <span>${c.remark}</span>
                  </label>
              `;
            }
        });

        document.getElementById('addGroupModal').style.display = 'flex';
        toggleMenu();
    }

    async function submitNewGroup() {
        const id = document.getElementById('new-group-id').value.trim();
        const name = document.getElementById('new-group-name').value.trim();

        // è·å–é€‰ä¸­çš„æˆå‘˜
        const checkboxes = document.querySelectorAll('.char-checkbox:checked');
        const members = Array.from(checkboxes).map(cb => cb.value);

        if (!id || !name) return alert("è¯·å¡«å†™IDå’Œåç§°");
        if (members.length < 2) return alert("è¯·è‡³å°‘é€‰æ‹©2ä¸ªæˆå‘˜");

        try {
            const res = await fetch('/api/groups/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id, name, members })
            });
            const result = await res.json();
            if (res.ok) {
                alert("ç¾¤èŠåˆ›å»ºæˆåŠŸï¼");
                document.getElementById('addGroupModal').style.display = 'none';
                loadContacts(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert("å¤±è´¥: " + result.error);
            }
        } catch(e) { alert("ç½‘ç»œé”™è¯¯"); }
    }

    // --- åˆ—è¡¨æ¸²æŸ“é€»è¾‘ (ä¿®æ”¹) ---
    async function loadContacts() {
        try {
            const res = await fetch('/api/contacts');
            const data = await res.json();
            allContactsData = data; // ã€å…³é”®ã€‘ç¼“å­˜æ•°æ®ä¾›å¼¹çª—ä½¿ç”¨
            renderList(data);
        } catch(e) { document.getElementById('list').innerHTML = '<div style="text-align:center; padding:20px;">åŠ è½½å¤±è´¥</div>'; }
    }

    function renderList(contacts) {
        const listEl = document.getElementById('list');
        if(contacts.length === 0) {
            listEl.innerHTML = '<div style="text-align:center; padding:40px; color:#ccc;">æš‚æ— è”ç³»äºº</div>';
            return;
        }

        let html = '';
        contacts.forEach(c => {
            const pinnedClass = c.pinned ? 'pinned' : '';

            // ã€å…³é”®ã€‘åŒºåˆ†è·³è½¬é“¾æ¥
            // å¦‚æœæ˜¯ç¾¤èŠï¼Œè·³åˆ° /chat/group/group_id (è¿™æ˜¯æˆ‘ä»¬ä¸‹ä¸€æ­¥è¦åšçš„è·¯ç”±)
            // å¦‚æœæ˜¯å•äººï¼Œè·³åˆ° /chat/char_id
            let jumpUrl = '';
            if (c.type === 'group') {
                jumpUrl = `/chat/group/${c.id}`;
            } else {
                jumpUrl = `/chat/${c.id}`;
            }

            html += `
          <div class="contact-item ${pinnedClass}" onclick="window.location.href='${jumpUrl}'">
              <img src="${c.avatar}" class="avatar" onerror="this.src='/static/default_avatar.png'">
              <div class="info">
                  <div class="top-row">
                      <span class="name">${c.remark}</span>
                      <span class="time">${c.last_time}</span>
                  </div>
                  <div class="msg-preview">${c.last_msg || 'æš‚æ— æ¶ˆæ¯'}</div>
              </div>
          </div>`;
        });
        listEl.innerHTML = html;
    }

    // é¡µé¢åŠ è½½æ—¶è¯·æ±‚
    loadContacts();

    // é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶ä¹Ÿåˆ·æ–°(æ¯”å¦‚ä»èŠå¤©é¡µé€€å›æ¥)
    window.onpageshow = function(event) {
        if (event.persisted) loadContacts();
    };

    // --- æ·»åŠ è”ç³»äººé€»è¾‘ ---
    const addModal = document.getElementById('addCharModal');
    const inputId = document.getElementById('new-char-id');
    const inputName = document.getElementById('new-char-name');

    function openAddModal() {
        inputId.value = '';
        inputName.value = '';
        addModal.style.display = 'flex';
        inputId.focus();
    }

    function closeAddModal() {
        addModal.style.display = 'none';
    }

    async function submitNewChar() {
        const id = inputId.value.trim();
        const name = inputName.value.trim();

        if (!id || !name) return alert("è¯·å¡«å†™å®Œæ•´ä¿¡æ¯");

        // ç®€å•çš„å‰ç«¯æ ¡éªŒ
        if (!/^[a-zA-Z0-9_]+$/.test(id)) return alert("ID åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—æˆ–ä¸‹åˆ’çº¿");

        try {
            const res = await fetch('/api/characters/add', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ id: id, name: name })
            });

            const result = await res.json();

            if (res.ok) {
                alert("åˆ›å»ºæˆåŠŸï¼");
                closeAddModal();
                loadContacts(); // åˆ·æ–°åˆ—è¡¨
            } else {
                alert("åˆ›å»ºå¤±è´¥: " + result.error);
            }
        } catch (e) {
            alert("ç½‘ç»œé”™è¯¯");
        }
    }
</script>

</body>
</html>