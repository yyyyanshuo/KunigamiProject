# 更新日志 (Changelog)

本项目的所有重要变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，
版本遵循[语义化版本](https://semver.org/spec/v2.0.0.html)。

## [Unreleased] - 未发布

### Added (新增)
- **输入框高度自适应**: 输入框现在可以根据文字行数自动增高，提供了更好的多行文本输入体验。
- **历史记录分页加载 (无限滚动)**: 实现了聊天记录的“无限滚动”功能。现在应用只在初始时加载最近的20条消息，当用户滚动到顶部时会自动加载更早的记录，极大地提升了应用的性能和加载速度。
- **日期分隔符**: 在聊天历史记录中，当两天之间的对话发生间隔时，会自动显示一个美观的日期分隔符 (如 “2025年11月2日 星期日”)，极大地增强了对话的时间感和叙事性。
- **持久化聊天记录**: 使用 SQLite 数据库 (`chat_history.db`) 替代 `context.json`，实现了永久的聊天记忆功能。
- **多气泡回复**: 支持用户和 AI 的单次消息按 `/` 分割，显示为多个连续的气泡。
- **模拟打字延迟**: 为用户和 AI 的多气泡消息增加了发送延迟，模拟真实对话节奏。
- **复制功能**: 为每个聊天气泡增加了外部复制按钮，方便复制代码或文本。
- **时间感知**: 将完整的时间戳信息动态注入到发送给 AI 的 Prompt 中，使其能够感知对话的真实时间上下文。
- **数据库维护脚本**: 在 `scripts/` 文件夹中添加了多个用于检查、清理和修复数据库的 Python 脚本。
- **项目结构优化**: 创建 `scripts/` 和 `static/` 文件夹，使项目结构更清晰。

### Changed (变更)
- **前端渲染逻辑重构**: 引入了统一的 `renderMessageGroup` 函数来处理所有（历史、用户、AI）消息的渲染，彻底解决了因异步操作导致的渲染顺序混乱问题，使代码更健壮、更易于维护。
- **控件显示逻辑**: 重构了前端逻辑，实现了“分组控件”功能。现在，由单次发送产生的多个连续气泡，只会在最后一个气泡的下方统一显示时间和复制按钮，使界面更整洁、更具设计感。
- **复制功能增强**: 优化了复制按钮的行为，现在点击复制会获取整组气泡的原始、未分割的完整文本，而不仅仅是单个气泡的内容。
- **API 调用升级**: 将 `google-generativeai` 的调用方式从已废弃的 `generate_text` 更新为 `GenerativeModel.generate_content`。
- **API 服务切换**: 增加了对 OpenAI 兼容 API (如 OpenRouter) 的支持，并作为首选方案以解决网络问题。
- **时间戳管理**: 从依赖数据库默认时间戳，改为由 Python 程序 (`app.py`) 精确生成和控制，确保时间准确性。

### Fixed (修复)
- **前端异步渲染混乱**: 修复了因 `forEach` 循环无法正确处理 `async/await` 导致的聊天历史记录加载顺序错乱的问题，改用 `for...of` 循环确保了渲染的有序性。
- **历史记录加载延迟**: 优化了用户体验，移除了历史记录加载时不必要的“打字”延迟，实现了历史消息的瞬间加载。
- **AI 模仿时间戳**: 修复了 AI 会在回复中模仿历史记录，自己生成多余时间戳的问题。通过修改系统提示和增加后端“安检门”解决。
- **数据库写入失败**: 修复了当 AI 调用失败时，对话不会被写入数据库的“静默失败” bug。
- **上下文逻辑错误**: 修复了从数据库获取上下文时 `LIMIT` 数量不正确，以及用户消息被错误地拼接了实时时间戳存入数据库的问题。
- **剪贴板 API 安全限制**: 解决了在非 `localhost` 或 `https` 环境下，复制功能因浏览器安全策略而失效的问题，并增加了优雅降级处理。
- **Python 多版本冲突**: 解决了因安装 Node.js 导致服务器出现双 Python 版本，造成 `pip` 包依赖丢失的问题。
- **pip 网络超时**: 通过配置国内镜像源，解决了在服务器上 `pip install` 超时的问题。
- **数据库时间戳格式错误**: 修复了因 `strftime` 中 `%d` 误用为 `%d` 导致用户消息日期错误写入的 bug。