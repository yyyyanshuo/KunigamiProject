# 更新日志 (Changelog)

本项目的所有重要变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，
版本遵循[语义化版本](https://semver.org/spec/v2.0.0.html)。

## [Unreleased] - 未发布
### Added (新增)
- (等待后续开发新增功能...)

## [2.0.0] - 2025-12-15
### Added (新增)
- **多语言 AI 支持 (Multi-Language AI Core)**:
  - **语言切换**: 在个人主页新增“AI 语言”设置，支持一键切换 **🇯🇵 日本語 (默认)** 或 **🇨🇳 中文**。
  - **中文回复指令**: 当切换至中文模式时，系统会自动在 Prompt 末尾注入强力指令，要求角色在保留性格和口癖的前提下使用中文回复。
  - **双语记忆系统**: 重构了记忆总结逻辑，支持根据当前语言设置，生成对应语言的短期记忆列表和中/长期日记（例如切换中文后，日记将以中文第一人称撰写）。
  - **双语创作辅助**: AI 人设生成功能现已支持双语，选择中文模式时，将直接生成中文格式的角色设定文档。

### Changed (变更)
- **后端逻辑重构**:
  - `call_ai_to_summarize` 和 `generate_persona` 函数全面升级，引入了基于字典的 Prompt 模板系统，根据 `ai_language` 动态加载对应的指令。
  - `build_system_prompt` 增加了语言控制层，实现了跨语言的角色扮演逻辑。
  - `user_profile_settings` 接口升级，支持读写 `ai_language` 字段。

### Security (安全)
- **隐私文件隔离**: 完善了 `.gitignore` 规则，确保 `configs/` 下的用户偏好设置 (`user_settings.json`) 和 API 路由配置 (`api_settings.json`) 不会被上传至代码仓库。

## [1.9.0] - 2025-12-22
### Added (新增)
- **群聊系统 (Group Chat System)**:
  - **基础架构**: 新增 `groups/` 目录结构与 `groups.json` 索引，支持创建和管理多人聊天群组。
  - **创建入口**: 通讯录页面右上角新增下拉菜单，支持通过多选联系人创建新群聊。
  - **核心调度**: 实现了 `group_chat` 接口，支持 1~2N 次随机轮询回复机制，并实现了多角色间的串行上下文注入（A说完B能接话）。
  - **记忆分发**: 群聊产生的对话会自动总结并实时分发同步至参与角色的个人短期记忆 (`memory_short.json`) 中，确保角色记忆连贯。
- **个人中心与全局配置 (User Profile)**:
  - 新增 `/profile` 页面，支持查看和编辑全局通用的“用户人设”与“系统格式要求”。
  - **API 账单**: 个人主页底部新增 Token 消耗统计面板，实时记录每次调用的 Input/Output/Total Token 数（基于 Google 官方返回数据）。
  - **用户头像**: 支持在个人主页点击头像直接上传并更新全局用户头像。
- **移动端体验优化**:
  - **PWA 增强**: 修复了 `manifest.json` 格式，优化了 iOS 和 Android 的全屏显示配置。
  - **键盘适配**: 采用 `interactive-widget=resizes-content` 策略，彻底解决了移动端软键盘遮挡输入框的问题。
  - **触感优化**: 常用语面板改为底部抽屉式布局 (Bottom Sheet)，交互更接近原生 App。

### Changed (变更)
- **Prompt 策略优化**:
  - **时间戳精简**: 优化了历史记录的时间戳拼接逻辑。仅当消息跨天时才显示日期，同一天内的消息仅显示 `[HH:MM]`，大幅节省 Token。
  - **记忆视角修正**: 将群聊记忆总结的 Prompt 调整为“纯净/客观记录”模式，去除第一人称情感修饰，避免角色认知混乱。
- **路由架构升级**:
  - 全面适配 `/api/<char_id>/...` 和 `/api/group/<group_id>/...` 动态路由，前端 `chat.html` 可自动识别当前聊天模式（单聊/群聊）。

### Fixed (修复)
- **凌晨记忆断层**: 修复了 00:00-04:00 期间 AI 无法读取昨日未结转记忆的 Bug，实现了跨日记忆的智能拼接。
- **JSON 读取健壮性**: 修复了 Windows 环境下 JSON 文件可能包含 BOM 字符导致解析失败的问题 (`utf-8-sig`)。
- **重复加载**: 修复了聊天页面初始化时因逻辑冲突导致历史记录加载两次的问题。

## [1.8.0] - 2025-12-14
### Added (新增)
- **AI 辅助创作 (AI-Assisted Creation)**:
  - 在记忆面板的角色人设编辑区新增“✨ AI 自动编写人设”功能。
  - 支持输入角色名和作品 IP，调用 LLM 自动生成符合项目格式的详细人设，并提供预览与覆盖功能。
- **角色档案自定义 (Profile Customization)**:
  - 记忆面板顶部新增“角色档案”模块，支持直接修改角色的备注名。
  - **头像上传**: 支持点击头像区域直接从本地上传图片，自动保存至角色专属目录并更新配置。
- **日程管理增强**:
  - 新增“复制他人日程”功能，可一键将其他角色的日程表覆盖到当前角色，方便管理同一时间线下的多角色。
- **全局配置中心 (Global Config)**:
  - 新增 `/profile` 个人主页，用于管理全局通用的“用户人设”和“系统格式要求”。
  - 将 `global_user_persona.md` 和 `global_format.md` 迁移至 `configs/` 目录，实现所有角色共享同一套基础规则。

### Changed (变更)
- **PWA 体验升级**:
  - 修复了 `manifest.json` 格式错误导致的安装失败问题。
  - 优化了 CSS 视口设置 (`interactive-widget=resizes-content`)，彻底解决了移动端软键盘遮挡输入框的顽疾。
  - 调整了聊天气泡与时间戳的布局，使其在移动端显示更加紧凑美观。
- **数据展示优化**:
  - “近期日程”现在仅显示未来 7 天内的条目，过期的日程自动隐藏（但编辑模式下可见）。
  - 常用语 (`quick_phrases`) 迁移至全局配置，所有角色通用。

### Fixed (修复)
- **后端路由参数**: 修复了 `edit_message`、`delete_message` 等接口在多角色架构下因缺失 `char_id` 参数导致的 500 错误。
- **文件读取**: 修复了 JSON 文件读取时因 BOM 字符导致的解析错误，以及空文件读取导致的编辑框消失问题。
- **UI 显示**: 修复了部分操作按钮（如保存、取消）因 CSS 样式冲突被隐藏的问题。

## [1.7.0] - 2025-12-11
### Added (新增)
- **多角色系统 (Multi-Character System)**:
  - **架构重构**: 实现了完整的多角色支持。文件结构从单根目录重构为 `characters/<char_id>/` 分离模式，每个角色拥有独立的数据库 (`chat.db`) 和 Prompt 配置文件。
  - **通讯录首页**: 新增 `/` 首页为联系人列表，支持显示角色头像、最新消息预览及最后通话时间，并支持置顶排序。
  - **配置中心**: 新增 `configs/characters.json` 用于管理角色元数据（名称、头像、置顶状态等）。
- **动态路由与API**:
  - 重写了后端所有核心 API (`chat`, `history`, `search`, `memory`)，全面支持 `/api/<char_id>/...` 动态路由，根据 URL 自动切换上下文。
- **前端适配**:
  - 聊天页面 (`chat.html`) 和记忆面板 (`memory.html`) 新增自动识别 URL 角色 ID 的功能，并动态加载对应的角色名称和头像。

### Changed (变更)
- **后台任务重构**:
  - `memory_jobs.py` 升级为轮询模式，支持遍历 `characters.json` 中的所有角色，依次执行日结和周结任务，互不干扰。
- **文件读取增强**:
  - 优化了 JSON 文件的读取逻辑，增加了 `utf-8-sig` 编码支持，彻底解决了 Windows 环境下由 BOM 字符导致的读取错误。
  - 记忆面板增加了数据容错机制，当 JSON 格式损坏时会自动降级为纯文本编辑模式，防止数据丢失。
- **通用功能迁移**:
  - 常用语功能 (`quick_phrases`) 迁移至 `configs/` 目录，作为全局通用配置供所有角色共享。

### Fixed (修复)
- **路由参数丢失**: 修复了编辑、删除、快照总结等接口在多角色改造后因缺少 `char_id` 参数导致的 500 错误。
- **路径拼接错误**: 修复了部分 API 中数据库路径拼接不规范导致无法读取 `chat.db` 的问题。

## [1.6.0] - 2025-12-07
### Added (新增)
- **智能记忆回滚 (Smart Memory Rollback)**:
  - 实现了基于编辑进度的自动校准机制。在记忆面板手动删除短期记忆的末尾条目并保存时，系统会自动根据剩余最后一条事件的时间，反向查找数据库中的消息 ID 并重置 `last_id`。
  - **效果**: 删除最新记忆后，无需手动操作，下次点击整理时 AI 会自动重新读取并总结被删除时间段的消息，实现无缝补录。

### Changed (变更)
- **记忆显示逻辑优化**:
  - 修正了记忆面板中短期记忆的日期显示逻辑，严格区分“凌晨时段”与“白昼时段”，确保在 00:00-04:00 期间正确显示昨日未结转的记忆，避免显示无关的历史日期。
  - 优化了编辑模式下的重置逻辑，配合智能回滚机制，提供了更灵活的记忆管理手段。

## [1.5.1] - 2025-12-06
### Changed (变更)
- **凌晨记忆逻辑优化 (Midnight Logic)**:
  - **Prompt 构建**: 修复了 00:00~04:00 期间 AI 无法读取昨日短期记忆的逻辑断层。现在处于该时间段时，系统会自动将“昨日短期记忆”拼接至 Prompt 中。
  - **手动快照**: 手动触发记忆整理时，若处于凌晨时段，系统会优先检查并补录昨日的记忆，再处理今日的记忆，确保逻辑闭环。
- **前端显示智能切换**:
  - 记忆面板 (`/memory`) 的短期记忆列表不再固定显示最近两天。现在会根据当前时间智能判断：凌晨 (0-4点) 显示近两天，白天 (4点后) 仅显示当天。

### Added (新增)
- **深度调试模式**:
  - 后端新增全局 Prompt 日志拦截功能。无论是在对话还是记忆整理阶段，发送给 AI 的完整 Prompt 内容都会被格式化打印到控制台，便于排查上下文问题。

### Fixed (修复)
- 修复了在部分情况下增量更新函数调用失败的问题。

## [1.5.0] - 2025-12-06
### Added (新增)
- **常用语快查 (Quick Phrases)**:
  - **快捷输入**: 输入框右侧新增 `+` 按钮，点击唤起底部常用语面板，点击条目即可快速填入输入框。
  - **自定义管理**: 面板支持“编辑模式”，可直接在前端新增、删除、修改常用语，并实时保存到后端 (`prompts/quick_phrases.json`)。
  - **后端支持**: 新增 `/api/quick_phrases` 接口，支持数据的读写操作。

### Changed (变更)
- **底部交互重构 (Native-like Interaction)**:
  - 常用语面板不再使用悬浮遮挡的方式，而是嵌入 Flex 布局流中。
  - 打开面板时，输入框和聊天记录区域会自动被“顶”上去，模拟原生输入法弹出的视觉体验，确保内容不被遮挡。
  - 优化了面板的动画效果（Height Transition），开关更加丝滑。
- **UI 细节**: 优化了输入框区域的布局，适配新增的快捷按钮。

## [1.4.0] - 2025-12-06
### Added (新增)
- **记忆核心面板 (Memory Core)**:
  - 新增独立页面 `/memory`，可查看短期、中期、长期记忆及所有 Prompt 设定。
  - **可视化编辑 (CMS)**: 支持在前端直接对各类记忆（JSON/Markdown）进行增删改查，修改后实时保存。
  - **移动端适配**: 记忆编辑页面针对手机端进行了深度响应式优化，支持卡片式布局。
- **全局搜索与定位 (Search & Jump)**:
  - Header 左侧新增搜索入口，支持对历史记录进行模糊搜索。
  - **时光机定位**: 点击搜索结果或编辑旧消息后，自动计算目标所在的页码，并一次性加载从该页到最新页的所有数据，实现无缝上下文回溯。
  - **高亮反馈**: 跳转后目标消息会自动闪烁高亮。
- **增量记忆更新 (Incremental Memory)**:
  - 优化了短期记忆的生成逻辑，从“全量覆盖”改为“增量追加”，仅处理上次总结后产生的新对话，大幅节省 Token 并保留更多细节。
- **调试系统**:
  - 后端新增 `log_full_prompt`，在控制台实时打印发送给 AI 的完整 Prompt，便于调试。

### Changed (变更)
- **UI 布局优化**:
  - Header 布局调整：搜索移至左侧与退出键分组，右侧保留多选与记忆入口，标题绝对居中。
  - 气泡排版微调：用户消息气泡保持右侧显示，但气泡内文字强制左对齐，提升长文阅读体验。
- **后台任务增强**:
  - `memory_jobs.py` 集成了自动补录逻辑，若昨日未手动生成记忆，后台会自动从数据库读取并补录。
- **API 净化**:
  - 增强了正则表达式，自动过滤 AI 回复中可能携带的两种格式的时间戳（`[HH:MM]` 和 `[MM-DD HH:MM]`）。

### Fixed (修复)
- **定位失效 Bug**: 修复了编辑很久以前的消息后，刷新页面无法定位回原处的问题（采用了深层加载策略）。
- **依赖引用错误**: 修复了后台脚本中 `update_short_memory_for_date` 未导入导致的运行错误。
- **移动端样式**: 修复了记忆编辑页面在手机上输入框溢出、按钮难以点击的问题。

## [1.3.0] - 2025-12-03
### Added (新增)
- **多级记忆系统 (Hierarchical Memory System)**:
  - 实现了 **短期(Short) -> 中期(Medium) -> 长期(Long)** 的三级记忆架构。
  - 新增 `prompts/` 目录，将原本单一的 Prompt 拆解为 8 个模块化文件（人设、关系、用户、格式、各级记忆、日程）。
- **自动化记忆整理 (Auto-Consolidation)**:
  - 引入 `APScheduler` 后台定时任务。
  - **日结**: 每天凌晨 04:00 自动将昨日的短期记忆总结为日记存入中期记忆。
  - **周结**: 每周一自动将上周日记总结为周报存入长期记忆。
  - **自动补录**: 若昨日未手动生成记忆，后台会自动从数据库读取聊天记录进行补录。
- **全日语 Prompt 支持**:
  - 重构了后端逻辑，系统指令 (System Instructions) 和记忆生成 (Memory Generation) 全部强制为日语，以提升角色沉浸感。
- **手动记忆快照**:
  - 前端 Header 新增“大脑”图标按钮，支持手动触发今日记忆整理。

### Changed (变更)
- **Token 优化**:
  - 聊天历史记录上下文不再包含冗余的日期信息，改为在 System Prompt 中全局声明“当前日期”，每条消息仅携带 `[HH:MM]` 时间戳，大幅节省 Token。
- **API 架构升级**:
  - 移除了笨重的 `google-generativeai` 库，改用轻量级 `requests` 库配合 OpenRouter 或 Cloudflare Worker 转发，提升兼容性与稳定性。
- **依赖精简**: 更新 `requirements.txt`，移除了未使用的包，新增 `APScheduler`。

### Removed (移除)
- 移除了根目录下的旧版 `prompt.md` 和 `prompt example.md`，全面转向 `prompts/` 文件夹管理。

## [1.2.0] - 2025-11-29
### Added (新增)
- **UI 顶部导航栏**: 新增了磨砂玻璃效果的顶部 Header，包含退出按钮、居中的角色状态显示（如“手机在线”）及功能菜单入口。
- **头像显示**: 实现了气泡旁的头像显示功能，用户头像在右，助手头像在左，并采用了圆角方形设计。
- **消息编辑与删除**:
    - 新增了后端 API (`PUT` / `DELETE`) 用于修改和删除特定消息。
    - 前端新增编辑弹窗，支持修改历史消息内容，修改后自动刷新并定位回原处。
- **多选导出功能**:
    - 新增“多选模式”，支持批量选择聊天记录。
    - **范围选择**: 支持 PC 端 `Shift + 点击` 和 移动端 `长按`，可一键选中中间所有消息。
    - **格式化导出**: 支持生成特定格式（包含日期头、时间、多气泡合并）的剧本式文本，并通过弹窗供用户复制。
- **UI 交互优化**:
    - 消息时间戳和操作按钮改为常驻显示，并优化了水平对齐。
    - 移动端适配优化，长按触发震动反馈。

### Changed (变更)
- **气泡布局重构**:
    - 气泡宽度改为 `fit-content`，根据文字长度自适应，不再被操作栏撑大。
    - 用户气泡强制右对齐，助手气泡左对齐。
    - 调整了气泡字体大小 (14.5px) 和内边距，使阅读体验更精致。
- **日期分隔符逻辑**: 重写了日期显示逻辑，从“分页加载时判断”改为“全局重算”，彻底解决了日期重复显示或出现 `Invalid Date` 的问题。
- **定位逻辑**: 优化了页面加载和编辑后的滚动定位逻辑，增加了高亮闪烁提示。

### Fixed (修复)
- 修复了输入框编辑弹窗内容溢出的问题 (`box-sizing`)。
- 修复了短文本气泡在 Flex 布局下对齐异常的问题。
- 修复了刷新页面后无法准确回到刚才编辑位置的 Bug。

## [1.1.0] - 2025-11-20
### Added (新增)
- **输入框高度自适应**: 输入框现在可以根据文字行数自动增高，提供了更好的多行文本输入体验。
- **历史记录分页加载 (无限滚动)**: 实现了聊天记录的“无限滚动”功能。现在应用只在初始时加载最近的20条消息，当用户滚动到顶部时会自动加载更早的记录，极大地提升了应用的性能和加载速度。
- **日期分隔符**: 在聊天历史记录中，当两天之间的对话发生间隔时，会自动显示一个美观的日期分隔符 (如 “2025年11月2日 星期日”)，极大地增强了对话的时间感和叙事性。
- **持久化聊天记录**: 使用 SQLite 数据库 (`chat_history.db`) 替代 `context.json`，实现了永久的聊天记忆功能。
- **多气泡回复**: 支持用户和 AI 的单次消息按 `/` 分割，显示为多个连续的气泡。
- **模拟打字延迟**: 为用户和 AI 的多气泡消息增加了发送延迟，模拟真实对话节奏。
- **复制功能**: 为每个聊天气泡增加了外部复制按钮，方便复制代码或文本。
- **时间感知**: 将完整的时间戳信息动态注入到发送给 AI 的 Prompt 中，使其能够感知对话的真实时间上下文。
- **数据库维护脚本**: 在 `scripts/` 文件夹中添加了多个用于检查、清理和修复数据库的 Python 脚本。
- **项目结构优化**: 创建 `scripts/` 和 `static/` 文件夹，使项目结构更清晰。

### Changed (变更)
- **前端渲染逻辑重构**: 引入了统一的 `renderMessageGroup` 函数来处理所有（历史、用户、AI）消息的渲染，彻底解决了因异步操作导致的渲染顺序混乱问题，使代码更健壮、更易于维护。
- **控件显示逻辑**: 重构了前端逻辑，实现了“分组控件”功能。现在，由单次发送产生的多个连续气泡，只会在最后一个气泡的下方统一显示时间和复制按钮，使界面更整洁、更具设计感。
- **复制功能增强**: 优化了复制按钮的行为，现在点击复制会获取整组气泡的原始、未分割的完整文本，而不仅仅是单个气泡的内容。
- **API 调用升级**: 将 `google-generativeai` 的调用方式从已废弃的 `generate_text` 更新为 `GenerativeModel.generate_content`。
- **API 服务切换**: 增加了对 OpenAI 兼容 API (如 OpenRouter) 的支持，并作为首选方案以解决网络问题。
- **时间戳管理**: 从依赖数据库默认时间戳，改为由 Python 程序 (`app.py`) 精确生成和控制，确保时间准确性。

### Fixed (修复)
- **前端异步渲染混乱**: 修复了因 `forEach` 循环无法正确处理 `async/await` 导致的聊天历史记录加载顺序错乱的问题，改用 `for...of` 循环确保了渲染的有序性。
- **历史记录加载延迟**: 优化了用户体验，移除了历史记录加载时不必要的“打字”延迟，实现了历史消息的瞬间加载。
- **AI 模仿时间戳**: 修复了 AI 会在回复中模仿历史记录，自己生成多余时间戳的问题。通过修改系统提示和增加后端“安检门”解决。
- **数据库写入失败**: 修复了当 AI 调用失败时，对话不会被写入数据库的“静默失败” bug。
- **上下文逻辑错误**: 修复了从数据库获取上下文时 `LIMIT` 数量不正确，以及用户消息被错误地拼接了实时时间戳存入数据库的问题。
- **剪贴板 API 安全限制**: 解决了在非 `localhost` 或 `https` 环境下，复制功能因浏览器安全策略而失效的问题，并增加了优雅降级处理。
- **Python 多版本冲突**: 解决了因安装 Node.js 导致服务器出现双 Python 版本，造成 `pip` 包依赖丢失的问题。
- **pip 网络超时**: 通过配置国内镜像源，解决了在服务器上 `pip install` 超时的问题。
- **数据库时间戳格式错误**: 修复了因 `strftime` 中 `%d` 误用为 `%d` 导致用户消息日期错误写入的 bug。