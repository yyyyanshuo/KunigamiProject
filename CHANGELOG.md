# 更新日志 (Changelog)

本项目的所有重要变更都将记录在此文件中。

格式基于 [Keep a Changelog](https://keepachangelog.com/en/1.0.0/)，
版本遵循[语义化版本](https://semver.org/spec/v2.0.0.html)。

## [Unreleased] - 未发布
### Added (新增)
- (等待后续开发新增功能...)

## [1.4.0] - 2025-12-06
### Added (新增)
- **记忆核心面板 (Memory Core)**:
  - 新增独立页面 `/memory`，可查看短期、中期、长期记忆及所有 Prompt 设定。
  - **可视化编辑 (CMS)**: 支持在前端直接对各类记忆（JSON/Markdown）进行增删改查，修改后实时保存。
  - **移动端适配**: 记忆编辑页面针对手机端进行了深度响应式优化，支持卡片式布局。
- **全局搜索与定位 (Search & Jump)**:
  - Header 左侧新增搜索入口，支持对历史记录进行模糊搜索。
  - **时光机定位**: 点击搜索结果或编辑旧消息后，自动计算目标所在的页码，并一次性加载从该页到最新页的所有数据，实现无缝上下文回溯。
  - **高亮反馈**: 跳转后目标消息会自动闪烁高亮。
- **增量记忆更新 (Incremental Memory)**:
  - 优化了短期记忆的生成逻辑，从“全量覆盖”改为“增量追加”，仅处理上次总结后产生的新对话，大幅节省 Token 并保留更多细节。
- **调试系统**:
  - 后端新增 `log_full_prompt`，在控制台实时打印发送给 AI 的完整 Prompt，便于调试。

### Changed (变更)
- **UI 布局优化**:
  - Header 布局调整：搜索移至左侧与退出键分组，右侧保留多选与记忆入口，标题绝对居中。
  - 气泡排版微调：用户消息气泡保持右侧显示，但气泡内文字强制左对齐，提升长文阅读体验。
- **后台任务增强**:
  - `memory_jobs.py` 集成了自动补录逻辑，若昨日未手动生成记忆，后台会自动从数据库读取并补录。
- **API 净化**:
  - 增强了正则表达式，自动过滤 AI 回复中可能携带的两种格式的时间戳（`[HH:MM]` 和 `[MM-DD HH:MM]`）。

### Fixed (修复)
- **定位失效 Bug**: 修复了编辑很久以前的消息后，刷新页面无法定位回原处的问题（采用了深层加载策略）。
- **依赖引用错误**: 修复了后台脚本中 `update_short_memory_for_date` 未导入导致的运行错误。
- **移动端样式**: 修复了记忆编辑页面在手机上输入框溢出、按钮难以点击的问题。

## [1.3.0] - 2025-12-03
### Added (新增)
- **多级记忆系统 (Hierarchical Memory System)**:
  - 实现了 **短期(Short) -> 中期(Medium) -> 长期(Long)** 的三级记忆架构。
  - 新增 `prompts/` 目录，将原本单一的 Prompt 拆解为 8 个模块化文件（人设、关系、用户、格式、各级记忆、日程）。
- **自动化记忆整理 (Auto-Consolidation)**:
  - 引入 `APScheduler` 后台定时任务。
  - **日结**: 每天凌晨 04:00 自动将昨日的短期记忆总结为日记存入中期记忆。
  - **周结**: 每周一自动将上周日记总结为周报存入长期记忆。
  - **自动补录**: 若昨日未手动生成记忆，后台会自动从数据库读取聊天记录进行补录。
- **全日语 Prompt 支持**:
  - 重构了后端逻辑，系统指令 (System Instructions) 和记忆生成 (Memory Generation) 全部强制为日语，以提升角色沉浸感。
- **手动记忆快照**:
  - 前端 Header 新增“大脑”图标按钮，支持手动触发今日记忆整理。

### Changed (变更)
- **Token 优化**:
  - 聊天历史记录上下文不再包含冗余的日期信息，改为在 System Prompt 中全局声明“当前日期”，每条消息仅携带 `[HH:MM]` 时间戳，大幅节省 Token。
- **API 架构升级**:
  - 移除了笨重的 `google-generativeai` 库，改用轻量级 `requests` 库配合 OpenRouter 或 Cloudflare Worker 转发，提升兼容性与稳定性。
- **依赖精简**: 更新 `requirements.txt`，移除了未使用的包，新增 `APScheduler`。

### Removed (移除)
- 移除了根目录下的旧版 `prompt.md` 和 `prompt example.md`，全面转向 `prompts/` 文件夹管理。

## [1.2.0] - 2025-11-29
### Added (新增)
- **UI 顶部导航栏**: 新增了磨砂玻璃效果的顶部 Header，包含退出按钮、居中的角色状态显示（如“手机在线”）及功能菜单入口。
- **头像显示**: 实现了气泡旁的头像显示功能，用户头像在右，助手头像在左，并采用了圆角方形设计。
- **消息编辑与删除**:
    - 新增了后端 API (`PUT` / `DELETE`) 用于修改和删除特定消息。
    - 前端新增编辑弹窗，支持修改历史消息内容，修改后自动刷新并定位回原处。
- **多选导出功能**:
    - 新增“多选模式”，支持批量选择聊天记录。
    - **范围选择**: 支持 PC 端 `Shift + 点击` 和 移动端 `长按`，可一键选中中间所有消息。
    - **格式化导出**: 支持生成特定格式（包含日期头、时间、多气泡合并）的剧本式文本，并通过弹窗供用户复制。
- **UI 交互优化**:
    - 消息时间戳和操作按钮改为常驻显示，并优化了水平对齐。
    - 移动端适配优化，长按触发震动反馈。

### Changed (变更)
- **气泡布局重构**:
    - 气泡宽度改为 `fit-content`，根据文字长度自适应，不再被操作栏撑大。
    - 用户气泡强制右对齐，助手气泡左对齐。
    - 调整了气泡字体大小 (14.5px) 和内边距，使阅读体验更精致。
- **日期分隔符逻辑**: 重写了日期显示逻辑，从“分页加载时判断”改为“全局重算”，彻底解决了日期重复显示或出现 `Invalid Date` 的问题。
- **定位逻辑**: 优化了页面加载和编辑后的滚动定位逻辑，增加了高亮闪烁提示。

### Fixed (修复)
- 修复了输入框编辑弹窗内容溢出的问题 (`box-sizing`)。
- 修复了短文本气泡在 Flex 布局下对齐异常的问题。
- 修复了刷新页面后无法准确回到刚才编辑位置的 Bug。

## [1.1.0] - 2025-11-20
### Added (新增)
- **输入框高度自适应**: 输入框现在可以根据文字行数自动增高，提供了更好的多行文本输入体验。
- **历史记录分页加载 (无限滚动)**: 实现了聊天记录的“无限滚动”功能。现在应用只在初始时加载最近的20条消息，当用户滚动到顶部时会自动加载更早的记录，极大地提升了应用的性能和加载速度。
- **日期分隔符**: 在聊天历史记录中，当两天之间的对话发生间隔时，会自动显示一个美观的日期分隔符 (如 “2025年11月2日 星期日”)，极大地增强了对话的时间感和叙事性。
- **持久化聊天记录**: 使用 SQLite 数据库 (`chat_history.db`) 替代 `context.json`，实现了永久的聊天记忆功能。
- **多气泡回复**: 支持用户和 AI 的单次消息按 `/` 分割，显示为多个连续的气泡。
- **模拟打字延迟**: 为用户和 AI 的多气泡消息增加了发送延迟，模拟真实对话节奏。
- **复制功能**: 为每个聊天气泡增加了外部复制按钮，方便复制代码或文本。
- **时间感知**: 将完整的时间戳信息动态注入到发送给 AI 的 Prompt 中，使其能够感知对话的真实时间上下文。
- **数据库维护脚本**: 在 `scripts/` 文件夹中添加了多个用于检查、清理和修复数据库的 Python 脚本。
- **项目结构优化**: 创建 `scripts/` 和 `static/` 文件夹，使项目结构更清晰。

### Changed (变更)
- **前端渲染逻辑重构**: 引入了统一的 `renderMessageGroup` 函数来处理所有（历史、用户、AI）消息的渲染，彻底解决了因异步操作导致的渲染顺序混乱问题，使代码更健壮、更易于维护。
- **控件显示逻辑**: 重构了前端逻辑，实现了“分组控件”功能。现在，由单次发送产生的多个连续气泡，只会在最后一个气泡的下方统一显示时间和复制按钮，使界面更整洁、更具设计感。
- **复制功能增强**: 优化了复制按钮的行为，现在点击复制会获取整组气泡的原始、未分割的完整文本，而不仅仅是单个气泡的内容。
- **API 调用升级**: 将 `google-generativeai` 的调用方式从已废弃的 `generate_text` 更新为 `GenerativeModel.generate_content`。
- **API 服务切换**: 增加了对 OpenAI 兼容 API (如 OpenRouter) 的支持，并作为首选方案以解决网络问题。
- **时间戳管理**: 从依赖数据库默认时间戳，改为由 Python 程序 (`app.py`) 精确生成和控制，确保时间准确性。

### Fixed (修复)
- **前端异步渲染混乱**: 修复了因 `forEach` 循环无法正确处理 `async/await` 导致的聊天历史记录加载顺序错乱的问题，改用 `for...of` 循环确保了渲染的有序性。
- **历史记录加载延迟**: 优化了用户体验，移除了历史记录加载时不必要的“打字”延迟，实现了历史消息的瞬间加载。
- **AI 模仿时间戳**: 修复了 AI 会在回复中模仿历史记录，自己生成多余时间戳的问题。通过修改系统提示和增加后端“安检门”解决。
- **数据库写入失败**: 修复了当 AI 调用失败时，对话不会被写入数据库的“静默失败” bug。
- **上下文逻辑错误**: 修复了从数据库获取上下文时 `LIMIT` 数量不正确，以及用户消息被错误地拼接了实时时间戳存入数据库的问题。
- **剪贴板 API 安全限制**: 解决了在非 `localhost` 或 `https` 环境下，复制功能因浏览器安全策略而失效的问题，并增加了优雅降级处理。
- **Python 多版本冲突**: 解决了因安装 Node.js 导致服务器出现双 Python 版本，造成 `pip` 包依赖丢失的问题。
- **pip 网络超时**: 通过配置国内镜像源，解决了在服务器上 `pip install` 超时的问题。
- **数据库时间戳格式错误**: 修复了因 `strftime` 中 `%d` 误用为 `%d` 导致用户消息日期错误写入的 bug。